import{r as R,j as c,L}from"./index-DoTEXgMd.js";import{P as g}from"./phaser-B61OQUcB.js";import{O as m,a as f}from"./sprite-DSVmqByI.js";const Y={obstacle:"X",road:"#",build:"_"};class X{map;constructor(e={height:8,width:12}){const t=this.normalizeConfig(e);this.map=this.generateMap(t.height,t.width,t.roadLength)}getMap(){return{cols:this.map.cols,rows:this.map.rows,tiles:this.map.tiles.map(e=>[...e]),path:this.map.path.map(e=>({...e}))}}normalizeConfig(e){const t=Math.max(3,Math.floor(e.height)),i=Math.max(3,Math.floor(e.width)),s=t*i,r=(t+i)*2,a=Math.floor(e.roadLength??r),n=Math.min(Math.max(2,a),s);return{height:t,width:i,roadLength:n}}generateMap(e,t,i){const s=Array.from({length:e},()=>Array.from({length:t},()=>"build"));this.applyObstacles(s);const r=this.generatePath(e,t,i);return r.forEach(({col:a,row:n})=>{s[n][a]="road"}),{cols:t,rows:e,tiles:s,path:r}}applyObstacles(e){const t=e.length,i=e[0]?.length??0;for(let s=0;s<t;s+=1)for(let r=0;r<i;r+=1){if(s===0||s===t-1||r===0||r===i-1){e[s][r]="obstacle";continue}Math.random()<.12&&(e[s][r]="obstacle")}}generatePath(e,t,i){const s=this.shuffle(this.collectEdgeCells(e,t));for(const r of s){const a=this.buildPath(r,e,t,i);if(a)return a}throw new Error("Failed to generate a valid path with the provided configuration.")}buildPath(e,t,i,s){const r=[e],a=new Set([this.cellKey(e.col,e.row)]);return s===1?this.isEdge(e,t,i)?r:void 0:this.extendPath(r,a,t,i,s)?r:void 0}extendPath(e,t,i,s,r){if(e.length===r){const o=e[e.length-1];return this.isEdge(o,i,s)}const a=e[e.length-1],n=this.shuffle(this.neighbors(a,i,s).filter(o=>!t.has(this.cellKey(o.col,o.row)))),l=r-e.length;for(const o of n){if(this.distanceToEdge(o,i,s)>l-1)continue;const p=l-1,d=this.isEdge(o,i,s);if(p>0&&d||p===0&&!d)continue;const u=this.cellKey(o.col,o.row);if(e.push(o),t.add(u),this.violatesSpacing(o,t,i,s)){t.delete(u),e.pop();continue}if(this.extendPath(e,t,i,s,r))return!0;t.delete(u),e.pop()}return!1}neighbors(e,t,i){const s=[{col:1,row:0},{col:-1,row:0},{col:0,row:1},{col:0,row:-1}],r=[];for(const a of s){const n=e.col+a.col,l=e.row+a.row;n>=0&&n<i&&l>=0&&l<t&&r.push({col:n,row:l})}return r}collectEdgeCells(e,t){const i=[];for(let s=0;s<t;s+=1)i.push({col:s,row:0});for(let s=1;s<e;s+=1)i.push({col:t-1,row:s});for(let s=t-2;s>=0;s-=1)e>1&&i.push({col:s,row:e-1});for(let s=e-2;s>0;s-=1)t>1&&i.push({col:0,row:s});return i}distanceToEdge(e,t,i){const s=Math.min(e.row,t-1-e.row),r=Math.min(e.col,i-1-e.col);return Math.min(s,r)}isEdge(e,t,i){return e.row===0||e.row===t-1||e.col===0||e.col===i-1}violatesSpacing(e,t,i,s){if(this.countRoadNeighbors(e,t,i,s)>4)return!0;const a=[{col:-1,row:-1},{col:0,row:-1},{col:1,row:-1},{col:-1,row:0},{col:1,row:0},{col:-1,row:1},{col:0,row:1},{col:1,row:1}];for(const n of a){const l=e.col+n.col,o=e.row+n.row;if(l<0||l>=s||o<0||o>=i)continue;const h=this.cellKey(l,o);if(t.has(h)&&this.countRoadNeighbors({col:l,row:o},t,i,s)>4)return!0}return!1}countRoadNeighbors(e,t,i,s){let r=0;for(let a=-1;a<=1;a+=1)for(let n=-1;n<=1;n+=1){if(a===0&&n===0)continue;const l=e.col+n,o=e.row+a;if(l<0||l>=s||o<0||o>=i)continue;const h=this.cellKey(l,o);t.has(h)&&(r+=1)}return r}cellKey(e,t){return`${e},${t}`}shuffle(e){for(let t=e.length-1;t>0;t-=1){const i=Math.floor(Math.random()*(t+1)),s=e[t];e[t]=e[i],e[i]=s}return e}}function K(w){const e=w.tiles.map(t=>t.map(i=>Y[i]).join(""));console.log("Generated Tower Defense map:"),e.forEach(t=>console.log(t))}const B=[f.tree1,f.tree2,f.tree3,f.tree4,f.tree5,f.tree6];class ${scene;map;tileSpriteLookup=new Map;pathIndexByCell=new Map;viewportPadding={top:0,right:0,bottom:0,left:0};gridTileSize=0;gridOriginX=0;gridOriginY=0;constructor(e,t){this.scene=e,this.map=t,this.map.path.forEach((i,s)=>{this.pathIndexByCell.set(this.cellKey(i.col,i.row),s)})}setViewportPadding(e){this.viewportPadding={...this.viewportPadding,...e}}render(){const{width:e,height:t}=this.scene.scale;if(this.updateMetrics(e,t),!this.scene.textures.exists(m.key))return;const i=this.gridTileSize*.98;for(let s=0;s<this.map.rows;s+=1)for(let r=0;r<this.map.cols;r+=1){const a=this.map.tiles[s][r],n=this.cellKey(r,s),l=this.gridToWorldCenter(r,s),o=this.appearanceForTile(r,s,a);let h=this.tileSpriteLookup.get(n);h?(h.setPosition(l.x,l.y).setDisplaySize(i,i).setFrame(o.frame).setAngle(o.angle),h.setTint(this.tintForTile(a))):(h=this.scene.add.sprite(l.x,l.y,m.key,o.frame).setOrigin(.5).setDisplaySize(i,i),h.setAngle(o.angle),h.setTint(this.tintForTile(a)),this.tileSpriteLookup.set(n,h))}}getTileSprite(e,t){return this.tileSpriteLookup.get(this.cellKey(e,t))}getTileSize(){return this.gridTileSize}gridToWorldCenter(e,t){const i=this.gridOriginX+e*this.gridTileSize+this.gridTileSize/2,s=this.gridOriginY+t*this.gridTileSize+this.gridTileSize/2;return new g.Math.Vector2(i,s)}applyBuildSpotAppearance(e,t,i,s){if(t){const a=this.gridTileSize*.6;e.setFrame(i??f.tower1).setDisplaySize(a,a).setDepth(7).setTint(s??15857145).setAngle(0);return}const r=this.gridTileSize*.98;e.setFrame(f.empty).setDisplaySize(r,r).setDepth(0).setTint(6333946).setAngle(0)}updateMetrics(e,t){const i=Math.max(0,e-this.viewportPadding.left-this.viewportPadding.right),s=Math.max(0,t-this.viewportPadding.top-this.viewportPadding.bottom),r=i/this.map.cols,a=s/this.map.rows;this.gridTileSize=Math.min(r,a);const n=this.gridTileSize*this.map.cols,l=this.gridTileSize*this.map.rows,o=Math.max(0,i-n),h=Math.max(0,s-l);this.gridOriginX=this.viewportPadding.left+o/2,this.gridOriginY=this.viewportPadding.top+h/2}appearanceForTile(e,t,i){return i==="road"?this.roadAppearance(e,t):i==="obstacle"?{frame:B[g.Math.Between(0,B.length-1)],angle:0}:{frame:f.empty,angle:0}}roadAppearance(e,t){const i=this.cellKey(e,t),s=this.pathIndexByCell.get(i);if(s===void 0)return{frame:f.roadStraight,angle:0};const r=this.map.path,a=r[s],n=s>0?r[s-1]:void 0,l=s<r.length-1?r[s+1]:void 0,o=new Set;n&&o.add(this.oppositeDirection(this.directionBetween(n,a))),l&&o.add(this.directionBetween(a,l));const h=o.has("up"),p=o.has("down"),d=o.has("left"),u=o.has("right");return(h||p)&&(d||u)?{frame:f.roadTurn,angle:this.cornerAngle(h,p,d,u)}:d||u?{frame:f.roadStraight,angle:90}:{frame:f.roadStraight,angle:0}}cornerAngle(e,t,i,s){return t&&s?0:e&&s?-90:e&&i?180:t&&i?90:0}directionBetween(e,t){return t.col>e.col?"right":t.col<e.col?"left":t.row>e.row?"down":"up"}oppositeDirection(e){switch(e){case"up":return"down";case"down":return"up";case"left":return"right";case"right":default:return"left"}}tintForTile(e){return e==="road"?13421738:e==="build"?12636415:6320256}cellKey(e,t){return`${e},${t}`}}const N=15,I=75,T=25,v=170,b=650,M=10,G=30,V=6,U=90,q=6,J=6,Q=2,Z=6,ee=2,te=3e3,se=400,W=15,_=20,ie=(W+_)*2,C=[15857145,16436245,16347926],A=[{key:"regular",label:"Regular",shortcut:"1",spriteFrame:f.tower1,description:"Balanced single-target tower.",levels:[{cost:T,range:v,fireRate:b,damage:M},{cost:T+10,range:v+25,fireRate:Math.max(450,b-80),damage:Math.round(M*1.6)},{cost:T+25,range:v+50,fireRate:Math.max(360,b-160),damage:Math.round(M*2.4)}]},{key:"scatter",label:"Scatter",shortcut:"2",spriteFrame:f.sword1,description:"Short-range burst in 8 directions.",levels:[{cost:T+5,range:Math.round(v*.65),fireRate:b+150,damage:Math.round(M*.6),projectileCount:8},{cost:T+20,range:Math.round(v*.7),fireRate:b+60,damage:Math.round(M*.75),projectileCount:8},{cost:T+35,range:Math.round(v*.78),fireRate:Math.max(500,b-40),damage:Math.round(M*.95),projectileCount:8}]},{key:"bomber",label:"Bomber",shortcut:"3",spriteFrame:f.bomb,description:"Heavy projectile with splash damage.",levels:[{cost:T+10,range:v+30,fireRate:b+300,damage:Math.round(M*1.8),aoeRadius:70},{cost:T+25,range:v+60,fireRate:b+200,damage:Math.round(M*2.4),aoeRadius:90},{cost:T+45,range:v+80,fireRate:b+100,damage:Math.round(M*3),aoeRadius:110}]},{key:"freezer",label:"Freezer",shortcut:"4",spriteFrame:f.aura,levelTints:[3718648,959977,165063],description:"Slows enemies in range.",levels:[{cost:T+5,range:v-10,fireRate:b+120,damage:Math.round(M*.4),slowFactor:.65,slowDurationMs:2e3},{cost:T+18,range:v+10,fireRate:b+40,damage:Math.round(M*.55),slowFactor:.5,slowDurationMs:2600},{cost:T+32,range:v+25,fireRate:Math.max(480,b-40),damage:Math.round(M*.7),slowFactor:.4,slowDurationMs:3200}]}];class z{static BOMB_SPEED_PX_PER_MS=.45;static BOMB_EXPLOSION_DURATION_MS=350;deps;activeBombs=[];constructor(e){this.deps=e}update(e,t){const i=this.deps.getOverlay?.();i?.clear(),this.updateBombProjectiles(t,i);for(const s of e)s.cooldown=Math.max(0,s.cooldown-t),!(s.cooldown>0)&&this.performTowerAttack(s,i)&&(s.cooldown=s.stats.fireRate)}performTowerAttack(e,t){switch(e.definition.key){case"scatter":return this.fireScatterTower(e,t);case"bomber":return this.fireBomberTower(e,t);case"freezer":return this.fireFreezerTower(e,t);case"regular":default:return this.fireRegularTower(e,t)}}fireRegularTower(e,t){const i=this.findTargetForTower(e);return i?(t?.lineStyle(3,16436245,.6).beginPath().moveTo(e.sprite.x,e.sprite.y).lineTo(i.sprite.x,i.sprite.y).strokePath(),this.applyDamage(i,e.stats.damage),!0):!1}fireScatterTower(e,t){const i=e.sprite.x,s=e.sprite.y,r=Math.max(e.sprite.displayWidth,e.sprite.displayHeight,32),a=r*3;if(a<=0)return!1;const n=this.enemiesWithinCircle(i,s,a);if(n.length===0)return!1;const l=[0,Math.PI/4,Math.PI/2,3*Math.PI/4,Math.PI,-3*Math.PI/4,-Math.PI/2,-Math.PI/4],o=new Set;for(const h of l){const p=Math.cos(h),d=Math.sin(h);t?.lineStyle(2,16569165,.55).beginPath().moveTo(i,s).lineTo(i+p*a,s+d*a).strokePath();let u,S=1/0;for(const y of n){const D=y.sprite.x-i,P=y.sprite.y-s,E=D*p+P*d;if(E<=0||E>a)continue;const H=Math.abs(p*P-d*D),x=Math.max(y.sprite.displayWidth||0,y.sprite.displayHeight||0,r*.5,12),k=Math.max(6,x*.3);H>k||E<S&&(S=E,u=y)}u&&!o.has(u)&&o.add(u)}for(const h of o)this.applyDamage(h,e.stats.damage);return!0}fireBomberTower(e,t){const i=e.stats.aoeRadius;if(!i)return!1;const s=this.findTargetForTower(e);return s?(t?.lineStyle(2,16498468,.4).lineBetween(e.sprite.x,e.sprite.y,s.sprite.x,s.sprite.y),this.spawnBombProjectile(e,s,i),!0):!1}fireFreezerTower(e,t){const i=e.stats.slowFactor??1,s=e.stats.slowDurationMs??0,r=this.enemiesWithinCircle(e.sprite.x,e.sprite.y,e.stats.range);if(r.length===0)return!1;if(t?.lineStyle(2,3718648,.65).strokeCircle(e.sprite.x,e.sprite.y,e.stats.range),i<1&&s>0&&this.applySlow(r,i,s),e.stats.damage>0)for(const a of r)this.applyDamage(a,e.stats.damage);return!0}enemiesWithinCircle(e,t,i){const s=i*i;return this.deps.getEnemies().filter(r=>g.Math.Distance.Squared(e,t,r.sprite.x,r.sprite.y)<=s)}findTargetForTower(e){let t,i=-1/0;for(const s of this.deps.getEnemies())g.Math.Distance.Squared(e.sprite.x,e.sprite.y,s.sprite.x,s.sprite.y)>e.stats.range*e.stats.range||s.distance>i&&(t=s,i=s.distance);return t}applyDamage(e,t){t<=0||!this.deps.getEnemies().includes(e)||(e.hp-=t,e.hp<=0&&this.deps.onKill(e))}applySlow(e,t,i){const s=g.Math.Clamp(t,.1,1),r=this.deps.getCurrentTime();for(const a of e)this.deps.getEnemies().includes(a)&&(a.slowFactor=Math.min(a.slowFactor,s),a.slowUntil=Math.max(a.slowUntil,r+i),a.sprite.setTint(6333946))}spawnBombProjectile(e,t,i){const s=e.sprite.x,r=e.sprite.y,a=t.sprite.x,n=t.sprite.y,l=g.Math.Distance.Between(s,r,a,n),o=Math.max(180,l/z.BOMB_SPEED_PX_PER_MS);this.activeBombs.push({startX:s,startY:r,targetX:a,targetY:n,aoeRadius:i,damage:e.stats.damage,travelTime:o,elapsed:0,explosionDuration:z.BOMB_EXPLOSION_DURATION_MS,explosionElapsed:0,state:"flying"})}updateBombProjectiles(e,t){if(this.activeBombs.length===0)return;const i=[];for(const s of this.activeBombs){if(s.state==="flying"){s.elapsed+=e;const r=g.Math.Clamp(s.elapsed/s.travelTime,0,1),a=g.Math.Linear(s.startX,s.targetX,r),n=g.Math.Linear(s.startY,s.targetY,r);t?.fillStyle(16347926,.7).fillCircle(a,n,6),t?.lineStyle(2,7877903,.4).strokeCircle(a,n,8),r>=1&&(s.state="exploding",s.explosionElapsed=0,this.resolveBombExplosion(s))}if(s.state==="exploding"){s.explosionElapsed+=e;const r=g.Math.Clamp(1-s.explosionElapsed/s.explosionDuration,0,1);t?.fillStyle(16347926,.12*r).fillCircle(s.targetX,s.targetY,s.aoeRadius),t?.lineStyle(4,16347926,.7*r).strokeCircle(s.targetX,s.targetY,s.aoeRadius)}(s.state==="flying"||s.explosionElapsed<s.explosionDuration)&&i.push(s)}this.activeBombs=i}resolveBombExplosion(e){const t=this.enemiesWithinCircle(e.targetX,e.targetY,e.aoeRadius);for(const i of t)this.applyDamage(i,e.damage)}}class O extends g.Scene{static exitHandler;mapGenerator=new X({height:W,width:_,roadLength:ie});gameMap;mapRenderer;buildSpots=[];towers=[];towerController;enemies=[];selectedTowerDefinition=A[0];path;pathLength=0;enemyOverlay;towerOverlay;timers=[];wave=0;leaks=0;baseHp=N;coins=I;coinsEarned=0;hudWave;hudHp;hudCoins;hudLeaks;hudTower;hudHint;exitButton;baseMarker;runEnded=!1;mapRotatedForVerticalMode=!1;sidebarContainer;sidebarEntries=new Map;sidebarWidth=0;placementOverlay;dragState;isHudPaused=!1;towerDetailsHud;static registerExitHandler(e){O.exitHandler=e}preload(){this.load.setPath(""),this.textures.exists(m.key)||this.load.spritesheet(m.key,m.url,{frameWidth:m.frameWidth,frameHeight:m.frameHeight,spacing:m.spacing})}resetState(){this.timers.forEach(e=>e.remove()),this.timers=[],this.time.removeAllEvents(),this.towerController=void 0,this.towerDetailsHud?.container.destroy(!0),this.towerDetailsHud=void 0,this.dragState?.sprite.destroy(),this.dragState=void 0,this.placementOverlay?.destroy(),this.placementOverlay=void 0,this.enemyOverlay?.destroy(),this.enemyOverlay=void 0,this.towerOverlay?.destroy(),this.towerOverlay=void 0,this.sidebarEntries.clear(),this.gameMap=this.mapGenerator.getMap(),this.buildSpots=[],this.towers=[],this.enemies=[],this.selectedTowerDefinition=A[0],this.pathLength=0,this.wave=0,this.leaks=0,this.baseHp=N,this.coins=I,this.coinsEarned=0,this.runEnded=!1,this.isHudPaused=!1,this.mapRotatedForVerticalMode=!1}create(){this.resetState(),this.rotateMapForVerticalStartIfNeeded(),K(this.gameMap),this.cameras.main.setBackgroundColor("#0b0f19"),this.ensureEnemyWalkAnimation(),this.enemyOverlay=this.add.graphics().setDepth(5),this.towerOverlay=this.add.graphics().setDepth(4),this.placementOverlay=this.add.graphics().setDepth(16),this.towerController=new z({getEnemies:()=>this.enemies,getOverlay:()=>this.towerOverlay,getCurrentTime:()=>this.time.now,onKill:e=>this.handleKill(e)}),this.sidebarWidth=this.computeSidebarWidth(),this.mapRenderer=new $(this,this.gameMap),this.mapRenderer.setViewportPadding({left:16,right:this.sidebarWidth+24,top:16,bottom:24}),this.mapRenderer.render(),this.createPath(),this.createBaseMarker(),this.createBuildSpots(),this.createHud(),this.createSidebar(),this.configureInput(),this.scale.on("resize",this.handleResize,this),this.time.delayedCall(600,()=>this.startNextWave())}update(e,t){if(this.runEnded||this.isHudPaused)return;const i=t/1e3;this.updateEnemies(i),this.updateTowers(t),this.renderOverlays()}createPath(){const e=this.gameMap.path;if(e.length===0||!this.mapRenderer)return;const t=this.mapRenderer.gridToWorldCenter(e[0].col,e[0].row);this.path=new g.Curves.Path(t.x,t.y);for(let i=1;i<e.length;i+=1){const s=this.mapRenderer.gridToWorldCenter(e[i].col,e[i].row);this.path.lineTo(s.x,s.y)}this.pathLength=this.path.getLength()}createBaseMarker(){this.baseMarker?.destroy();const e=this.gameMap.path;if(e.length===0||!this.mapRenderer)return;const t=e[e.length-1],i=this.mapRenderer.gridToWorldCenter(t.col,t.row),r=this.mapRenderer.getTileSize()*.9;this.baseMarker=this.add.rectangle(i.x,i.y,r,r,1319471).setStrokeStyle(2,3854591,.6).setDepth(2)}createBuildSpots(){if(!this.mapRenderer)return;this.buildSpots=[];let e=0;for(let t=0;t<this.gameMap.rows;t+=1)for(let i=0;i<this.gameMap.cols;i+=1){if(this.gameMap.tiles[t][i]!=="build")continue;const s=this.mapRenderer.getTileSprite(i,t);if(!s)continue;const r={id:e,col:i,row:t,occupied:!1,marker:s};this.buildSpots.push(r),this.applyBuildSpotAppearance(r),e+=1}}createHud(){this.hudWave?.destroy(),this.hudHp?.destroy(),this.hudCoins?.destroy(),this.hudLeaks?.destroy(),this.hudTower?.destroy(),this.hudHint?.destroy(),this.exitButton?.destroy(),this.hudWave=this.add.text(16,16,"",this.hudStyle()),this.hudHp=this.add.text(16,44,"",this.hudStyle()),this.hudCoins=this.add.text(16,72,"",this.hudStyle()),this.hudLeaks=this.add.text(16,100,"",this.hudStyle()),this.hudTower=this.add.text(16,128,"",{...this.hudStyle(),fontSize:"16px",color:"#7dd3fc"}),this.hudHint=this.add.text(16,154,"Drag towers from the sidebar. Tap a placed tower to upgrade.",{...this.hudStyle(),fontSize:"14px",color:"#94a3b8"}),this.exitButton=this.add.text(this.scale.width-20,16,"Exit",{...this.hudStyle(),color:"#f87171"}).setOrigin(1,0).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this.endRun()),this.add.text(this.scale.width/2,this.scale.height-24,"Drag towers from the sidebar • Info buttons pause the game.",{...this.hudStyle(),fontSize:"14px",color:"#9ca3af"}).setOrigin(.5,1),this.refreshHud()}configureInput(){this.input.keyboard?.on("keydown-ESC",()=>this.endRun()),this.input.on("pointerdown",t=>{if(this.runEnded||this.isHudPaused||this.dragState||t.event?.defaultPrevented)return;const i=this.getBuildSpotAt(t.worldX,t.worldY);!i||!i.occupied||this.tryUpgradeTower(i,t.worldX,t.worldY)}),this.input.on("pointermove",t=>{!this.dragState||t.id!==this.dragState.pointerId||this.updateTowerDrag(t)}),this.input.on("pointerup",t=>{!this.dragState||t.id!==this.dragState.pointerId||this.completeTowerDrag(t)}),this.input.on("pointerupoutside",t=>{!this.dragState||t.id!==this.dragState.pointerId||this.cancelTowerDrag()})}createSidebar(){this.sidebarContainer?.destroy(!0),this.sidebarEntries.clear();const e=this.sidebarWidth,t=this.scale.height,i=this.add.container(this.scale.width-e,0).setDepth(12);this.sidebarContainer=i;const s=this.add.rectangle(e/2,t/2,e,t,330257,.92).setOrigin(.5).setInteractive();s.on("pointerdown",o=>{o.event?.stopPropagation(),o.event?.preventDefault()}),i.add(s);const r=this.add.text(e/2,16,"Towers",{...this.hudStyle(),fontSize:"20px",color:"#f8fafc"}).setOrigin(.5,0);i.add(r);const a=e-24,n=76;let l=56;for(const o of A){const h=this.add.container(12,l),p=this.add.rectangle(0,0,a,n,1120295,.9).setOrigin(0).setStrokeStyle(1,2042167,.8).setInteractive({useHandCursor:!0}),d=x=>{x.event?.stopPropagation(),x.event?.preventDefault(),!(x.event&&"button"in x.event&&x.event.button!==0)&&this.startTowerDrag(o,x)};p.on("pointerdown",d);const u=Math.min(48,n-20),S=this.add.sprite(18,n/2,m.key,o.spriteFrame).setOrigin(0,.5).setDisplaySize(u,u).setTint(o.levelTints?.[0]??C[0]).setInteractive({useHandCursor:!0}).on("pointerdown",d),y=this.add.text(S.x+u+10,n/2-16,o.label,{...this.hudStyle(),fontSize:"16px"}).setInteractive({useHandCursor:!0}).on("pointerdown",d),D=this.add.text(S.x+u+10,n/2+6,"Drag to build",{...this.hudStyle(),fontSize:"12px",color:"#94a3b8"}),P=this.add.sprite(a-76,n/2,m.key,f.dollar).setOrigin(0,.5).setDisplaySize(18,18).setTint(16436245).setInteractive({useHandCursor:!0}).on("pointerdown",d),E=this.add.text(P.x+20,n/2,`${o.levels[0].cost}`,{...this.hudStyle(),fontSize:"16px",color:"#facc15"}).setOrigin(0,.5).setInteractive({useHandCursor:!0}).on("pointerdown",d),H=this.add.sprite(a-24,n/2,m.key,f.arrowRightOutline).setOrigin(.5).setDisplaySize(20,20).setTint(8246268).setInteractive({useHandCursor:!0});H.on("pointerdown",x=>{x.event?.stopPropagation(),x.event?.preventDefault(),this.openTowerDetails(o)}),h.add([p,S,y,D,P,E,H]),i.add(h),this.sidebarEntries.set(o.key,{definition:o,container:h,background:p,costText:E,icon:S}),l+=n+16}this.refreshTowerCardsAffordability()}computeSidebarWidth(){const e=this.scale.width;return e<640?Math.max(140,Math.round(e*.38)):e<960?180:240}startTowerDrag(e,t){if(this.runEnded||this.isHudPaused)return;this.dragState&&this.cancelTowerDrag(),this.selectedTowerDefinition=e;const i=Math.max(this.mapRenderer?.getTileSize()??64,32),s=this.add.sprite(t.worldX,t.worldY,m.key,e.spriteFrame).setOrigin(.5).setDisplaySize(i*.6,i*.6).setTint(e.levelTints?.[0]??C[0]).setDepth(25).setAlpha(.9);this.dragState={definition:e,pointerId:t.id,sprite:s},this.updatePlacementOverlay(t.worldX,t.worldY,this.getBuildSpotAt(t.worldX,t.worldY)),this.refreshHud()}updateTowerDrag(e){if(!this.dragState)return;this.dragState.sprite.setPosition(e.worldX,e.worldY);const t=this.getBuildSpotAt(e.worldX,e.worldY);this.updatePlacementOverlay(e.worldX,e.worldY,t)}completeTowerDrag(e){if(!this.dragState)return;const{definition:t}=this.dragState,i=this.getBuildSpotAt(e.worldX,e.worldY);if(!i||i.occupied){this.showFloatingText(e.worldX,e.worldY,"Pick a free build pad"),this.cancelTowerDrag();return}const s=t.levels[0].cost;if(this.coins<s){this.showFloatingText(e.worldX,e.worldY,`Need ${s} coins`),this.cancelTowerDrag();return}this.placeTower(i,t),this.cancelTowerDrag()}cancelTowerDrag(){if(!this.dragState)return;const{sprite:e}=this.dragState;e.destroy(),this.dragState=void 0,this.placementOverlay?.clear()}getBuildSpotAt(e,t){return this.buildSpots.find(i=>i.marker.getBounds().contains(e,t))}updatePlacementOverlay(e,t,i){if(!this.placementOverlay||!this.dragState)return;this.placementOverlay.clear();const s=this.dragState.definition.levels[0],r=this.coins>=s.cost;if(i&&this.mapRenderer){const a=this.mapRenderer.gridToWorldCenter(i.col,i.row),n=this.mapRenderer.getTileSize(),o=!i.occupied&&r?2278750:16281969;this.placementOverlay.fillStyle(o,.28),this.placementOverlay.fillRoundedRect(a.x-n/2,a.y-n/2,n,n,8)}if(s.range>0){const a=r?3718648:16281969;this.placementOverlay.lineStyle(2,a,.85).strokeCircle(e,t,s.range)}}openTowerDetails(e,t=!1){if(this.towerDetailsHud)return;this.cancelTowerDrag(),t||this.setHudPause(!0);const i=this.scale.width,s=this.scale.height,r=Math.min(420,i-80),a=Math.min(380,s-80),n=i/2,l=s/2,o=this.add.container(0,0).setDepth(30),h=this.add.rectangle(n,l,i,s,132631,.65).setInteractive().on("pointerdown",k=>{k.event?.stopPropagation(),k.event?.preventDefault()}),p=this.add.rectangle(n,l,r,a,988970,.96).setStrokeStyle(2,3718648,.45),d=this.add.text(n-r/2+24,l-a/2+24,`${e.label} Tower`,{...this.hudStyle(),fontSize:"20px"}),u=Math.min(80,a/4),S=this.add.sprite(n-r/2+60,l-a/2+90,m.key,e.spriteFrame).setDisplaySize(u,u).setTint(e.levelTints?.[0]??C[0]),y=e.levels[0],D=this.add.text(n-r/2+120,l-a/2+64,"",{...this.hudStyle(),fontSize:"16px"}),P=(y.fireRate/1e3).toFixed(1),E=this.getRangeInTiles(y.range);D.setText(`Damage: ${y.damage}
Cooldown: ${P}s
Radius: ${E} tiles`);const H=this.add.text(n-r/2+24,l-a/2+160,e.description,{...this.hudStyle(),fontSize:"14px",wordWrap:{width:r-48}}),x=this.add.text(n,l+a/2-32,"Close HUD",{...this.hudStyle(),fontSize:"16px",color:"#fbbf24"}).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerdown",k=>{k.event?.stopPropagation(),k.event?.preventDefault(),this.closeTowerDetails()});o.add([h,p,d,S,D,H,x]),this.towerDetailsHud={definition:e,container:o}}closeTowerDetails(e=!0){this.towerDetailsHud&&(this.towerDetailsHud.container.destroy(!0),this.towerDetailsHud=void 0,e&&this.setHudPause(!1))}setHudPause(e){this.isHudPaused!==e&&(this.isHudPaused=e,this.time.timeScale=e?0:1)}getRangeInTiles(e){const t=this.mapRenderer?this.mapRenderer.getTileSize():1;return t<=0?Math.max(1,Math.floor(e/60)):Math.max(1,Math.floor(e/t))}tryUpgradeTower(e,t,i){const s=this.towers.find(o=>o.spotId===e.id);if(!s)return;const r=s.level+1;if(r>=s.definition.levels.length){this.showFloatingText(t,i,"Max level");return}const a=s.definition.levels[r].cost;if(this.coins<a){this.showFloatingText(t,i,`Need ${a} coins`);return}this.coins-=a,s.level=r,s.stats={...s.definition.levels[r]},s.cooldown=0,this.applyBuildSpotAppearance(e),this.refreshHud();const n=this.mapRenderer?this.mapRenderer.getTileSize():0,l=Math.max(24,n*.5);this.showFloatingText(s.sprite.x,s.sprite.y-l,`Lvl ${s.level+1}`,"#facc15")}startNextWave(){if(this.runEnded)return;this.wave+=1,this.refreshHud();const e=Z+Math.max(0,this.wave-1)*ee,t=Math.max(se,900-this.wave*40),i=this.time.addEvent({delay:t,repeat:e-1,callback:()=>{this.spawnEnemy()},callbackScope:this});this.timers.push(i),this.spawnEnemy();const s=t*Math.max(e-1,0),r=this.time.delayedCall(s+te,()=>{this.timers=this.timers.filter(a=>a!==r),!this.runEnded&&this.startNextWave()});this.timers.push(r)}spawnEnemy(){const e=G+(this.wave-1)*V,t=U+(this.wave-1)*q,i=J+(this.wave-1)*Q,s=new g.Math.Vector2;this.path.getPoint(0,s);const a=(this.mapRenderer?this.mapRenderer.getTileSize():64)*.7,n=14441586,l=this.add.sprite(s.x,s.y,m.key,f.mobWalk1).setOrigin(.5).setDisplaySize(a,a).setTint(n).setDepth(6);this.anims.exists("enemy-walk")&&(l.play("enemy-walk"),l.anims.setProgress(Math.random())),this.enemies.push({sprite:l,distance:0,baseSpeed:t,slowFactor:1,slowUntil:0,hp:e,maxHp:e,reward:i,leakDamage:1,baseTint:n})}placeTower(e,t=this.selectedTowerDefinition){if(!this.mapRenderer)return;const i=e.marker,s={...t.levels[0]},r={spotId:e.id,sprite:i,definition:t,level:0,cooldown:0,stats:s};this.towers.push(r),this.coins-=s.cost,this.applyBuildSpotAppearance(e),this.selectedTowerDefinition=t,this.refreshHud();const a=this.mapRenderer.getTileSize(),n=Math.max(24,a*.5);this.showFloatingText(i.x,i.y-n,`${t.label} ready`)}updateEnemies(e){const t=new g.Math.Vector2,i=[],s=this.time.now;for(const r of this.enemies){r.slowUntil<=s&&r.slowFactor<1&&(r.slowFactor=1,r.sprite.setTint(r.baseTint));const a=r.baseSpeed*r.slowFactor;r.distance+=a*e;const n=r.distance/this.pathLength;if(n>=1){this.handleLeak(r),r.sprite.destroy();continue}this.path.getPoint(n,t),r.sprite.setPosition(t.x,t.y),i.push(r)}this.enemies=i}updateTowers(e){this.towerController?.update(this.towers,e)}renderOverlays(){if(!this.enemyOverlay||!this.mapRenderer)return;this.enemyOverlay.clear(),this.enemyOverlay.fillStyle(2042167,.8);const e=this.mapRenderer.getTileSize(),t=Math.max(24,e*.7),i=Math.max(4,e*.12);for(const s of this.enemies){const r=g.Math.Clamp(s.hp/s.maxHp,0,1),a=s.sprite.displayHeight/2+Math.max(6,e*.15);this.enemyOverlay.fillRect(s.sprite.x-t/2,s.sprite.y-a,t,i),this.enemyOverlay.fillStyle(16347926,.9),this.enemyOverlay.fillRect(s.sprite.x-t/2+1,s.sprite.y-a+1,(t-2)*r,i-2),this.enemyOverlay.fillStyle(2042167,.8)}}handleLeak(e){this.baseHp=Math.max(0,this.baseHp-e.leakDamage),this.leaks+=1,this.refreshHud(),this.showFloatingText(this.baseMarker.x,this.baseMarker.y,"Leak!","#f87171"),this.baseHp<=0&&this.endRun()}handleKill(e){const{x:t,y:i}=e.sprite;e.sprite.destroy(),this.enemies=this.enemies.filter(a=>a!==e),this.coins+=e.reward,this.coinsEarned+=e.reward,this.refreshHud();const s=this.mapRenderer.getTileSize(),r=Math.max(18,s*.45);this.showFloatingText(t,i-r,`+${e.reward}`,"#34d399")}refreshHud(){if(this.hudWave.setText(`Wave ${this.wave}`),this.hudHp.setText(`Base HP: ${this.baseHp}`),this.hudCoins.setText(`Coins: ${this.coins}`),this.hudLeaks.setText(`Leaks: ${this.leaks}`),this.hudTower){const e=this.selectedTowerDefinition.levels[0];this.hudTower.setText(`Last dragged: ${this.selectedTowerDefinition.label} - ${e.cost}c`)}this.baseMarker&&this.baseMarker.setFillStyle(this.baseHp>5?1319471:4136235,1),this.refreshTowerCardsAffordability()}refreshTowerCardsAffordability(){this.sidebarEntries.forEach(t=>{const i=this.coins>=t.definition.levels[0].cost;t.background.setFillStyle(1120295,i?.9:.45),t.icon.setAlpha(i?1:.5),t.costText.setColor(i?"#facc15":"#f87171")})}handleResize(e){const{width:t,height:i}=e;if(!t||!i||!this.mapRenderer)return;const s=this.towerDetailsHud?.definition;s&&this.closeTowerDetails(!1),this.cancelTowerDrag();const r=this.pathLength;this.sidebarWidth=this.computeSidebarWidth(),this.mapRenderer.setViewportPadding({left:16,right:this.sidebarWidth+24,top:16,bottom:24}),this.mapRenderer.render();const a=this.mapRenderer.getTileSize();this.createPath(),this.createBaseMarker(),this.buildSpots.forEach(o=>{const h=this.mapRenderer.gridToWorldCenter(o.col,o.row),p=this.towers.find(d=>d.spotId===o.id);if(p){const d=a*.6;p.sprite.setPosition(h.x,h.y).setDisplaySize(d,d)}this.applyBuildSpotAppearance(o)});const n=a*.7,l=new g.Math.Vector2;for(const o of this.enemies){const h=r>0?o.distance/r:0;o.distance=h*this.pathLength,this.path.getPoint(h,l),o.sprite.setPosition(l.x,l.y).setDisplaySize(n,n)}this.exitButton?.setPosition(t-20,16),this.createSidebar(),s&&this.openTowerDetails(s,!0)}endRun(){if(this.runEnded)return;this.cancelTowerDrag(),this.closeTowerDetails(),this.setHudPause(!1),this.runEnded=!0,this.timers.forEach(t=>t.remove()),this.timers=[],this.time.removeAllEvents();const e={waves:this.wave,leaks:this.leaks,coinsEarned:this.coinsEarned};O.exitHandler?.(e),this.scene.stop()}showFloatingText(e,t,i,s="#fbbf24"){const r=this.mapRenderer?this.mapRenderer.getTileSize():0,a=Math.max(28,r*.5),n=this.add.text(e,t,i,{...this.hudStyle(),fontSize:"14px",color:s}).setOrigin(.5,1).setDepth(10);this.tweens.add({targets:n,y:t-a,alpha:0,duration:900,ease:"Sine.easeOut",onComplete:()=>n.destroy()})}hudStyle(){return{fontFamily:"monospace",fontSize:"18px",color:"#f8fafc"}}applyBuildSpotAppearance(e){if(!this.mapRenderer)return;const t=this.towers.find(a=>a.spotId===e.id),i=!!t;if(e.occupied=i,!i||!t){this.mapRenderer.applyBuildSpotAppearance(e.marker,!1);return}const s=t.definition.levelTints??C,r=s[Math.min(t.level,s.length-1)];this.mapRenderer.applyBuildSpotAppearance(e.marker,!0,t.definition.spriteFrame,r)}rotateMapForVerticalStartIfNeeded(){this.mapRotatedForVerticalMode||!(this.scale.orientation===g.Scale.Orientation.PORTRAIT||this.scale.height>this.scale.width)||(this.rotateGameMapClockwise(),this.mapRotatedForVerticalMode=!0)}rotateGameMapClockwise(){const e=this.gameMap.rows,t=this.gameMap.cols,i=Array.from({length:t},()=>new Array(e));for(let s=0;s<e;s+=1)for(let r=0;r<t;r+=1){const a=r,n=e-1-s;i[a][n]=this.gameMap.tiles[s][r]}this.gameMap.tiles=i,this.gameMap.rows=t,this.gameMap.cols=e,this.gameMap.path=this.gameMap.path.map(({col:s,row:r})=>({col:e-1-r,row:s}))}ensureEnemyWalkAnimation(){if(!this.textures.exists(m.key)||this.anims.exists("enemy-walk"))return;const e=[f.mobWalk1,f.mobWalk2].map(t=>({key:m.key,frame:t}));this.anims.create({key:"enemy-walk",frames:e,frameRate:6,repeat:-1})}}const re={type:g.AUTO,width:960,height:640,backgroundColor:"#0b0f19",scene:O,fps:{target:60},scale:{mode:g.Scale.FIT,autoCenter:g.Scale.CENTER_BOTH}},F="towerDefenseHighScores",j=5,ae=()=>{if(typeof window>"u")return[];try{const w=window.localStorage.getItem(F);if(!w)return[];const e=JSON.parse(w);return Array.isArray(e)?e.sort((t,i)=>i.waves!==t.waves?i.waves-t.waves:t.leaks!==i.leaks?t.leaks-i.leaks:i.coinsEarned-t.coinsEarned).slice(0,j):[]}catch(w){return console.warn("Failed to read tower defence high scores",w),[]}},ne=w=>{try{window.localStorage.setItem(F,JSON.stringify(w))}catch(e){console.warn("Failed to store tower defence high scores",e)}},oe=(w,e)=>{const t=[...w,{...e,timestamp:Date.now()}];return t.sort((i,s)=>s.waves!==i.waves?s.waves-i.waves:i.leaks!==s.leaks?i.leaks-s.leaks:s.coinsEarned-i.coinsEarned),t.slice(0,j)},de=()=>{const w=R.useRef(null),e=R.useRef(null),[t,i]=R.useState(!1),[s,r]=R.useState(null),[a,n]=R.useState([]);R.useEffect(()=>{n(ae())},[]);const l=R.useCallback(h=>{r(h),i(!1),n(p=>{const d=oe(p,h);return ne(d),d})},[]);R.useEffect(()=>{if(!t){O.registerExitHandler(void 0),e.current&&(e.current.destroy(!0),e.current=null);return}const h=w.current;if(!h)return;O.registerExitHandler(l);const p=new g.Game({parent:h,...re});e.current=p;const d=()=>{const S=h.clientWidth,y=h.clientHeight;S&&y&&p.scale.setGameSize(S,y)};d();let u;return typeof ResizeObserver<"u"&&(u=new ResizeObserver(d),u.observe(h)),()=>{O.registerExitHandler(void 0),u?.disconnect(),p.destroy(!0),e.current=null}},[l,t]);const o=R.useCallback(()=>{r(null),i(!0)},[]);return t?c.jsx("div",{className:"h-screen w-screen overflow-hidden bg-[#0b0f19] text-slate-100",children:c.jsx("div",{ref:w,className:"h-full w-full"})}):c.jsxs(c.Fragment,{children:[c.jsxs("div",{className:"flex min-h-screen flex-col items-center justify-start bg-slate-950 px-6 py-6 pb-28 text-slate-100",children:[c.jsx("h1",{className:"mb-4 text-3xl font-semibold",children:"Tower Defence"}),c.jsxs("div",{className:"flex w-full max-w-[1100px] flex-col gap-6 lg:flex-row",children:[c.jsxs("div",{className:"flex-1 rounded-lg border border-white/10 bg-slate-900/60 p-5",children:[c.jsx("h2",{className:"mb-3 text-xl font-semibold",children:"High Scores"}),a.length===0?c.jsx("p",{className:"text-sm opacity-70",children:"No waves cleared yet. Place some towers!"}):c.jsxs("table",{className:"w-full border-collapse text-sm",children:[c.jsx("thead",{children:c.jsxs("tr",{className:"border-b border-white/5 text-left",children:[c.jsx("th",{className:"px-1 py-1",children:"#"}),c.jsx("th",{className:"px-1 py-1",children:"Waves"}),c.jsx("th",{className:"px-1 py-1",children:"Leaks"}),c.jsx("th",{className:"px-1 py-1",children:"Coins"}),c.jsx("th",{className:"px-1 py-1",children:"Date"})]})}),c.jsxs("tbody",{children:[s&&c.jsxs("tr",{children:[c.jsx("td",{className:"px-1 py-1",children:"Last"}),c.jsx("td",{className:"px-1 py-1",children:s.waves}),c.jsx("td",{className:"px-1 py-1",children:s.leaks}),c.jsx("td",{className:"px-1 py-1",children:s.coinsEarned}),c.jsx("td",{className:"px-1 py-1",children:"—"})]}),a.map((h,p)=>c.jsxs("tr",{className:"border-b border-white/5",children:[c.jsx("td",{className:"px-1 py-2",children:p+1}),c.jsx("td",{className:"px-1 py-2",children:h.waves}),c.jsx("td",{className:"px-1 py-2",children:h.leaks}),c.jsx("td",{className:"px-1 py-2",children:h.coinsEarned}),c.jsx("td",{className:"px-1 py-2",children:new Date(h.timestamp).toLocaleDateString()})]},`${h.timestamp}-${p}`))]})]})]}),c.jsxs("div",{className:`flex w-full max-w-sm flex-col gap-3 rounded-lg border border-white/10
        bg-slate-900/60 p-5 text-sm`,children:[c.jsx("h2",{className:"text-xl font-semibold",children:"How to Play"}),c.jsxs("ul",{className:"list-disc space-y-1 pl-5 opacity-80",children:[c.jsx("li",{children:"Drag a tower card from the right sidebar onto a glowing pad to build it."}),c.jsx("li",{children:"Towers auto-target creeps closest to your base."}),c.jsx("li",{children:"Tap the info arrow to pause the action and read tower stats."}),c.jsx("li",{children:"Kills drop coins; leaks damage the base."}),c.jsx("li",{children:"Survive as long as you can — waves keep scaling."})]})]})]}),c.jsx(L,{to:"/",className:`mt-6 inline-flex items-center justify-center rounded-md border border-slate-600
          bg-slate-800 px-4 py-2 text-sm font-medium text-slate-100 transition hover:bg-slate-700`,children:"Back to main page"})]}),c.jsx("button",{onClick:o,className:`fixed bottom-6 left-1/2 z-50 w-[calc(100%-3rem)] max-w-md -translate-x-1/2 transform rounded-md
        bg-blue-600 px-4 py-3 text-base font-semibold text-white shadow-lg transition hover:bg-blue-500`,children:"Play"})]})};export{de as default};
