import{r as E,j as h,L as z}from"./index-C7-GZHmS.js";import{O as T,P as u,a as d}from"./sprite-DTl04m-3.js";const A={obstacle:"X",road:"#",build:"_"};class H{map;constructor(e={height:8,width:12}){const t=this.normalizeConfig(e);this.map=this.generateMap(t.height,t.width,t.roadLength)}getMap(){return{cols:this.map.cols,rows:this.map.rows,tiles:this.map.tiles.map(e=>[...e]),path:this.map.path.map(e=>({...e}))}}normalizeConfig(e){const t=Math.max(3,Math.floor(e.height)),s=Math.max(3,Math.floor(e.width)),i=t*s,r=(t+s)*2,n=Math.floor(e.roadLength??r),a=Math.min(Math.max(2,n),i);return{height:t,width:s,roadLength:a}}generateMap(e,t,s){const i=Array.from({length:e},()=>Array.from({length:t},()=>"build"));this.applyObstacles(i);const r=this.generatePath(e,t,s);return r.forEach(({col:n,row:a})=>{i[a][n]="road"}),{cols:t,rows:e,tiles:i,path:r}}applyObstacles(e){const t=e.length,s=e[0]?.length??0;for(let i=0;i<t;i+=1)for(let r=0;r<s;r+=1){if(i===0||i===t-1||r===0||r===s-1){e[i][r]="obstacle";continue}Math.random()<.12&&(e[i][r]="obstacle")}}generatePath(e,t,s){const i=this.shuffle(this.collectEdgeCells(e,t));for(const r of i){const n=this.buildPath(r,e,t,s);if(n)return n}throw new Error("Failed to generate a valid path with the provided configuration.")}buildPath(e,t,s,i){const r=[e],n=new Set([this.cellKey(e.col,e.row)]);return i===1?this.isEdge(e,t,s)?r:void 0:this.extendPath(r,n,t,s,i)?r:void 0}extendPath(e,t,s,i,r){if(e.length===r){const l=e[e.length-1];return this.isEdge(l,s,i)}const n=e[e.length-1],a=this.shuffle(this.neighbors(n,s,i).filter(l=>!t.has(this.cellKey(l.col,l.row)))),o=r-e.length;for(const l of a){if(this.distanceToEdge(l,s,i)>o-1)continue;const p=o-1,g=this.isEdge(l,s,i);if(p>0&&g||p===0&&!g)continue;const m=this.cellKey(l.col,l.row);if(e.push(l),t.add(m),this.violatesSpacing(l,t,s,i)){t.delete(m),e.pop();continue}if(this.extendPath(e,t,s,i,r))return!0;t.delete(m),e.pop()}return!1}neighbors(e,t,s){const i=[{col:1,row:0},{col:-1,row:0},{col:0,row:1},{col:0,row:-1}],r=[];for(const n of i){const a=e.col+n.col,o=e.row+n.row;a>=0&&a<s&&o>=0&&o<t&&r.push({col:a,row:o})}return r}collectEdgeCells(e,t){const s=[];for(let i=0;i<t;i+=1)s.push({col:i,row:0});for(let i=1;i<e;i+=1)s.push({col:t-1,row:i});for(let i=t-2;i>=0;i-=1)e>1&&s.push({col:i,row:e-1});for(let i=e-2;i>0;i-=1)t>1&&s.push({col:0,row:i});return s}distanceToEdge(e,t,s){const i=Math.min(e.row,t-1-e.row),r=Math.min(e.col,s-1-e.col);return Math.min(i,r)}isEdge(e,t,s){return e.row===0||e.row===t-1||e.col===0||e.col===s-1}violatesSpacing(e,t,s,i){if(this.countRoadNeighbors(e,t,s,i)>4)return!0;const n=[{col:-1,row:-1},{col:0,row:-1},{col:1,row:-1},{col:-1,row:0},{col:1,row:0},{col:-1,row:1},{col:0,row:1},{col:1,row:1}];for(const a of n){const o=e.col+a.col,l=e.row+a.row;if(o<0||o>=i||l<0||l>=s)continue;const c=this.cellKey(o,l);if(t.has(c)&&this.countRoadNeighbors({col:o,row:l},t,s,i)>4)return!0}return!1}countRoadNeighbors(e,t,s,i){let r=0;for(let n=-1;n<=1;n+=1)for(let a=-1;a<=1;a+=1){if(n===0&&a===0)continue;const o=e.col+a,l=e.row+n;if(o<0||o>=i||l<0||l>=s)continue;const c=this.cellKey(o,l);t.has(c)&&(r+=1)}return r}cellKey(e,t){return`${e},${t}`}shuffle(e){for(let t=e.length-1;t>0;t-=1){const s=Math.floor(Math.random()*(t+1)),i=e[t];e[t]=e[s],e[s]=i}return e}}function _(f){const e=f.tiles.map(t=>t.map(s=>A[s]).join(""));console.log("Generated Tower Defense map:"),e.forEach(t=>console.log(t))}const C=[d.portalOpens,d.empty,d.tree1],k=[d.tree1,d.tree2,d.tree3,d.tree4,d.tree5,d.tree6];class B{scene;map;tileSpriteLookup=new Map;pathIndexByCell=new Map;gridTileSize=0;gridOriginX=0;gridOriginY=0;constructor(e,t){this.scene=e,this.map=t,this.map.path.forEach((s,i)=>{this.pathIndexByCell.set(this.cellKey(s.col,s.row),i)})}render(){const{width:e,height:t}=this.scene.scale;if(this.updateMetrics(e,t),!this.scene.textures.exists(T.key))return;const s=this.gridTileSize*.98;for(let i=0;i<this.map.rows;i+=1)for(let r=0;r<this.map.cols;r+=1){const n=this.map.tiles[i][r],a=this.cellKey(r,i),o=this.gridToWorldCenter(r,i),l=this.appearanceForTile(r,i,n);let c=this.tileSpriteLookup.get(a);c?(c.setPosition(o.x,o.y).setDisplaySize(s,s).setFrame(l.frame).setAngle(l.angle),c.setTint(this.tintForTile(n))):(c=this.scene.add.sprite(o.x,o.y,T.key,l.frame).setOrigin(.5).setDisplaySize(s,s),c.setAngle(l.angle),c.setTint(this.tintForTile(n)),this.tileSpriteLookup.set(a,c))}}getTileSprite(e,t){return this.tileSpriteLookup.get(this.cellKey(e,t))}getTileSize(){return this.gridTileSize}gridToWorldCenter(e,t){const s=this.gridOriginX+e*this.gridTileSize+this.gridTileSize/2,i=this.gridOriginY+t*this.gridTileSize+this.gridTileSize/2;return new u.Math.Vector2(s,i)}applyBuildSpotAppearance(e,t,s,i){if(t){const n=this.gridTileSize*.6;e.setFrame(s??d.tower1).setDisplaySize(n,n).setDepth(7).setTint(i??15857145).setAngle(0);return}const r=this.gridTileSize*.98;e.setFrame(C[1]).setDisplaySize(r,r).setDepth(0).setTint(6333946).setAngle(0)}updateMetrics(e,t){const s=e/this.map.cols,i=t/this.map.rows;this.gridTileSize=Math.min(s,i);const r=this.gridTileSize*this.map.cols,n=this.gridTileSize*this.map.rows;this.gridOriginX=(e-r)/2,this.gridOriginY=(t-n)/2}appearanceForTile(e,t,s){return s==="road"?this.roadAppearance(e,t):s==="obstacle"?{frame:k[u.Math.Between(0,k.length)],angle:0}:{frame:d.empty,angle:0}}roadAppearance(e,t){const s=this.cellKey(e,t),i=this.pathIndexByCell.get(s);if(i===void 0)return{frame:d.roadStraight,angle:0};const r=this.map.path,n=r[i],a=i>0?r[i-1]:void 0,o=i<r.length-1?r[i+1]:void 0,l=new Set;a&&l.add(this.oppositeDirection(this.directionBetween(a,n))),o&&l.add(this.directionBetween(n,o));const c=l.has("up"),p=l.has("down"),g=l.has("left"),m=l.has("right");return(c||p)&&(g||m)?{frame:d.roadTurn,angle:this.cornerAngle(c,p,g,m)}:g||m?{frame:d.roadStraight,angle:90}:{frame:d.roadStraight,angle:0}}cornerAngle(e,t,s,i){return t&&i?0:e&&i?-90:e&&s?180:t&&s?90:0}directionBetween(e,t){return t.col>e.col?"right":t.col<e.col?"left":t.row>e.row?"down":"up"}oppositeDirection(e){switch(e){case"up":return"down";case"down":return"up";case"left":return"right";case"right":default:return"left"}}tintForTile(e){return e==="road"?13421738:e==="build"?12636415:6320256}cellKey(e,t){return`${e},${t}`}}const F=15,W=75,w=25,y=170,x=650,S=10,j=30,L=6,I=90,K=6,G=6,$=2,Y=6,U=2,V=3e3,q=400,O=15,N=20,X=(O+N)*2,J=[15857145,16436245,16347926],v=[{key:"regular",label:"Regular",shortcut:"1",spriteFrame:d.tower1,description:"Balanced single-target tower.",levels:[{cost:w,range:y,fireRate:x,damage:S},{cost:w+10,range:y+25,fireRate:Math.max(450,x-80),damage:Math.round(S*1.6)},{cost:w+25,range:y+50,fireRate:Math.max(360,x-160),damage:Math.round(S*2.4)}]},{key:"scatter",label:"Scatter",shortcut:"2",spriteFrame:d.sword1,description:"Short-range burst in 8 directions.",levels:[{cost:w+5,range:Math.round(y*.65),fireRate:x+150,damage:Math.round(S*.6),projectileCount:8},{cost:w+20,range:Math.round(y*.7),fireRate:x+60,damage:Math.round(S*.75),projectileCount:8},{cost:w+35,range:Math.round(y*.78),fireRate:Math.max(500,x-40),damage:Math.round(S*.95),projectileCount:8}]},{key:"bomber",label:"Bomber",shortcut:"3",spriteFrame:d.bomb,description:"Heavy projectile with splash damage.",levels:[{cost:w+10,range:y+30,fireRate:x+300,damage:Math.round(S*1.8),aoeRadius:70},{cost:w+25,range:y+60,fireRate:x+200,damage:Math.round(S*2.4),aoeRadius:90},{cost:w+45,range:y+80,fireRate:x+100,damage:Math.round(S*3),aoeRadius:110}]},{key:"freezer",label:"Freezer",shortcut:"4",spriteFrame:d.aura,levelTints:[3718648,959977,165063],description:"Slows enemies in range.",levels:[{cost:w+5,range:y-10,fireRate:x+120,damage:Math.round(S*.4),slowFactor:.65,slowDurationMs:2e3},{cost:w+18,range:y+10,fireRate:x+40,damage:Math.round(S*.55),slowFactor:.5,slowDurationMs:2600},{cost:w+32,range:y+25,fireRate:Math.max(480,x-40),damage:Math.round(S*.7),slowFactor:.4,slowDurationMs:3200}]}];class M extends u.Scene{static exitHandler;mapGenerator=new H({height:O,width:N,roadLength:X});gameMap=this.mapGenerator.getMap();mapRenderer;buildSpots=[];towers=[];enemies=[];selectedTowerDefinition=v[0];path;pathLength=0;enemyOverlay;towerOverlay;timers=[];wave=0;leaks=0;baseHp=F;coins=W;coinsEarned=0;hudWave;hudHp;hudCoins;hudLeaks;hudTower;hudHint;exitButton;baseMarker;runEnded=!1;static registerExitHandler(e){M.exitHandler=e}preload(){this.load.setPath(""),this.textures.exists(T.key)||this.load.spritesheet(T.key,T.url,{frameWidth:T.frameWidth,frameHeight:T.frameHeight,spacing:T.spacing})}create(){_(this.gameMap),this.cameras.main.setBackgroundColor("#0b0f19"),this.ensureEnemyWalkAnimation(),this.enemyOverlay=this.add.graphics().setDepth(5),this.towerOverlay=this.add.graphics().setDepth(4),this.mapRenderer=new B(this,this.gameMap),this.mapRenderer.render(),this.createPath(),this.createBaseMarker(),this.createBuildSpots(),this.createHud(),this.configureInput(),this.scale.on("resize",this.handleResize,this),this.time.delayedCall(600,()=>this.startNextWave())}update(e,t){if(this.runEnded)return;const s=t/1e3;this.updateEnemies(s),this.updateTowers(t),this.renderOverlays()}createPath(){const e=this.gameMap.path;if(e.length===0||!this.mapRenderer)return;const t=this.mapRenderer.gridToWorldCenter(e[0].col,e[0].row);this.path=new u.Curves.Path(t.x,t.y);for(let s=1;s<e.length;s+=1){const i=this.mapRenderer.gridToWorldCenter(e[s].col,e[s].row);this.path.lineTo(i.x,i.y)}this.pathLength=this.path.getLength()}createBaseMarker(){this.baseMarker?.destroy();const e=this.gameMap.path;if(e.length===0||!this.mapRenderer)return;const t=e[e.length-1],s=this.mapRenderer.gridToWorldCenter(t.col,t.row),r=this.mapRenderer.getTileSize()*.9;this.baseMarker=this.add.rectangle(s.x,s.y,r,r,1319471).setStrokeStyle(2,3854591,.6).setDepth(2)}createBuildSpots(){if(!this.mapRenderer)return;this.buildSpots=[];let e=0;for(let t=0;t<this.gameMap.rows;t+=1)for(let s=0;s<this.gameMap.cols;s+=1){if(this.gameMap.tiles[t][s]!=="build")continue;const i=this.mapRenderer.getTileSprite(s,t);if(!i)continue;const r={id:e,col:s,row:t,occupied:!1,marker:i};this.buildSpots.push(r),this.applyBuildSpotAppearance(r),e+=1}}createHud(){this.hudWave?.destroy(),this.hudHp?.destroy(),this.hudCoins?.destroy(),this.hudLeaks?.destroy(),this.hudTower?.destroy(),this.hudHint?.destroy(),this.exitButton?.destroy(),this.hudWave=this.add.text(16,16,"",this.hudStyle()),this.hudHp=this.add.text(16,44,"",this.hudStyle()),this.hudCoins=this.add.text(16,72,"",this.hudStyle()),this.hudLeaks=this.add.text(16,100,"",this.hudStyle()),this.hudTower=this.add.text(16,128,"",{...this.hudStyle(),fontSize:"16px",color:"#7dd3fc"}),this.hudHint=this.add.text(16,154,this.selectedTowerDefinition.description,{...this.hudStyle(),fontSize:"14px",color:"#94a3b8"}),this.exitButton=this.add.text(this.scale.width-20,16,"Exit",{...this.hudStyle(),color:"#f87171"}).setOrigin(1,0).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this.endRun()),this.add.text(this.scale.width/2,this.scale.height-24,"Press 1-4 to swap. Click tower to upgrade.",{...this.hudStyle(),fontSize:"14px",color:"#9ca3af"}).setOrigin(.5,1),this.refreshHud()}configureInput(){const e=this.input.keyboard;e?.on("keydown-ESC",()=>this.endRun()),e?.on("keydown-ONE",()=>this.selectTowerByShortcut("1")),e?.on("keydown-TWO",()=>this.selectTowerByShortcut("2")),e?.on("keydown-THREE",()=>this.selectTowerByShortcut("3")),e?.on("keydown-FOUR",()=>this.selectTowerByShortcut("4")),e?.on("keydown-NUMPAD_ONE",()=>this.selectTowerByShortcut("1")),e?.on("keydown-NUMPAD_TWO",()=>this.selectTowerByShortcut("2")),e?.on("keydown-NUMPAD_THREE",()=>this.selectTowerByShortcut("3")),e?.on("keydown-NUMPAD_FOUR",()=>this.selectTowerByShortcut("4")),this.input.on("pointerdown",t=>{if(this.runEnded)return;const s=this.buildSpots.find(r=>r.marker.getBounds().contains(t.worldX,t.worldY));if(!s)return;if(s.occupied){this.tryUpgradeTower(s,t.worldX,t.worldY);return}const i=this.selectedTowerDefinition.levels[0].cost;if(this.coins<i){this.showFloatingText(t.worldX,t.worldY,"Not enough coins");return}this.placeTower(s)})}selectTowerByShortcut(e){const t=v.find(s=>s.shortcut===e);!t||t===this.selectedTowerDefinition||(this.selectedTowerDefinition=t,this.refreshHud())}tryUpgradeTower(e,t,s){const i=this.towers.find(l=>l.spotId===e.id);if(!i)return;const r=i.level+1;if(r>=i.definition.levels.length){this.showFloatingText(t,s,"Max level");return}const n=i.definition.levels[r].cost;if(this.coins<n){this.showFloatingText(t,s,`Need ${n} coins`);return}this.coins-=n,i.level=r,i.stats={...i.definition.levels[r]},i.cooldown=0,this.applyBuildSpotAppearance(e),this.refreshHud();const a=this.mapRenderer?this.mapRenderer.getTileSize():0,o=Math.max(24,a*.5);this.showFloatingText(i.sprite.x,i.sprite.y-o,`Lvl ${i.level+1}`,"#facc15")}startNextWave(){if(this.runEnded)return;this.wave+=1,this.refreshHud();const e=Y+Math.max(0,this.wave-1)*U,t=Math.max(q,900-this.wave*40),s=this.time.addEvent({delay:t,repeat:e-1,callback:()=>{this.spawnEnemy()}});this.timers.push(s),this.spawnEnemy();const i=t*Math.max(e-1,0),r=this.time.delayedCall(i+V,()=>{this.timers=this.timers.filter(n=>n!==r),!this.runEnded&&this.startNextWave()});this.timers.push(r)}spawnEnemy(){const e=j+(this.wave-1)*L,t=I+(this.wave-1)*K,s=G+(this.wave-1)*$,i=new u.Math.Vector2;this.path.getPoint(0,i);const n=(this.mapRenderer?this.mapRenderer.getTileSize():64)*.7,a=14441586,o=this.add.sprite(i.x,i.y,T.key,d.mobWalk1).setOrigin(.5).setDisplaySize(n,n).setTint(a).setDepth(6);this.anims.exists("enemy-walk")&&(o.play("enemy-walk"),o.anims.setProgress(Math.random())),this.enemies.push({sprite:o,distance:0,baseSpeed:t,slowFactor:1,slowUntil:0,hp:e,maxHp:e,reward:s,leakDamage:1,baseTint:a})}placeTower(e){if(!this.mapRenderer)return;const t=e.marker,s=this.selectedTowerDefinition,i={...s.levels[0]},r={spotId:e.id,sprite:t,definition:s,level:0,cooldown:0,stats:i};this.towers.push(r),this.coins-=i.cost,this.applyBuildSpotAppearance(e),this.refreshHud();const n=this.mapRenderer.getTileSize(),a=Math.max(24,n*.5);this.showFloatingText(t.x,t.y-a,`${s.label} ready`)}updateEnemies(e){const t=new u.Math.Vector2,s=[],i=this.time.now;for(const r of this.enemies){r.slowUntil<=i&&r.slowFactor<1&&(r.slowFactor=1,r.sprite.setTint(r.baseTint));const n=r.baseSpeed*r.slowFactor;r.distance+=n*e;const a=r.distance/this.pathLength;if(a>=1){this.handleLeak(r),r.sprite.destroy();continue}this.path.getPoint(a,t),r.sprite.setPosition(t.x,t.y),s.push(r)}this.enemies=s}updateTowers(e){const t=e;this.towerOverlay?.clear();for(const s of this.towers)s.cooldown=Math.max(0,s.cooldown-t),!(s.cooldown>0)&&this.performTowerAttack(s)&&(s.cooldown=s.stats.fireRate)}performTowerAttack(e){switch(e.definition.key){case"scatter":return this.fireScatterTower(e);case"bomber":return this.fireBomberTower(e);case"freezer":return this.fireFreezerTower(e);case"regular":default:return this.fireRegularTower(e)}}fireRegularTower(e){const t=this.findTargetForTower(e);if(!t)return!1;const{sprite:s}=e;return this.towerOverlay?.lineStyle(3,16436245,.6).beginPath().moveTo(s.x,s.y).lineTo(t.sprite.x,t.sprite.y).strokePath(),this.applyDamage(t,e.stats.damage),!0}fireScatterTower(e){const t=e.stats.projectileCount??8;if(t<=0)return!1;const s=e.sprite.x,i=e.sprite.y,r=this.enemiesWithinCircle(s,i,e.stats.range);if(r.length===0)return!1;const n=new Map,a=Math.PI/4;for(const c of r){const p=u.Math.Angle.Between(s,i,c.sprite.x,c.sprite.y),g=u.Math.Wrap(p,-Math.PI,Math.PI),m=(Math.round(g/a)%8+8)%8,b=n.get(m);if(!b){n.set(m,c);continue}const R=u.Math.Distance.Squared(s,i,b.sprite.x,b.sprite.y);u.Math.Distance.Squared(s,i,c.sprite.x,c.sprite.y)<R&&n.set(m,c)}const o=Array.from(n.values()).slice(0,t);if(o.length===0)return!1;const l=this.towerOverlay;for(const c of o){if(!l)break;l.lineStyle(2,16569165,.55).beginPath().moveTo(s,i).lineTo(c.sprite.x,c.sprite.y).strokePath()}for(const c of o)this.applyDamage(c,e.stats.damage);return!0}fireBomberTower(e){const t=e.stats.aoeRadius;if(!t)return!1;const s=this.findTargetForTower(e);if(!s)return!1;const i=s.sprite.x,r=s.sprite.y,n=this.enemiesWithinCircle(i,r,t);if(n.length===0)return!1;this.towerOverlay?.lineStyle(3,16347926,.8).strokeCircle(i,r,t);for(const a of n)this.applyDamage(a,e.stats.damage);return!0}fireFreezerTower(e){const t=e.stats.slowFactor??1,s=e.stats.slowDurationMs??0,i=this.enemiesWithinCircle(e.sprite.x,e.sprite.y,e.stats.range);if(i.length===0)return!1;if(this.towerOverlay?.lineStyle(2,3718648,.65).strokeCircle(e.sprite.x,e.sprite.y,e.stats.range),t<1&&s>0&&this.applySlow(i,t,s),e.stats.damage>0)for(const r of i)this.applyDamage(r,e.stats.damage);return!0}enemiesWithinCircle(e,t,s){const i=s*s;return this.enemies.filter(r=>u.Math.Distance.Squared(e,t,r.sprite.x,r.sprite.y)<=i)}applyDamage(e,t){t<=0||!this.enemies.includes(e)||(e.hp-=t,e.hp<=0&&this.handleKill(e))}applySlow(e,t,s){const i=u.Math.Clamp(t,.1,1),r=this.time.now;for(const n of e)this.enemies.includes(n)&&(n.slowFactor=Math.min(n.slowFactor,i),n.slowUntil=Math.max(n.slowUntil,r+s),n.sprite.setTint(6333946))}renderOverlays(){if(!this.enemyOverlay||!this.mapRenderer)return;this.enemyOverlay.clear(),this.enemyOverlay.fillStyle(2042167,.8);const e=this.mapRenderer.getTileSize(),t=Math.max(24,e*.7),s=Math.max(4,e*.12);for(const i of this.enemies){const r=u.Math.Clamp(i.hp/i.maxHp,0,1),n=i.sprite.displayHeight/2+Math.max(6,e*.15);this.enemyOverlay.fillRect(i.sprite.x-t/2,i.sprite.y-n,t,s),this.enemyOverlay.fillStyle(16347926,.9),this.enemyOverlay.fillRect(i.sprite.x-t/2+1,i.sprite.y-n+1,(t-2)*r,s-2),this.enemyOverlay.fillStyle(2042167,.8)}}findTargetForTower(e){let t,s=-1/0;for(const i of this.enemies){if(u.Math.Distance.Squared(e.sprite.x,e.sprite.y,i.sprite.x,i.sprite.y)>e.stats.range*e.stats.range)continue;const n=i.distance;n>s&&(t=i,s=n)}return t}handleLeak(e){this.baseHp=Math.max(0,this.baseHp-e.leakDamage),this.leaks+=1,this.refreshHud(),this.showFloatingText(this.baseMarker.x,this.baseMarker.y,"Leak!","#f87171"),this.baseHp<=0&&this.endRun()}handleKill(e){const{x:t,y:s}=e.sprite;e.sprite.destroy(),this.enemies=this.enemies.filter(n=>n!==e),this.coins+=e.reward,this.coinsEarned+=e.reward,this.refreshHud();const i=this.mapRenderer.getTileSize(),r=Math.max(18,i*.45);this.showFloatingText(t,s-r,`+${e.reward}`,"#34d399")}refreshHud(){if(this.hudWave.setText(`Wave ${this.wave}`),this.hudHp.setText(`Base HP: ${this.baseHp}`),this.hudCoins.setText(`Coins: ${this.coins}`),this.hudLeaks.setText(`Leaks: ${this.leaks}`),this.hudTower){const e=this.selectedTowerDefinition.levels[0];this.hudTower.setText(`Building: ${this.selectedTowerDefinition.label} [${this.selectedTowerDefinition.shortcut}] - ${e.cost}c`)}this.hudHint?.setText(this.selectedTowerDefinition.description),this.baseMarker&&this.baseMarker.setFillStyle(this.baseHp>5?1319471:4136235,1)}handleResize(e){const{width:t,height:s}=e;if(!t||!s||!this.mapRenderer)return;const i=this.pathLength;this.mapRenderer.render();const r=this.mapRenderer.getTileSize();this.createPath(),this.createBaseMarker(),this.buildSpots.forEach(o=>{const l=this.mapRenderer.gridToWorldCenter(o.col,o.row),c=this.towers.find(p=>p.spotId===o.id);if(c){const p=r*.6;c.sprite.setPosition(l.x,l.y).setDisplaySize(p,p)}this.applyBuildSpotAppearance(o)});const n=r*.7,a=new u.Math.Vector2;for(const o of this.enemies){const l=i>0?o.distance/i:0;o.distance=l*this.pathLength,this.path.getPoint(l,a),o.sprite.setPosition(a.x,a.y).setDisplaySize(n,n)}this.exitButton?.setPosition(t-20,16)}endRun(){if(this.runEnded)return;this.runEnded=!0,this.timers.forEach(t=>t.remove()),this.timers=[],this.time.removeAllEvents();const e={waves:this.wave,leaks:this.leaks,coinsEarned:this.coinsEarned};M.exitHandler?.(e),this.scene.stop()}showFloatingText(e,t,s,i="#fbbf24"){const r=this.mapRenderer?this.mapRenderer.getTileSize():0,n=Math.max(28,r*.5),a=this.add.text(e,t,s,{...this.hudStyle(),fontSize:"14px",color:i}).setOrigin(.5,1).setDepth(10);this.tweens.add({targets:a,y:t-n,alpha:0,duration:900,ease:"Sine.easeOut",onComplete:()=>a.destroy()})}hudStyle(){return{fontFamily:"monospace",fontSize:"18px",color:"#f8fafc"}}applyBuildSpotAppearance(e){if(!this.mapRenderer)return;const t=this.towers.find(n=>n.spotId===e.id),s=!!t;if(e.occupied=s,!s||!t){this.mapRenderer.applyBuildSpotAppearance(e.marker,!1);return}const i=t.definition.levelTints??J,r=i[Math.min(t.level,i.length-1)];this.mapRenderer.applyBuildSpotAppearance(e.marker,!0,t.definition.spriteFrame,r)}ensureEnemyWalkAnimation(){if(!this.textures.exists(T.key)||this.anims.exists("enemy-walk"))return;const e=[d.mobWalk1,d.mobWalk2].map(t=>({key:T.key,frame:t}));this.anims.create({key:"enemy-walk",frames:e,frameRate:6,repeat:-1})}}const Z={type:u.AUTO,width:960,height:640,backgroundColor:"#0b0f19",scene:M,fps:{target:60},scale:{mode:u.Scale.RESIZE,autoCenter:u.Scale.CENTER_BOTH}},D="towerDefenseHighScores",P=5,Q=()=>{if(typeof window>"u")return[];try{const f=window.localStorage.getItem(D);if(!f)return[];const e=JSON.parse(f);return Array.isArray(e)?e.sort((t,s)=>s.waves!==t.waves?s.waves-t.waves:t.leaks!==s.leaks?t.leaks-s.leaks:s.coinsEarned-t.coinsEarned).slice(0,P):[]}catch(f){return console.warn("Failed to read tower defence high scores",f),[]}},ee=f=>{try{window.localStorage.setItem(D,JSON.stringify(f))}catch(e){console.warn("Failed to store tower defence high scores",e)}},te=(f,e)=>{const t=[...f,{...e,timestamp:Date.now()}];return t.sort((s,i)=>i.waves!==s.waves?i.waves-s.waves:s.leaks!==i.leaks?s.leaks-i.leaks:i.coinsEarned-s.coinsEarned),t.slice(0,P)},ne=()=>{const f=E.useRef(null),e=E.useRef(null),[t,s]=E.useState(!1),[i,r]=E.useState(null),[n,a]=E.useState([]);E.useEffect(()=>{a(Q())},[]);const o=E.useCallback(c=>{r(c),s(!1),a(p=>{const g=te(p,c);return ee(g),g})},[]);E.useEffect(()=>{if(!t){M.registerExitHandler(void 0),e.current&&(e.current.destroy(!0),e.current=null);return}const c=f.current;if(!c)return;M.registerExitHandler(o);const p=new u.Game({parent:c,...Z});e.current=p;const g=()=>{const b=c.clientWidth,R=c.clientHeight;b&&R&&p.scale.resize(b,R)};g();let m;return typeof ResizeObserver<"u"&&(m=new ResizeObserver(g),m.observe(c)),()=>{M.registerExitHandler(void 0),m?.disconnect(),p.destroy(!0),e.current=null}},[o,t]);const l=E.useCallback(()=>{r(null),s(!0)},[]);return t?h.jsx("div",{className:"h-screen w-screen overflow-hidden bg-[#0b0f19] text-slate-100",children:h.jsx("div",{ref:f,className:"h-full w-full"})}):h.jsxs(h.Fragment,{children:[h.jsxs("div",{className:"flex min-h-screen flex-col items-center justify-start bg-slate-950 px-6 py-6 pb-28 text-slate-100",children:[h.jsx("h1",{className:"mb-4 text-3xl font-semibold",children:"Tower Defence"}),h.jsxs("div",{className:"flex w-full max-w-[1100px] flex-col gap-6 lg:flex-row",children:[h.jsxs("div",{className:"flex-1 rounded-lg border border-white/10 bg-slate-900/60 p-5",children:[h.jsx("h2",{className:"mb-3 text-xl font-semibold",children:"High Scores"}),n.length===0?h.jsx("p",{className:"text-sm opacity-70",children:"No waves cleared yet. Place some towers!"}):h.jsxs("table",{className:"w-full border-collapse text-sm",children:[h.jsx("thead",{children:h.jsxs("tr",{className:"border-b border-white/5 text-left",children:[h.jsx("th",{className:"px-1 py-1",children:"#"}),h.jsx("th",{className:"px-1 py-1",children:"Waves"}),h.jsx("th",{className:"px-1 py-1",children:"Leaks"}),h.jsx("th",{className:"px-1 py-1",children:"Coins"}),h.jsx("th",{className:"px-1 py-1",children:"Date"})]})}),h.jsxs("tbody",{children:[i&&h.jsxs("tr",{children:[h.jsx("td",{className:"px-1 py-1",children:"Last"}),h.jsx("td",{className:"px-1 py-1",children:i.waves}),h.jsx("td",{className:"px-1 py-1",children:i.leaks}),h.jsx("td",{className:"px-1 py-1",children:i.coinsEarned}),h.jsx("td",{className:"px-1 py-1",children:"—"})]}),n.map((c,p)=>h.jsxs("tr",{className:"border-b border-white/5",children:[h.jsx("td",{className:"px-1 py-2",children:p+1}),h.jsx("td",{className:"px-1 py-2",children:c.waves}),h.jsx("td",{className:"px-1 py-2",children:c.leaks}),h.jsx("td",{className:"px-1 py-2",children:c.coinsEarned}),h.jsx("td",{className:"px-1 py-2",children:new Date(c.timestamp).toLocaleDateString()})]},`${c.timestamp}-${p}`))]})]})]}),h.jsxs("div",{className:`flex w-full max-w-sm flex-col gap-3 rounded-lg border border-white/10
        bg-slate-900/60 p-5 text-sm`,children:[h.jsx("h2",{className:"text-xl font-semibold",children:"How to Play"}),h.jsxs("ul",{className:"list-disc space-y-1 pl-5 opacity-80",children:[h.jsx("li",{children:"Click a glowing pad to spend 25 coins on a tower."}),h.jsx("li",{children:"Towers auto-target creeps closest to your base."}),h.jsx("li",{children:"Kills drop coins; leaks damage the base."}),h.jsx("li",{children:"Survive as long as you can — waves keep scaling."})]})]})]}),h.jsx(z,{to:"/",className:`mt-6 inline-flex items-center justify-center rounded-md border border-slate-600
          bg-slate-800 px-4 py-2 text-sm font-medium text-slate-100 transition hover:bg-slate-700`,children:"Back to main page"})]}),h.jsx("button",{onClick:l,className:`fixed bottom-6 left-1/2 z-50 w-[calc(100%-3rem)] max-w-md -translate-x-1/2 transform rounded-md
        bg-blue-600 px-4 py-3 text-base font-semibold text-white shadow-lg transition hover:bg-blue-500`,children:"Play"})]})};export{ne as default};
