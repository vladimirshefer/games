import{r as P,j as f,L as Ne}from"./index-Ckm4MN4O.js";import{O as S,a as x,P as c}from"./sprite-BHReGaDD.js";const Ue=2e4,G=150,N=14,C=100,F=5,ne=G*.6,H=N,re=5,he=C*.05,M=20,j=2,O=N*2,_=260,Re=M*j,Ce=1.3,Ee=H*2;function Ge(h){const e=h.add.sprite(0,0,S.key,x.hero);e.setOrigin(.5),e.setDisplaySize(N*2,N*2),e.setTint(5025616),e.setDepth(.2),e.setData("radius",N);const t=h.add.circle(e.x,e.y,Ee,16771899,.1);return t.setDepth(-1),t.setVisible(!1),{sprite:e,aura:t,radius:N,maxHp:C,hp:C,hasAura:!1,upgrades:[],weaponIds:[],direction:new c.Math.Vector2(0,0),areaMultiplier:1,damageMultiplier:1}}function Fe(h,e,t,s){h.sprite.x+=e.x*t*s,h.sprite.y+=e.y*t*s,h.aura.setPosition(h.sprite.x,h.sprite.y),e.lengthSq()>1e-4&&h.direction.copy(e)}function Le(h,e){return h.hp=Math.max(0,h.hp-e),h.hp}function ze(h,e){return h.hp=Math.min(h.maxHp,h.hp+e),h.hp}function D(h){return{damage:Math.ceil(h.damage??F),cooldown:Math.ceil((h.cooldown??2)*10)/10,area:Math.ceil(h.area??0),pierce:Math.ceil(h.pierce??0),sectorAngle:Math.ceil(h.sectorAngle??120)}}const de=D({damage:F,cooldown:.5,pierce:1,area:6}),ae=h=>D({...h,damage:h.damage*1.1,cooldown:h.cooldown*.9,pierce:h.pierce+1}),X=ae(de),K=ae(X),q=ae(K),ke=ae(q),pe=D({damage:F,cooldown:1,area:Ee}),ie=h=>D({...h,damage:h.damage*1.1,cooldown:h.cooldown*.9,area:h.area*1.2}),Y=ie(pe),$=ie(Y),J=ie($),Ae=ie(J),ue=D({cooldown:5,damage:F*4,area:100}),Pe=h=>D({...h,damage:h.damage*1.3,cooldown:h.cooldown*.7,area:h.area*1.2}),Z=Pe(ue),Oe=Pe(Z),ge=D({cooldown:2,damage:F*2,area:50,sectorAngle:120}),oe=h=>D({...h,damage:h.damage*1.1,cooldown:h.cooldown*.9,area:h.area+10,sectorAngle:h.sectorAngle+10}),Q=oe(ge),ee=oe(Q),te=oe(ee),De=oe(te),me=[{id:"aura",label:"Unlock Aura",description:"Activate a damaging circle around you.",category:"WEAPON_NEW",weaponId:"aura",level:1},{id:"auraMk2",label:"Aura Mk II",description:E(pe,Y),requires:["aura"],category:"WEAPON_UPGRADE",weaponId:"aura",level:2},{id:"auraMk3",label:"Aura Mk III",description:E(Y,$),requires:["auraMk2"],category:"WEAPON_UPGRADE",weaponId:"aura",level:3},{id:"auraMk4",label:"Aura Mk IV",description:E($,J),requires:["auraMk3"],category:"WEAPON_UPGRADE",weaponId:"aura",level:4},{id:"auraMk5",label:"Aura Mk V",description:E(J,Ae),requires:["auraMk4"],category:"WEAPON_UPGRADE",weaponId:"aura",level:5},{id:"pistol",label:"Equip Pistol",description:"Basic ranged damage with moderate fire rate.",category:"WEAPON_NEW",weaponId:"pistol",level:1},{id:"pistolMk2",label:"Pistol Mk II",description:E(de,X),requires:["pistol"],category:"WEAPON_UPGRADE",weaponId:"pistol",level:2},{id:"pistolMk3",label:"Pistol Mk III",description:E(X,K),requires:["pistolMk2"],category:"WEAPON_UPGRADE",weaponId:"pistol",level:3},{id:"pistolMk4",label:"Pistol Mk IV",description:E(K,q),requires:["pistolMk3"],category:"WEAPON_UPGRADE",weaponId:"pistol",level:4},{id:"pistolMk5",label:"Pistol Mk V",description:E(q,ke),requires:["pistolMk4"],category:"WEAPON_UPGRADE",weaponId:"pistol",level:5},{id:"bomb",label:"Deploy Bombs",description:"Drop timed explosives dealing area damage.",category:"WEAPON_NEW",weaponId:"bomb",level:1},{id:"bombMk2",label:"Bombs Mk II",description:E(ue,Z),requires:["bomb"],category:"WEAPON_UPGRADE",weaponId:"bomb",level:2},{id:"bombMk3",label:"Bombs Mk III",description:E(Z,Oe),requires:["bombMk2"],category:"WEAPON_UPGRADE",weaponId:"bomb",level:3},{id:"sword",label:"Equip Sword",description:"Unlock a melee sword slash in your movement direction.",category:"WEAPON_NEW",weaponId:"sword",level:1},{id:"swordMk2",label:"Sword Mk II",description:E(ge,Q),requires:["sword"],category:"WEAPON_UPGRADE",weaponId:"sword",level:2},{id:"swordMk3",label:"Sword Mk III",description:E(Q,ee),requires:["swordMk2"],category:"WEAPON_UPGRADE",weaponId:"sword",level:3},{id:"swordMk4",label:"Sword Mk IV",description:E(ee,te),requires:["swordMk3"],category:"WEAPON_UPGRADE",weaponId:"sword",level:4},{id:"swordMk5",label:"Sword Mk V",description:E(te,De),requires:["swordMk4"],category:"WEAPON_UPGRADE",weaponId:"sword",level:5},{id:"area1",label:"Area +10%",description:"Increase area of effect by 10%",category:"PASSIVE_NEW",level:1},{id:"damage1",label:"Damage +10%",description:"Increase all weapon damage by 10%.",category:"PASSIVE_NEW",level:1}];function E(h,e){return[h.damage!==e.damage&&`DMG ${h.damage}→${e.damage}`,h.cooldown!==e.cooldown&&`Cooldown ${h.cooldown}→${e.cooldown}`,h.area!==e.area&&`Area ${h.area}→${e.area}`,h.pierce!==e.pierce&&`Pierce ${h.pierce}→${e.pierce}`,h.sectorAngle!==e.sectorAngle&&`Angle ${h.sectorAngle}→${e.sectorAngle}`].filter(Boolean).reduce((t,s)=>s?`${t} ${s}`:t,"")}const fe=.8,xe=.3;class Ve{id=()=>"sword";swordElapsed=0;activeSwordSwing=null;scene;context;damageEnemy;stats;constructor(e,t,s,a){this.scene=e,this.context=t,this.stats=s,this.damageEnemy=a}update(e,t,s){this.activeSwordSwing&&this.updateActiveSwordSwing(e,t);const a=this.context.hero;if(a.hp<=0||(this.swordElapsed+=e,this.activeSwordSwing)||this.swordElapsed<this.stats.cooldown)return;const i=a.direction;if(!i||i.lengthSq()<1e-4)return;this.swordElapsed=0;const n=i.clone().normalize(),r={prepGfx:null,strikeGfx:null,angleDeg:c.Math.RadToDeg(Math.atan2(n.y,n.x)),prepRemaining:xe,strikeRemaining:fe,hitEnemies:new Set,cleanup:()=>{r.cleaned||(r.cleaned=!0,this.scene.events.off(c.Scenes.Events.POST_UPDATE,r.followHero),this.scene.events.off(c.Scenes.Events.SHUTDOWN,r.cleanup),r.prepGfx?.destroy(),r.strikeGfx?.destroy(),this.activeSwordSwing===r&&(this.activeSwordSwing=null))},followHero:()=>{const l=this.context.hero.sprite;r.prepGfx?.setPosition(l.x,l.y),r.strikeGfx?.setPosition(l.x,l.y)},cleaned:!1};this.scene.events.on(c.Scenes.Events.POST_UPDATE,r.followHero),this.scene.events.once(c.Scenes.Events.SHUTDOWN,r.cleanup),this.activeSwordSwing=r,this.spawnPrepGraphics(r)}reset(){this.swordElapsed=0,this.activeSwordSwing&&(this.activeSwordSwing.cleanup(),this.activeSwordSwing=null)}updateActiveSwordSwing(e,t){const s=this.activeSwordSwing;if(!s)return;let a=e;if(s.prepRemaining>0){const o=this.context.hero.direction;o&&o.lengthSq()>1e-4&&(s.angleDeg=c.Math.RadToDeg(Math.atan2(o.y,o.x)),this.updatePrepGraphics(s));const r=Math.min(s.prepRemaining,a);if(s.prepRemaining-=r,a-=r,s.prepRemaining<=0&&!s.strikeGfx&&this.beginStrikePhase(s),a<=0)return}else s.strikeGfx||this.beginStrikePhase(s);if(s.strikeRemaining-=a,s.strikeRemaining<=0){s.cleanup(),this.activeSwordSwing=null;return}const n=this.context.hero.sprite;for(const o of t){if(s.hitEnemies.has(o))continue;const r=o.getData("mob");if(!o.active||!r)continue;const l=o.x-n.x,p=o.y-n.y;if(Math.hypot(l,p)>this.stats.area+r.size/2)continue;const g=c.Math.RadToDeg(Math.atan2(p,l)),u=c.Math.Angle.ShortestBetween(s.angleDeg,g);Math.abs(u)>this.stats.sectorAngle/2||(s.hitEnemies.add(o),this.damageEnemy(o,this.stats.damage,r))}}spawnPrepGraphics(e){const t=this.context.hero.sprite,s=this.scene.add.graphics({x:t.x,y:t.y});s.setDepth(-.35),s.setAlpha(.8),s.fillStyle(16777215,.5),s.beginPath();const a=c.Math.DegToRad(this.stats.sectorAngle/2);s.slice(0,0,this.stats.area,-a,a,!1),s.fillPath(),s.setScale(.25),s.rotation=c.Math.DegToRad(e.angleDeg),e.prepGfx=s,e.followHero(),this.scene.tweens.add({targets:s,scaleX:1,scaleY:1,alpha:.1,ease:"Sine.easeOut",duration:xe*1e3})}updatePrepGraphics(e){const t=e.prepGfx;!t||e.cleaned||(t.rotation=c.Math.DegToRad(e.angleDeg))}beginStrikePhase(e){e.prepGfx?.destroy(),e.prepGfx=null;const t=this.context.hero.sprite,s=this.scene.add.graphics({x:t.x,y:t.y});s.setDepth(-.3),s.setAlpha(.6),s.fillStyle(16766287,.35),s.beginPath();const a=c.Math.DegToRad(this.stats.sectorAngle/2);s.slice(0,0,this.stats.area,-a,a,!1),s.fillPath(),s.rotation=c.Math.DegToRad(e.angleDeg),e.strikeGfx=s,e.followHero(),this.scene.tweens.add({targets:s,alpha:0,scale:1.05,duration:fe*1e3,onComplete:()=>e.cleanup()})}}class je{id=()=>"bomb";bombElapsed;bombs=[];scene;context;stats;damageEnemy;constructor(e,t,s,a){this.scene=e,this.context=t,this.stats=s,this.damageEnemy=a,this.bombElapsed=this.stats.cooldown}update(e,t,s){for(this.bombElapsed+=e;this.bombElapsed>=this.stats.cooldown;)this.bombElapsed-=this.stats.cooldown,this.spawnBomb(this.stats);const a=this.scene.time.now;this.bombs=this.bombs.filter(i=>{if(!i.sprite.active)return i.sprite.destroy(),!1;const{detonateAt:n}=i,o=n-a,r=we;if(o<=0)return this.detonateBomb(i,t),!1;const l=1-o/r;return i.sprite.setAlpha(.6+Math.sin(l*Math.PI*4)*.2),!0})}spawnBomb(e){const{sprite:t}=this.context.hero,s=this.scene.add.image(t.x,t.y,S.key,x.bomb);s.setDepth(-.5),s.setDisplaySize(O,O),s.setTint(16740419),s.setAlpha(.9);const a=this.scene.time.now+we;this.bombs.push({sprite:s,detonateAt:a,weapon:e})}detonateBomb(e,t){const{sprite:s,weapon:a}=e,i=this.scene.add.circle(s.x,s.y,a.area,16755520,.35);i.setDepth(-.4),this.scene.tweens.add({targets:i,alpha:0,scale:1.4,duration:320,onComplete:()=>i.destroy()});const n=a.area,o=a.damage;for(const r of t){const l=r.getData("mob");if(!r.active||!l)continue;c.Math.Distance.Between(s.x,s.y,r.x,r.y)<=n+l.size/2&&this.damageEnemy(r,o,l)}s.destroy()}reset(){this.bombElapsed=0,this.bombs.forEach(e=>e.sprite.destroy()),this.bombs=[]}}const we=2e3;class Xe{id=()=>"aura";scene;context;stats;damageEnemy;constructor(e,t,s,a){this.scene=e,this.context=t,this.stats=s,this.damageEnemy=a}update(e,t,s){t.forEach(a=>{const i=a.getData("mob");if(!a.active||!i)return!1;const n=this.context.hero.sprite.x-a.x,o=this.context.hero.sprite.y-a.y,r=Math.hypot(n,o)||.001;this.applyAuraDamage(a,r,i)})}applyAuraDamage(e,t,s){if(t>this.stats.area+s.size/2)return!1;const a=this.scene.time.now,i=e.getData("lastAuraTick"),n=this.stats.cooldown*1e3;if(i&&a-i<n)return!1;e.setData("lastAuraTick",a),this.damageEnemy(e,this.stats.damage,s);const o=this.context.hero.sprite,r=e.x-o.x,l=e.y-o.y,p=Math.hypot(r,l)||1,d=e.getData("auraKnockback")??40,g=Math.max(d/2,5);e.setData("auraKnockback",g),e.x+=r/p*d,e.y+=l/p*d;const u=e.getData("hpText");u?.active&&u.setPosition(e.x,e.y-s.size/2-8)}reset(){}}class Ke{id=()=>"pistol";scene;context;stats;damageEnemy;bullets=[];shootElapsed=0;constructor(e,t,s,a){this.scene=e,this.context=t,this.stats=s,this.damageEnemy=a}update(e,t,s){this.bullets=this.bullets.filter(a=>{const i=a.sprite;if(!i.active)return!1;if(i.x+=a.vx*e,i.y+=a.vy*e,i.x<s.left-_||i.x>s.right+_||i.y<s.top-_||i.y>s.bottom+_)return i.destroy(),!1;for(const n of t){const o=n.getData("mob");if(!(!n.active||!o)&&!a.hitEnemies.has(n)&&c.Math.Distance.Between(i.x,i.y,n.x,n.y)<o.size/2+a.radius&&(a.hitEnemies.add(n),this.damageEnemy(n,this.stats.damage,o),i.x+=a.vx*e*.3,i.y+=a.vy*e*.3,a.piercesLeft-=1,a.piercesLeft<=0))return i.destroy(),!1}return!0}),this.context.hero.hp>0&&this.tickAutoFire(e)}tickAutoFire(e){if(!this.context.getEnemies().some(g=>g.active)||(this.shootElapsed+=e,this.shootElapsed<this.stats.cooldown))return;this.shootElapsed=0;const s=this.findNearestEnemy();if(!s)return;const{sprite:a}=this.context.hero,i=s.x-a.x,n=s.y-a.y,o=Math.hypot(i,n);if(!o)return;const r=this.stats.area,l=this.scene.add.circle(a.x,a.y,r,11184810),p=i/o*ye,d=n/o*ye;this.bullets.push({sprite:l,vx:p,vy:d,radius:r,piercesLeft:this.stats.pierce,hitEnemies:new Set})}findNearestEnemy(){const{sprite:e}=this.context.hero,t=this.context.getEnemies();let s,a=Number.POSITIVE_INFINITY;for(const i of t){if(!i.active)continue;const n=c.Math.Distance.Between(e.x,e.y,i.x,i.y);n<a&&(s=i,a=n)}return s}reset(){this.bullets.forEach(e=>e.sprite.destroy()),this.bullets=[],this.shootElapsed=0}}const ye=G*3,le={weapon_damage:{}};class qe{scene;context;weapons=[];originalStats={};constructor(e,t){this.scene=e,this.context=t}reset(){this.weapons.forEach(e=>e.reset())}update(e,t){const s=this.context.getEnemies();this.weapons.forEach(a=>a.update(e,s,t))}refreshWeapons(){this.setPistolWeapon(this.originalStats.pistol??null),this.setBombWeapon(this.originalStats.bomb??null),this.setSwordWeapon(this.originalStats.sword??null),this.setAuraWeapon(this.originalStats.aura??null)}damageEnemy(e,t,s){if(!e.active)return!1;const i=(e.getData("hp")??s.health)-t;e.setData("hp",i);const n=e.getData("hpText");return n?.active&&n.setText(`${Math.max(i,0)}`),i<=0?(this.context.onEnemyKilled(e,s),e.setActive(!1),e.destroy(),!0):!1}setPistolWeapon(e){if(!e){this.unsetWeapon("pistol");return}this.originalStats.pistol=e;const t=this.withModifiers(e);this.setWeapon(new Ke(this.scene,this.context,t,this.damageEnemyWithStats("pistol")))}damageEnemyWithStats=e=>(t,s,a)=>{le.weapon_damage[e]=(le.weapon_damage[e]??0)+s,this.damageEnemy(t,s,a)};setAuraWeapon(e){if(!e){this.unsetWeapon("aura");return}this.originalStats.aura=e;const t=this.withModifiers(e);this.setWeapon(new Xe(this.scene,this.context,t,this.damageEnemyWithStats("aura")))}setBombWeapon(e){if(!e){this.unsetWeapon("bomb");return}this.originalStats.bomb=e;const t=this.withModifiers(e);this.setWeapon(new je(this.scene,this.context,t,this.damageEnemyWithStats("bomb")))}setSwordWeapon(e){if(!e){this.unsetWeapon("sword");return}this.originalStats.sword=e;const t=this.withModifiers(e);this.setWeapon(new Ve(this.scene,this.context,t,this.damageEnemyWithStats("sword")))}setWeapon(e){const t=this.weapons.findIndex(s=>s.id()===e.id());t>=0?(this.weapons[t].reset(),this.weapons[t]=e):this.weapons.push(e),e.reset()}unsetWeapon(e){const t=this.weapons.findIndex(s=>s.id()===e);t>=0&&(this.weapons[t].reset(),this.weapons.splice(t,1),this.originalStats[e]=void 0)}withModifiers(e){const t=this.context.hero,s=t.areaMultiplier,a=t.damageMultiplier;return D({...e,area:e.area*s,damage:e.damage*a})}}const I=68,Ye=4;function $e(h){const e=h.input.keyboard.createCursorKeys(),t=new c.Math.Vector2,s=new c.Math.Vector2;let a,i,n;const o=46,r=20,l=()=>{a&&i||(a=h.add.circle(120,h.scale.height-120,o,16777215,.1),a.setStrokeStyle(2,16777215,.35),a.setScrollFactor(0),a.setDepth(5),a.setVisible(!1),i=h.add.circle(a.x,a.y,r,16777215,.35),i.setScrollFactor(0),i.setDepth(6),i.setVisible(!1))},p=()=>{n=void 0,t.set(0,0),a&&i&&(i.setPosition(a.x,a.y),a.setVisible(!1),i.setVisible(!1))},d=m=>{n===void 0&&m.primaryDown&&(l(),!(!a||!i)&&(n=m.id,a.setPosition(m.x,m.y),i.setPosition(m.x,m.y),a.setVisible(!0),i.setVisible(!0),t.set(0,0)))},g=m=>{if(n!==m.id||!a||!i)return;const v=m.x-a.x,b=m.y-a.y,A=Math.hypot(v,b);if(A<=I)i.setPosition(m.x,m.y),t.set(v/I,b/I);else{const L=Math.atan2(b,v),U=Math.cos(L)*I,R=Math.sin(L)*I;i.setPosition(a.x+U,a.y+R),t.set(U/I,R/I)}A<Ye&&t.set(0,0)},u=m=>{n===m.id&&p()};return h.input.on("pointerdown",d),h.input.on("pointermove",g),h.input.on("pointerup",u),h.input.on("pointerupoutside",u),{cursors:e,getDirection(){s.copy(t),e.left.isDown&&(s.x-=1),e.right.isDown&&(s.x+=1),e.up.isDown&&(s.y-=1),e.down.isDown&&(s.y+=1);const m=s.length();return m>1&&s.scale(1/m),s.clone()},destroy(){p(),h.input.off("pointerdown",d),h.input.off("pointermove",g),h.input.off("pointerup",u),h.input.off("pointerupoutside",u),a?.destroy(),i?.destroy(),a=void 0,i=void 0,n=void 0}}}const Je=O*4,Ze=O,Me=G*1.5,be=100,T=O*.5;class Qe{scene;crystals=[];constructor(e){this.scene=e}spawn(e,t,s){const a=Math.max(1,Math.round(s)),i=c.Math.FloatBetween(-6,6),n=c.Math.FloatBetween(-6,6),o=this.scene.add.polygon(e+i,t+n,[0,-T,T,0,0,T,-T,0],6600182,.7);o.setOrigin(.5),o.setDepth(-.2),o.setStrokeStyle(1.2,16777215,.5),o.setData("xp",a),o.setData("baseSize",T),o.setData("magnetized",!1),o.setData("magnetSpeed",Me),this.updateCrystalVisual(o),this.crystals.push(o)}update(e,t,s,a){const i=c.Math.Clamp(this.scene.game.loop.delta,8,48)/1e3;this.crystals=this.crystals.filter(n=>{if(!n.active)return n.destroy(),!1;n.getData("magnetized")||c.Math.Distance.Between(n.x,n.y,e,t)<=Je&&n.setData("magnetized",!0);const r=n.getData("magnetized");if(r){const p=n.getData("magnetSpeed")??Me,d=e-n.x,g=t-n.y,u=Math.hypot(d,g)||1e-4,m=p*i;n.x+=d/u*m,n.y+=g/u*m}const l=c.Math.Distance.Between(n.x,n.y,e,t);if(r&&l<=Ze){const p=Math.max(1,Math.round(n.getData("xp")??0));return n.destroy(),p>0&&a(p),!1}return!0}),this.mergeOutOfBounds(s,e,t)}destroyAll(){this.crystals.forEach(e=>e.destroy()),this.crystals=[]}activateMagnet(){this.crystals.forEach(e=>{e.active&&e.setData("magnetized",!0)})}mergeOutOfBounds(e,t,s){if(this.crystals.length<=be)return;const a=_;let i=0;for(;this.crystals.length>be&&i<20;){const n=this.crystals.filter(d=>d.x<e.left-a||d.x>e.right+a||d.y<e.top-a||d.y>e.bottom+a);if(n.length<2)break;n.sort((d,g)=>{const u=c.Math.Distance.Between(t,s,d.x,d.y);return c.Math.Distance.Between(t,s,g.x,g.y)-u});const o=n[0],r=n[1];if(!o.active||!r.active){[o,r].forEach(d=>{d.active||(d.destroy(),this.crystals=this.crystals.filter(g=>g!==d))}),i+=1;continue}const l=Math.max(0,Math.round(o.getData("xp")??0)),p=Math.max(0,Math.round(r.getData("xp")??0));o.setData("xp",l+p),o.setPosition((o.x+r.x)/2,(o.y+r.y)/2),this.updateCrystalVisual(o),r.destroy(),this.crystals=this.crystals.filter(d=>d!==r),i+=1}}updateCrystalVisual(e){const t=e.getData("xp")??0,s=e.getData("baseSize")??T,a=c.Math.Clamp(6+Math.sqrt(t)*1.1,6,28),i=a/s;e.setScale(i),e.setData("radius",a);const n=c.Math.Clamp(.45+t/180,.45,.9);e.setFillStyle(6600182,n),e.setStrokeStyle(1.2,16777215,.45+Math.min(.4,t/120))}}class et{scene;enemies;spawnBuffer=H*6;constructor(e,t){this.scene=e,this.enemies=t}spawn(e,t,s){const a=t.size/2,{x:i,y:n}=this.findSpawnPosition(e,a),o=s.frame??x.mobWalk1,r=this.scene.add.sprite(i,n,S.key,o);return r.setOrigin(.5),r.setDisplaySize(t.size,t.size),r.setTint(s.color),r.setDepth(.1),r.setActive(!0),r.setData("mob",t),r.setData("hp",t.health),r.setData("lastHit",0),r.setData("lastAuraTick",0),r.setData("auraKnockback",40),r.setData("radius",a),!s.frame&&this.scene.anims.exists("enemy-walk")&&(r.play("enemy-walk"),r.anims.setProgress(Math.random())),this.enemies.push(r),this.attachHpLabel(r,t),r}attachHpLabel(e,t){k.create(this.scene,e,t)}resolveOverlaps(){for(let e=0;e<this.enemies.length;e+=1){const t=this.enemies[e];if(!t.active)continue;const s=t.getData("mob");if(!s)continue;const a=s.size/2;for(let i=e+1;i<this.enemies.length;i+=1){const n=this.enemies[i];if(!n.active)continue;const o=n.getData("mob");if(!o)continue;const r=o.size/2,l=n.x-t.x,p=n.y-t.y,d=Math.hypot(l,p),g=a+r+2;if(d===0){const u=c.Math.FloatBetween(0,Math.PI*2);t.x+=Math.cos(u),t.y+=Math.sin(u),n.x-=Math.cos(u),n.y-=Math.sin(u),k.update(t,s),k.update(n,o);continue}if(d<g){const u=(g-d)/2,m=l/d,v=p/d;t.x-=m*u,t.y-=v*u,n.x+=m*u,n.y+=v*u,k.update(t,s),k.update(n,o)}}}}update(e,t,s,a){return this.enemies=this.enemies.filter(i=>this.updateEnemyState(i,e,t,s,a)),this.enemies}updateEnemyState(e,t,s,a,i){const n=e.getData("mob");if(!e.active||!n)return!1;const o=this.moveEnemyTowardsHero(e,n,t,s);return k.update(e,n),o<t.radius+n.size/2&&i(e,n),this.shouldCullEnemy(e,n.size/2,a)?(e.destroy(),!1):e.active}moveEnemyTowardsHero(e,t,s,a){const i=s.sprite.x-e.x,n=s.sprite.y-e.y,o=Math.hypot(i,n)||.001,r=t.speed;return e.x+=i/o*r*a,e.y+=n/o*r*a,i!==0&&e.setFlipX(i<0),o}shouldCullEnemy(e,t,s){const a=_+t;return e.x<s.left-a||e.x>s.right+a||e.y<s.top-a||e.y>s.bottom+a}findSpawnPosition(e,t){const a=this.scene.cameras.main.worldView;let i={x:a.centerX,y:a.y};const n=12;for(let o=0;o<n;o+=1){let r=0,l=0;switch(e){case 0:r=a.centerX+c.Math.FloatBetween(-a.width/2,a.width/2),l=a.top-this.spawnBuffer;break;case 1:r=a.right+this.spawnBuffer,l=a.centerY+c.Math.FloatBetween(-a.height/2,a.height/2);break;case 2:r=a.centerX+c.Math.FloatBetween(-a.width/2,a.width/2),l=a.bottom+this.spawnBuffer;break;default:r=a.left-this.spawnBuffer,l=a.centerY+c.Math.FloatBetween(-a.height/2,a.height/2);break}if(r+=c.Math.FloatBetween(-t,t),l+=c.Math.FloatBetween(-t,t),i={x:r,y:l},this.isPositionClear(r,l,t))break}return i}isPositionClear(e,t,s){for(const i of this.enemies){if(!i.active)continue;const n=i.getData("mob");if(!n)continue;const o=n.size/2;if(c.Math.Distance.Between(e,t,i.x,i.y)<s+o+6)return!1}return!0}}class k{static DATA_KEY="hpText";static create(e,t,s){const a=e.add.text(t.x,t.y,`${s.health}`,{color:"#ffffff",fontFamily:"monospace",fontSize:"12px"}).setOrigin(.5).setDepth(1);t.setData(k.DATA_KEY,a),t.once("destroy",()=>a.destroy()),k.update(t,s)}static update(e,t){const s=k.get(e);s?.active&&s.setPosition(e.x,e.y-t.size/2-8)}static get(e){return e.getData(k.DATA_KEY)}}class tt{scene;enemyManager;hooks;wave=0;running=!1;waveTimer;constructor(e,t,s){this.scene=e,this.enemyManager=t,this.hooks=s}start(){this.running||(this.running=!0,this.spawnWave(),this.waveTimer=this.scene.time.addEvent({delay:5e3,callback:this.spawnWave,callbackScope:this,loop:!0,startAt:0}))}stop(){this.running&&(this.running=!1,this.waveTimer?.remove(),this.waveTimer=void 0,this.wave=0)}isRunning(){return this.running}destroy(){this.stop()}spawnWave=()=>{if(!this.hooks.getHero())return;if(this.wave+=1,Se.length<=this.wave){this.gameover();return}this.hooks.onWaveAdvanced(this.wave);const t=Se[this.wave],s=c.Math.Between(0,3);for(const a of t.mobs){const i=a.amount,n=a.stats,o=a.appearance;for(let r=0;r<i;r+=1){if(r<i*.1){this.spawnEnemy(s+1,n,o);continue}if(r<i*.2){this.spawnEnemy(s+2,n,o);continue}if(r<i*.5){this.spawnEnemy(s+3,n,o);continue}this.spawnEnemy(s,n,o)}}};spawnEnemy(e,t,s){e=e%4,this.enemyManager.spawn(e,t,s)}gameover(){this.stop(),this.scene.game.events.emit("wavesOver")}}const w={default:{frame:x.mobWalk1,color:5292096},strong:{frame:x.enemy1,color:12603456},elite:{frame:x.enemy2,color:7389200},reaper:{frame:x.scull,color:13643840}},y={default:{size:H*2,speed:ne,health:re,xp:j,damage:he},strong:{size:H*2.5,speed:ne,health:re*3,xp:j*2,damage:he*1.5},elite:{size:H*3,speed:ne,health:re*5,xp:j*4,damage:he*2.5},reaper:{size:H*3,speed:G*2,health:1e4,xp:0,damage:C/2}},Se=[...ce(3,{mobs:[{stats:y.default,appearance:w.default,amount:M}]}),{mobs:[{stats:y.default,appearance:w.default,amount:M},{stats:y.strong,appearance:w.strong,amount:M/5}]},{mobs:[{stats:y.default,appearance:w.default,amount:M},{stats:y.strong,appearance:w.strong,amount:M/4}]},{mobs:[{stats:y.default,appearance:w.default,amount:M},{stats:y.strong,appearance:w.strong,amount:M/3}]},{mobs:[{stats:y.default,appearance:w.default,amount:M},{stats:y.strong,appearance:w.strong,amount:M/2}]},{mobs:[{stats:y.default,appearance:w.default,amount:M},{stats:y.strong,appearance:w.strong,amount:M}]},{mobs:[{stats:y.default,appearance:w.default,amount:M},{stats:y.strong,appearance:w.strong,amount:M},{stats:y.elite,appearance:w.elite,amount:M/4}]},...ce(13,{mobs:[{stats:y.strong,appearance:w.strong,amount:M},{stats:y.elite,appearance:w.elite,amount:M/2}]}),...ce(3,{mobs:[{stats:y.default,appearance:w.default,amount:1}]}),{mobs:[{stats:y.reaper,appearance:w.reaper,amount:3}]}];function ce(h,e){const t=[];for(let s=0;s<h;s+=1)t.push(e);return t}class st{scene;hero;combat;hooks;overlay=[];active=!1;constructor(e,t,s,a){this.scene=e,this.hero=t,this.combat=s,this.hooks=a}isActive(){return this.active}openMenu(){if(this.active)return!0;const e=this.getAvailableUpgrades();if(!e.length)return!1;this.active=!0,this.hooks.onMenuOpened(),this.clearOverlay();const{width:t,height:s}=this.scene.scale,a=t/2,i=s/2,n=Math.min(t-80,420),o=84,r=e.length*o+140,l=this.scene.add.rectangle(a,i,t,s,0,.55).setScrollFactor(0).setDepth(10).setInteractive();this.overlay.push(l);const p=this.scene.add.rectangle(a,i,n,r,2302778,.96).setScrollFactor(0).setDepth(11).setStrokeStyle(2,16771899,.5);this.overlay.push(p);const g=this.scene.add.text(a,i-r/2+40,"Choose Upgrade",{color:"#ffe082",fontFamily:"monospace",fontSize:"22px"}).setOrigin(.5).setScrollFactor(0).setDepth(12);return this.overlay.push(g),e.forEach((u,m)=>{const v=i-r/2+88+m*o,b=this.scene.add.text(a,v,u.label,{color:"#f5f5f5",fontFamily:"monospace",fontSize:"20px",backgroundColor:"#30304a",padding:{x:16,y:10}}).setOrigin(.5).setScrollFactor(0).setDepth(12).setInteractive({useHandCursor:!0});b.on("pointerover",()=>b.setStyle({backgroundColor:"#3d3d5c"})),b.on("pointerout",()=>b.setStyle({backgroundColor:"#30304a"})),b.on("pointerdown",()=>this.applyUpgrade(u.id)),this.overlay.push(b);const A=this.scene.add.text(a,v+28,u.description,{color:"#b0bec5",fontFamily:"monospace",fontSize:"16px"}).setOrigin(.5,0).setScrollFactor(0).setDepth(12);this.overlay.push(A)}),!0}destroy(){this.clearOverlay()}applyUpgrade(e){switch(this.hero.upgrades.includes(e)||this.hero.upgrades.push(e),e){case"aura":this.handleAuraUpgrade(pe,"Aura weapon activated!");break;case"auraMk2":this.handleAuraUpgrade(Y,"Aura Mk II empowered!");break;case"auraMk3":this.handleAuraUpgrade($,"Aura Mk III intensified!");break;case"auraMk4":this.handleAuraUpgrade(J,"Aura Mk IV radiates farther!");break;case"auraMk5":this.handleAuraUpgrade(Ae,"Aura Mk V unleashed!");break;case"pistol":this.handlePistolUpgrade(de,"Pistol ready!");break;case"pistolMk2":this.handlePistolUpgrade(X,"Pistol Mk II ready!");break;case"pistolMk3":this.handlePistolUpgrade(K,"Pistol Mk III ready!");break;case"pistolMk4":this.handlePistolUpgrade(q,"Pistol Mk IV ready!");break;case"pistolMk5":this.handlePistolUpgrade(ke,"Pistol Mk V ready!");break;case"bomb":this.handleBombUpgrade(ue,"Bomb launcher deployed!");break;case"bombMk2":this.handleBombUpgrade(Z,"Bombs Mk II primed!");break;case"bombMk3":this.handleBombUpgrade(Oe,"Bombs Mk III unleashed!");break;case"sword":this.handleSwordUpgrade(ge,"Sword technique mastered!");break;case"swordMk2":this.handleSwordUpgrade(Q,"Sword Mk II swings wider!");break;case"swordMk3":this.handleSwordUpgrade(ee,"Sword Mk III hits harder!");break;case"swordMk4":this.handleSwordUpgrade(te,"Sword Mk IV extends reach!");break;case"swordMk5":this.handleSwordUpgrade(De,"Sword Mk V slices everything!");break;case"area1":this.applyAreaUpgrade();break;case"damage1":this.applyDamageUpgrade();break}this.hooks.onUpgradeApplied(),this.closeMenu()}closeMenu(){this.clearOverlay(),this.active=!1,this.hooks.onMenuClosed()}clearOverlay(){this.overlay.forEach(e=>e.destroy()),this.overlay=[]}getAvailableUpgrades(){const e=this.hero.weaponIds.length===0,t=me.filter(o=>this.hero.upgrades.includes(o.id)||!(o.requires?.every(r=>this.hero.upgrades.includes(r))??!0)||o.weaponId&&o.level&&o.level>1&&!!!this.hero.upgrades.find(l=>{const p=me.find(d=>d.id===l);return p?.level===o.level-1&&p.weaponId===o.weaponId})?!1:e?o.category==="WEAPON_NEW":!0);function s(o){return o.length>0?o[c.Math.Between(0,o.length-1)]:null}const a=s(t.filter(o=>o.category==="WEAPON_UPGRADE"))??s(t.filter(o=>o.category==="WEAPON_NEW"))??s(t),i=s(t.filter(o=>o.category==="PASSIVE_UPGRADE"))??s(t.filter(o=>o.category==="PASSIVE_NEW"))??s(t.filter(o=>o.id!==a?.id)),n=s(t.filter(o=>o.id!==a?.id&&o.id!==i?.id));return[a,i,n].filter(o=>o)}handleAuraUpgrade(e,t){this.hero.hasAura=!0,this.hero.weaponIds.includes("aura")||this.hero.weaponIds.push("aura"),this.hero.aura.setVisible(!0),this.hero.aura.setRadius(e.area*this.hero.areaMultiplier),this.combat.setAuraWeapon(e),this.hooks.onShowMessage(t)}handlePistolUpgrade(e,t){this.hero.weaponIds.includes("pistol")||this.hero.weaponIds.push("pistol"),this.combat.setPistolWeapon(e),this.hooks.onShowMessage(t)}handleBombUpgrade(e,t){this.hero.weaponIds.includes("bomb")||this.hero.weaponIds.push("bomb"),this.combat.setBombWeapon(e),this.hooks.onShowMessage(t)}handleSwordUpgrade(e,t){this.hero.weaponIds.includes("sword")||this.hero.weaponIds.push("sword"),this.combat.setSwordWeapon(e),this.hooks.onShowMessage(t)}applyAreaUpgrade(){this.hero.areaMultiplier*=1.1,this.combat.refreshWeapons(),this.hooks.onShowMessage("Area increased by 10%!")}applyDamageUpgrade(){this.hero.damageMultiplier*=1.1,this.combat.refreshWeapons(),this.hooks.onShowMessage("Damage increased by 10%!")}}const at=C*.3,z={duration:100,r:120,g:200,b:255},V={duration:100,r:80,g:180,b:255},B=H*3;class it{scene;xpManager;hooks;healPacks=[];magnetPickups=[];constructor(e,t,s){this.scene=e,this.xpManager=t,this.hooks=s}spawnHealPack(e){const t=c.Math.FloatBetween(e.left+B,e.right-B),s=c.Math.FloatBetween(e.top+B,e.bottom-B),a=O,i=this.scene.add.image(t,s,S.key,x.healPotion);i.setDisplaySize(a,a),i.setTint(15753280),i.setData("radius",a/2),this.healPacks.push(i)}spawnMagnetPickup(e){if(this.magnetPickups.some(n=>n.active))return;const t=c.Math.FloatBetween(e.left+B,e.right-B),s=c.Math.FloatBetween(e.top+B,e.bottom-B),a=O,i=this.scene.add.image(t,s,S.key,x.portalOpens);i.setDisplaySize(a,a),i.setTint(4367861),i.setData("radius",a/2),i.setDepth(.2),this.magnetPickups.push(i)}update(e){const t=this.hooks.getHero(),s=t.sprite,a=t.radius,i=s.x,n=s.y;this.healPacks=this.healPacks.filter(o=>{if(!o.active)return o.destroy(),!1;const r=o.getData("radius")??O/2;return c.Math.Distance.Between(o.x,o.y,i,n)<r+a?(this.collectHealPack(o),!1):this.isOutOfBounds(o.x,o.y,e)?(o.destroy(),!1):!0}),this.magnetPickups=this.magnetPickups.filter(o=>{if(!o.active)return o.destroy(),!1;const r=o.getData("radius")??O/2;return c.Math.Distance.Between(o.x,o.y,i,n)<r+a?(this.collectMagnetPickup(o),!1):this.isOutOfBounds(o.x,o.y,e)?(o.destroy(),!1):!0})}destroy(){this.healPacks.forEach(e=>e.destroy()),this.healPacks=[],this.magnetPickups.forEach(e=>e.destroy()),this.magnetPickups=[]}collectHealPack(e){const t=this.hooks.getHero();ze(t,at),this.scene.cameras.main.flash(V.duration,V.r,V.g,V.b,!1),e.destroy(),this.hooks.onHeroHealed()}collectMagnetPickup(e){this.xpManager.activateMagnet(),this.scene.cameras.main.flash(z.duration,z.r,z.g,z.b,!1),e.destroy(),this.hooks.onMagnetActivated()}isOutOfBounds(e,t,s){const a=_;return e<s.left-a||e>s.right+a||t<s.top-a||t>s.bottom+a}}class se extends c.GameObjects.Container{static frames={sword:x.sword1,pistol:x.pistol1,bomb:x.bomb,aura:x.aura};static upgradeChains={aura:["aura","auraMk2","auraMk3","auraMk4","auraMk5"],pistol:["pistol","pistolMk2","pistolMk3","pistolMk4","pistolMk5"],bomb:["bomb","bombMk2","bombMk3"],sword:["sword","swordMk2","swordMk3","swordMk4","swordMk5"]};hero;infoText;constructor(e,t,s){super(e,16,t.y+t.height+12),this.hero=s,this.infoText=t,this.setDepth(2),this.setScrollFactor(0),e.add.existing(this)}refresh(){this.removeAll(!0),this.setPosition(16,this.infoText.y+this.infoText.height+12);const e=20;this.hero.weaponIds.forEach((t,s)=>{const a=se.frames[t];if(a===void 0)return;const i=this.getWeaponLevel(t),n=new c.GameObjects.Container(this.scene,s*e*1.5,0),o=new c.GameObjects.Rectangle(this.scene,0,0,e,e,1710635,.65).setOrigin(0).setStrokeStyle(1,16777215,.2),u=i===1?16777215:i===2?16777045:i===3?5635925:i===4?5592575:16733525,m=new c.GameObjects.Sprite(this.scene,e/2,e/2,S.key,a).setOrigin(.5).setDisplaySize(e,e).setTint(u);n.add([o,m]),this.add(n)})}destroy(e){this.removeAll(!0),super.destroy(e)}getWeaponLevel(e){const t=se.upgradeChains[e];if(!t)return 1;for(let s=t.length-1;s>=0;s-=1)if(this.hero.upgrades.includes(t[s]))return s+1;return 1}}class ve{container;scene;constructor(e){this.scene=e}show(e,t,s,a){const i=e==="killed"?"Game Over":"Complete",n=e==="killed"?"#ff5252":"#69f0ae",{width:o,height:r}=this.scene.scale;this.clear();const l=this.scene.add.container(o/2,r/2).setScrollFactor(0).setDepth(6),p=this.scene.add.text(0,-96,i,{color:n,fontFamily:"monospace",fontSize:"36px",backgroundColor:"#1a1a25ee",padding:{x:18,y:10}}).setOrigin(.5),d=this.scene.add.text(0,-32,`Wave ${t} | Kills ${s}`,{color:"#f5f5f5",fontFamily:"monospace",fontSize:"20px",backgroundColor:"#1a1a25cc",padding:{x:14,y:6}}).setOrigin(.5);l.add([p,d]);const g=this.createDamageTable(d.y+d.height/2+32);let u=d.y+d.height/2+72;g&&(l.add(g),u=g.y+(g.height??0)/2+32);const m=this.scene.add.text(0,u,"Exit",{color:"#ff8a80",fontFamily:"monospace",fontSize:"18px",backgroundColor:"#303048dd",padding:{x:10,y:6}}).setOrigin(.5).setScrollFactor(0).setInteractive({useHandCursor:!0});m.on("pointerdown",()=>a()),l.add(m),this.container=l}clear(){this.container?.destroy(),this.container=void 0}createDamageTable(e){const t=Object.entries(le.weapon_damage??{});if(!t.length)return;t.sort((g,u)=>(u[1]??0)-(g[1]??0));const s=320,a=16,i=40,n=28,o=t.length,r=a*2+n+o*i,l=this.scene.add.container(0,e+r/2).setScrollFactor(0);l.setSize(s,r);const p=this.scene.add.rectangle(0,0,s,r,1118495,.92).setOrigin(.5).setStrokeStyle(1,16777215,.2);l.add(p);const d=this.scene.add.text(0,-r/2+a,"Damage dealt",{color:"#f5f5f5",fontFamily:"monospace",fontSize:"18px"}).setOrigin(.5,0);return l.add(d),t.forEach(([g,u],m)=>{const v=Math.round(u??0),b=-r/2+a+n+m*i,A=b+i/2,L=this.scene.add.rectangle(0,A,s-a*2,i-6,16777215,.05).setOrigin(.5);l.add(L);const U=28,R=nt(this.scene,g);R.setPosition(-s/2+a,b+(i-U)/2),l.add(R);const Te=this.scene.add.text(-s/2+a+U+12,A,v.toLocaleString(),{color:"#ffffff",fontFamily:"monospace",fontSize:"18px"}).setOrigin(0,.5);l.add(Te)}),l}}const ot={sword:x.sword1,pistol:x.pistol1,bomb:x.bomb,aura:x.aura};function nt(h,e){const t=h.add.container(0,0).setSize(20,20),s=new c.GameObjects.Rectangle(h,0,0,20,20,1710635,.65).setOrigin(0).setStrokeStyle(1,16777215,.2),a=ot[e];if(a!==void 0){const i=new c.GameObjects.Sprite(h,10,10,S.key,a).setOrigin(.5).setDisplaySize(20,20).setTint(16777215);t.add([s,i])}else{const i=new c.GameObjects.Text(h,10,10,e.slice(0,1).toUpperCase(),{color:"#e0e0e0",fontFamily:"monospace",fontSize:"12px"}).setOrigin(.5);t.add([s,i])}return t}const Be=6;class rt{width;height=Be;padding=1;bg;fill;hero;constructor(e,t){this.hero=t;const s=this.getOffsetY();this.width=t.sprite.displayWidth,this.bg=e.add.rectangle(t.sprite.x,t.sprite.y-s,this.width,this.height,0,.7).setOrigin(.5).setDepth(1),this.fill=e.add.rectangle(t.sprite.x-this.width/2+this.padding,this.bg.y,this.width-this.padding*2,this.height-this.padding*2,5025616).setOrigin(0,.5).setDepth(1.1),this.updateValue(t.hp,t.maxHp)}syncPosition(){const e=this.hero.sprite.x,t=this.hero.sprite.y+this.getOffsetY(),s=e-this.width/2+this.padding;this.bg.setPosition(e,t),this.fill.setPosition(s,t)}updateValue(e,t){const s=c.Math.Clamp(t===0?0:e/t,0,1),a=Math.max(0,this.width-this.padding*2);this.fill.displayWidth=a*s,s>.6?this.fill.setFillStyle(5025616):s>.3?this.fill.setFillStyle(16761095):this.fill.setFillStyle(16732754)}destroy(){this.bg.destroy(),this.fill.destroy()}getOffsetY(){return this.hero.sprite.displayHeight/2+4}}class ht{width;height=5;padding=1;bg;fill;hero;constructor(e,t){this.hero=t;const s=this.getOffsetY();this.width=t.sprite.displayWidth,this.bg=e.add.rectangle(t.sprite.x,t.sprite.y-s,this.width,this.height,0,.7).setOrigin(.5).setDepth(1),this.fill=e.add.rectangle(t.sprite.x-this.width/2+this.padding,this.bg.y,this.width-this.padding*2,this.height-this.padding*2,2134256).setOrigin(0,.5).setDepth(1.1),this.updateValue(0)}syncPosition(){const e=this.hero.sprite.x,t=this.hero.sprite.y+this.getOffsetY(),s=e-this.width/2+this.padding;this.bg.setPosition(e,t),this.fill.setPosition(s,t)}updateValue(e){const t=c.Math.Clamp(e,0,1),s=Math.max(0,this.width-this.padding*2);this.fill.displayWidth=s*t}destroy(){this.bg.destroy(),this.fill.destroy()}getOffsetY(){return this.hero.sprite.displayHeight/2+Be}}class W extends c.Scene{static exitHandler;hero;inputController;enemies=[];background;worldBounds=Ue;heroHpBar;heroXpBar;infoText;weaponHud;kills=0;wave=0;combat;xpManager;enemyManager;waveManager;pickupManager;upgradeManager;pauseButton;pauseExitButton;isPaused=!1;totalXp=0;level=1;nextLevelXp=100;pendingLevelUps=0;currentLevelXpBase=0;supportTimersStarted=!1;pickupTimers=[];wavesOver=!1;isGameOver=!1;exitHandled=!1;gameOverHud;static registerExitHandler(e){W.exitHandler=e}preload(){this.textures.exists(S.key)||this.load.spritesheet(S.key,S.url,{frameWidth:S.frameWidth,frameHeight:S.frameHeight,spacing:S.spacing})}create(){const{width:e,height:t}=this.scale;if(this.isGameOver=!1,this.exitHandled=!1,this.gameOverHud||(this.gameOverHud=new ve(this)),this.gameOverHud.clear(),this.cameras.main.setBackgroundColor("#101014"),this.time.timeScale=1,this.isPaused=!1,!this.textures.exists("hordes-grid")){const a=this.add.graphics();a.setVisible(!1),a.fillStyle(1118493,1),a.fillRect(0,0,96,96),a.lineStyle(2,1908012,.6),a.strokeRect(0,0,96,96),a.lineStyle(1,2041148,.5),a.beginPath(),a.moveTo(48,0),a.lineTo(48,96),a.moveTo(0,48),a.lineTo(96,48),a.strokePath(),a.generateTexture("hordes-grid",96,96),a.destroy()}this.background=this.add.tileSprite(e/2,t/2,e,t,"hordes-grid"),this.background.setOrigin(.5),this.background.setScrollFactor(0),this.background.setDepth(-2),this.hero=Ge(this),this.heroHpBar=new rt(this,this.hero),this.heroXpBar=new ht(this,this.hero),this.enemies=[],this.xpManager=new Qe(this),this.pickupManager=new it(this,this.xpManager,{getHero:()=>this.hero,onHeroHealed:()=>this.updateHud(),onMagnetActivated:()=>{this.showMagnetPickup(),this.updateHud()}}),this.enemyManager=new et(this,this.enemies),this.waveManager=new tt(this,this.enemyManager,{getHero:()=>this.hero,onWaveAdvanced:a=>{this.wave=a}}),this.ensureEnemyWalkAnimation(),this.kills=0,this.wave=0,this.totalXp=0,this.level=1,this.nextLevelXp=this.getNextLevelXp(this.level),this.pendingLevelUps=0,this.currentLevelXpBase=0,this.hero.hasAura=!1,this.hero.aura.setVisible(!1),this.inputController=$e(this),this.combat=new qe(this,{hero:this.hero,getEnemies:()=>this.enemies,onEnemyKilled:(a,i)=>{this.kills+=1,this.xpManager.spawn(a.x,a.y,i.xp)}}),this.upgradeManager=new st(this,this.hero,this.combat,{onMenuOpened:()=>this.pauseForUpgrade(),onMenuClosed:()=>this.onUpgradeMenuClosed(),onUpgradeApplied:()=>this.updateHud(),onShowMessage:a=>this.showWeaponUpgrade(a)}),this.events.once(c.Scenes.Events.SHUTDOWN,()=>{this.combat.reset(),this.inputController.destroy(),this.xpManager.destroyAll(),this.upgradeManager.destroy(),this.heroHpBar.destroy(),this.heroXpBar.destroy(),this.pickupManager.destroy(),this.waveManager.destroy(),this.clearSupportTimers(),this.weaponHud?.destroy(!0)});const s=this.cameras.main;s.setBounds(-this.worldBounds,-this.worldBounds,this.worldBounds*2,this.worldBounds*2),s.startFollow(this.hero.sprite,!0,1,1),s.centerOn(0,0),this.infoText=this.add.text(16,16,"Wave 0",{color:"#f5f5f5",fontFamily:"monospace",fontSize:"18px"}).setDepth(2),this.infoText.setScrollFactor(0),this.weaponHud=new se(this,this.infoText,this.hero),this.updateHud(),this.pauseButton=this.add.text(e-16,16,"Pause",{color:"#f5f5f5",fontFamily:"monospace",fontSize:"18px",backgroundColor:"#30304888",padding:{x:8,y:4}}).setOrigin(1,0).setDepth(2).setScrollFactor(0).setInteractive({useHandCursor:!0}),this.pauseButton.on("pointerdown",()=>this.togglePause()),this.pauseExitButton=this.add.text(e-16,this.pauseButton.y+this.pauseButton.displayHeight+12,"Exit",{color:"#ff8a80",fontFamily:"monospace",fontSize:"18px",backgroundColor:"#30304888",padding:{x:8,y:4}}).setOrigin(1,0).setDepth(2).setScrollFactor(0).setInteractive({useHandCursor:!0}),this.pauseExitButton.on("pointerdown",()=>this.handleExit()),this.hidePauseHud(),this.hero.weaponIds.length===0&&(this.pendingLevelUps=Math.max(this.pendingLevelUps,1),this.tryOpenUpgradeMenu()),this.maybeStartWaves(),this.game.events.on("wavesOver",()=>this.wavesOver=!0)}update(e,t){const s=t/1e3;if(this.isPaused)return;const a=this.inputController.getDirection();Fe(this.hero,a,G,s);const i=this.cameras.main;this.background.tilePositionX=i.scrollX,this.background.tilePositionY=i.scrollY,this.heroHpBar.syncPosition(),this.heroXpBar.syncPosition();const n=this.cameras.main.worldView;this.enemies=this.enemyManager.update(this.hero,s,n,(o,r)=>{this.handleHeroHit(o,r)}),this.enemies.length===0&&this.wavesOver&&this.showGameOverHud("complete"),this.combat.update(s,n),this.xpManager.update(this.hero.sprite.x,this.hero.sprite.y,n,o=>this.awardXp(o)),this.pickupManager.update(n),this.enemyManager.resolveOverlaps()}maybeStartWaves(){this.waveManager.start(),this.startSupportTimers()}startSupportTimers(){if(this.supportTimersStarted)return;this.supportTimersStarted=!0;const e=this.time.addEvent({delay:1e4,callback:()=>this.pickupManager.spawnHealPack(this.cameras.main.worldView),loop:!0,startAt:4e3}),t=this.time.addEvent({delay:6e4,callback:()=>this.pickupManager.spawnMagnetPickup(this.cameras.main.worldView),loop:!0,startAt:0});this.pickupTimers.push(e,t)}clearSupportTimers(){this.pickupTimers.forEach(e=>e.remove()),this.pickupTimers=[],this.supportTimersStarted=!1}handleHeroHit(e,t){if(this.hero.hp<=0)return;const s=this.time.now,a=e.getData("lastHit");if(a&&s-a<1e3)return;e.setData("lastHit",s);const i=t.damage,n=Le(this.hero,i);this.cameras.main.flash(120,255,64,64,!1),this.updateHud(),n<=0&&(this.cameras.main.shake(250,.02),this.time.delayedCall(260,()=>this.showGameOverHud("killed")))}awardXp(e){if(e>0){for(this.totalXp+=e;this.totalXp>=this.nextLevelXp;){const t=this.nextLevelXp;this.level+=1,this.pendingLevelUps+=1,this.showLevelUp(),this.currentLevelXpBase=t,this.nextLevelXp+=this.getNextLevelXp(this.level)}this.tryOpenUpgradeMenu()}this.updateHud()}tryOpenUpgradeMenu(){if(this.pendingLevelUps<=0||this.upgradeManager.isActive())return;if(!this.upgradeManager.openMenu()){this.pendingLevelUps=0;return}this.pendingLevelUps-=1}handleExit(){if(this.exitHandled)return;this.exitHandled=!0,this.pauseExitButton?.disableInteractive(),this.gameOverHud?.clear();const e=W.exitHandler;e&&e({kills:this.kills,waves:this.wave+1})}pauseForUpgrade(){this.isPaused=!0,this.time.timeScale=0,this.pauseButton&&(this.pauseButton.disableInteractive(),this.pauseButton.setText("Upgrade")),this.hidePauseHud()}resumeFromUpgrade(){this.isPaused=!1,this.time.timeScale=1,this.pauseButton&&(this.pauseButton.setText("Pause"),this.pauseButton.setInteractive({useHandCursor:!0})),this.hidePauseHud()}onUpgradeMenuClosed(){this.resumeFromUpgrade(),this.pendingLevelUps>0&&this.tryOpenUpgradeMenu()}showLevelUp(){const e=this.add.text(this.scale.width/2,96,`Level ${this.level}!`,{color:"#ffe082",fontFamily:"monospace",fontSize:"24px",backgroundColor:"#1a1a25bb",padding:{x:12,y:6}}).setOrigin(.5).setScrollFactor(0).setDepth(5);this.tweens.add({targets:e,alpha:0,y:e.y-32,duration:900,ease:"Sine.easeOut",onComplete:()=>e.destroy()}),this.cameras.main.flash(160,140,220,80,!1)}showWeaponUpgrade(e){const t=this.add.text(this.scale.width/2,140,e,{color:"#ffab40",fontFamily:"monospace",fontSize:"20px",backgroundColor:"#222234dd",padding:{x:10,y:4}}).setOrigin(.5).setScrollFactor(0).setDepth(5);this.tweens.add({targets:t,alpha:0,y:t.y-28,duration:900,ease:"Sine.easeOut",onComplete:()=>t.destroy()})}showMagnetPickup(){const e=this.add.text(this.scale.width/2,180,"Magnet activated!",{color:"#8c9eff",fontFamily:"monospace",fontSize:"20px",backgroundColor:"#1f1f32dd",padding:{x:10,y:4}}).setOrigin(.5).setScrollFactor(0).setDepth(5);this.tweens.add({targets:e,alpha:0,y:e.y-24,duration:900,ease:"Sine.easeOut",onComplete:()=>e.destroy()})}showGameOverHud(e){this.isGameOver||(this.isGameOver=!0,this.isPaused=!0,this.time.timeScale=0,this.pauseButton&&(this.pauseButton.disableInteractive(),this.pauseButton.setVisible(!1)),this.pauseExitButton&&(this.pauseExitButton.setVisible(!1),this.pauseExitButton.disableInteractive()),this.gameOverHud||(this.gameOverHud=new ve(this)),this.gameOverHud.show(e,this.wave+1,this.kills,()=>this.handleExit()))}showPauseHud(){!this.pauseExitButton||this.isGameOver||(this.pauseExitButton.setVisible(!0),this.pauseExitButton.setInteractive({useHandCursor:!0}))}hidePauseHud(){!this.pauseExitButton||this.isGameOver||(this.pauseExitButton.setVisible(!1),this.pauseExitButton.disableInteractive())}getNextLevelXp(e){return Math.ceil(Re*Math.pow(Ce,e-1))}togglePause(){this.upgradeManager.isActive()||this.isGameOver||(this.isPaused=!this.isPaused,this.pauseButton.setText(this.isPaused?"Resume":"Pause"),this.time.timeScale=this.isPaused?0:1,this.isPaused?this.showPauseHud():this.hidePauseHud())}updateHud(){this.infoText.setText(`Wave ${this.wave+1} | LVL ${this.level}
Kills ${this.kills}`),this.weaponHud.refresh(),this.heroHpBar.updateValue(this.hero.hp,this.hero.maxHp);const e=this.nextLevelXp-this.currentLevelXpBase,t=this.totalXp-this.currentLevelXpBase,s=e>0?t/e:0;this.heroXpBar.updateValue(s)}ensureEnemyWalkAnimation(){if(!this.textures.exists(S.key)||this.anims.exists("enemy-walk"))return;const e=[x.mobWalk1,x.mobWalk2].map(t=>({key:S.key,frame:t}));this.anims.create({key:"enemy-walk",frames:e,frameRate:6,repeat:-1})}}const Ie=600,He=800,ct={type:c.AUTO,width:Ie,height:He,backgroundColor:"#101014",scene:W,fps:{target:60},scale:{mode:c.Scale.ScaleModes.FIT,autoCenter:c.Scale.Center.CENTER_BOTH}},_e="hordesHighScores",We=5,lt=()=>{try{const h=window.localStorage.getItem(_e);if(!h)return[];const e=JSON.parse(h);return Array.isArray(e)?e.sort((t,s)=>s.kills!==t.kills?s.kills-t.kills:s.waves!==t.waves?s.waves-t.waves:s.timestamp-t.timestamp).slice(0,We):[]}catch(h){return console.warn("Failed to read Hordes high scores",h),[]}},dt=h=>{try{window.localStorage.setItem(_e,JSON.stringify(h))}catch(e){console.warn("Failed to save Hordes high scores",e)}},pt=(h,e)=>{const t=[...h,{...e,timestamp:Date.now()}];return t.sort((s,a)=>a.kills!==s.kills?a.kills-s.kills:a.waves!==s.waves?a.waves-s.waves:a.timestamp-s.timestamp),t.slice(0,We)},mt=()=>{const h=P.useRef(null),e=P.useRef(null),[t,s]=P.useState(!1),[a,i]=P.useState(null),[n,o]=P.useState([]);P.useEffect(()=>{o(lt())},[]);const r=P.useCallback(p=>{i(p),s(!1),o(d=>{const g=pt(d,p);return dt(g),g})},[]);P.useEffect(()=>{if(!t){W.registerExitHandler(void 0),e.current&&(e.current.destroy(!0),e.current=null);return}const p=h.current;if(!p)return;W.registerExitHandler(r);const d=Ie*He,g=p.clientWidth/p.clientHeight,u=Math.sqrt(d)*Math.sqrt(g),m=Math.sqrt(d)/Math.sqrt(g);console.log("RATIO",g,u,"X",m,";",p.clientWidth,"X",p.clientHeight);const v=new c.Game({parent:p,...ct,width:u,height:m});e.current=v;const b=()=>{},A=new ResizeObserver(b);return A.observe(p),()=>{W.registerExitHandler(void 0),A?.disconnect(),v.destroy(!0),e.current=null}},[r,t]);const l=P.useCallback(()=>{i(null),s(!0)},[]);return t?f.jsx("div",{className:"h-screen w-screen overflow-hidden bg-[#101014] text-gray-100",children:f.jsx("div",{ref:h,className:"h-full w-full"})}):f.jsxs(f.Fragment,{children:[f.jsxs("div",{className:"flex min-h-screen flex-col items-center justify-start bg-gray-900 px-6 py-6 pb-28 text-gray-100",children:[f.jsx("h1",{className:"mb-4 text-3xl font-semibold",children:"Hordes"}),f.jsx("div",{className:"flex w-full max-w-[1100px] flex-col gap-6 lg:flex-row",children:f.jsxs("div",{className:"flex-1 rounded-lg border border-[#252545] bg-[#161626] p-5",children:[f.jsx("h2",{className:"mb-3 text-xl font-semibold",children:"High Scores"}),n.length===0?f.jsx("p",{className:"text-sm opacity-70",children:"No runs recorded yet. Be the first!"}):f.jsxs("table",{className:"w-full border-collapse text-sm",children:[f.jsx("thead",{children:f.jsxs("tr",{className:"border-b border-[#2c2c45] text-left",children:[f.jsx("th",{className:"px-1 py-1",children:"#"}),f.jsx("th",{className:"px-1 py-1",children:"Kills"}),f.jsx("th",{className:"px-1 py-1",children:"Waves"}),f.jsx("th",{className:"px-1 py-1",children:"Date"})]})}),f.jsxs("tbody",{children:[a&&f.jsxs("tr",{children:[f.jsx("td",{className:"px-1 py-1",children:"Last"}),f.jsx("td",{className:"px-1 py-1",children:a.kills}),f.jsx("td",{className:"px-1 py-1",children:a.waves})]}),n.map((p,d)=>f.jsxs("tr",{className:"border-b border-white/5",children:[f.jsx("td",{className:"px-1 py-2",children:d+1}),f.jsx("td",{className:"px-1 py-2",children:p.kills}),f.jsx("td",{className:"px-1 py-2",children:p.waves}),f.jsx("td",{className:"px-1 py-2",children:new Date(p.timestamp).toLocaleDateString()})]},`${p.timestamp}-${d}`))]})]})]})}),f.jsx(Ne,{to:"/",className:`mt-6 inline-flex items-center justify-center rounded-md border border-slate-600
          bg-slate-800 px-4 py-2 text-sm font-medium text-slate-100 transition hover:bg-slate-700`,children:"Back to main page"})]}),f.jsx("button",{onClick:l,className:`fixed bottom-6 left-1/2 z-50 w-[calc(100%-3rem)] max-w-md -translate-x-1/2 transform rounded-md
        bg-green-600 px-4 py-3 text-base font-semibold text-white shadow-lg transition hover:bg-green-500`,children:"Play"})]})};export{mt as default};
