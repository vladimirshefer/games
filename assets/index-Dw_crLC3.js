import{r as y,j as a,L as P}from"./index-BcH_fQyV.js";import{P as p,O as m,a as g}from"./sprite-Dr7SLk1e.js";const R=15,z=75,v=25,_=170,j=650,A=10,W=30,C=6,D=90,B=6,L=6,I=2,F=6,G=2,Y=3e3,K=400,w=12,S=8,N=[["obstacle","obstacle","obstacle","obstacle","obstacle","obstacle","obstacle","obstacle","obstacle","obstacle","obstacle","obstacle"],["obstacle","build","build","build","obstacle","build","build","build","obstacle","build","build","obstacle"],["road","road","road","road","road","road","obstacle","road","road","road","road","road"],["obstacle","build","build","obstacle","build","road","road","road","obstacle","build","build","obstacle"],["obstacle","build","build","obstacle","build","obstacle","obstacle","build","obstacle","build","build","obstacle"],["obstacle","build","build","obstacle","build","build","build","build","obstacle","build","build","obstacle"],["obstacle","obstacle","obstacle","obstacle","obstacle","build","build","build","obstacle","build","build","obstacle"],["obstacle","obstacle","obstacle","obstacle","obstacle","obstacle","obstacle","obstacle","obstacle","obstacle","obstacle","obstacle"]],d=[{col:0,row:2},{col:1,row:2},{col:2,row:2},{col:3,row:2},{col:4,row:2},{col:5,row:2},{col:5,row:3},{col:6,row:3},{col:7,row:3},{col:7,row:2},{col:8,row:2},{col:9,row:2},{col:10,row:2},{col:11,row:2}],O=[g.portalOpens,g.aura,g.healPotion];class b extends p.Scene{static exitHandler;buildSpots=[];towers=[];enemies=[];path;pathLength=0;pathIndexByCell=new Map;enemyOverlay;towerOverlay;timers=[];wave=0;leaks=0;baseHp=R;coins=z;coinsEarned=0;hudWave;hudHp;hudCoins;hudLeaks;exitButton;baseMarker;runEnded=!1;gridTileSize=0;gridOriginX=0;gridOriginY=0;tileSprites=[];tileSpriteLookup=new Map;static registerExitHandler(e){b.exitHandler=e}preload(){this.load.setPath(""),this.textures.exists(m.key)||this.load.spritesheet(m.key,m.url,{frameWidth:m.frameWidth,frameHeight:m.frameHeight,spacing:m.spacing})}create(){this.cameras.main.setBackgroundColor("#0b0f19"),this.ensureEnemyWalkAnimation(),this.enemyOverlay=this.add.graphics().setDepth(5),this.towerOverlay=this.add.graphics().setDepth(4),this.createPath(),this.createBaseMarker(),this.createBuildSpots(),this.createHud(),this.configureInput(),this.scale.on("resize",this.handleResize,this),this.time.delayedCall(600,()=>this.startNextWave())}update(e,t){if(this.runEnded)return;const s=t/1e3;this.updateEnemies(s),this.updateTowers(t),this.renderOverlays()}createPath(){const{width:e,height:t}=this.scale;this.recalculateGridMetrics(e,t),this.pathIndexByCell.clear(),d.forEach((i,r)=>{this.pathIndexByCell.set(this.cellKey(i.col,i.row),r)});const s=this.gridToWorldCenter(d[0].col,d[0].row);this.path=new p.Curves.Path(s.x,s.y);for(let i=1;i<d.length;i+=1){const r=this.gridToWorldCenter(d[i].col,d[i].row);this.path.lineTo(r.x,r.y)}this.pathLength=this.path.getLength(),this.refreshGridTiles()}createBaseMarker(){this.baseMarker?.destroy();const e=d[d.length-1],t=this.gridToWorldCenter(e.col,e.row),s=this.gridTileSize*.9;this.baseMarker=this.add.rectangle(t.x,t.y,s,s,1319471).setStrokeStyle(2,3854591,.6).setDepth(2)}createBuildSpots(){this.buildSpots=[];let e=0;for(let t=0;t<S;t+=1)for(let s=0;s<w;s+=1){if(N[t][s]!=="build")continue;const i=this.tileSpriteLookup.get(this.cellKey(s,t));if(!i)continue;const r={id:e,col:s,row:t,occupied:!1,marker:i};this.buildSpots.push(r),this.applyBuildSpotTint(r),e+=1}}createHud(){this.hudWave?.destroy(),this.hudHp?.destroy(),this.hudCoins?.destroy(),this.hudLeaks?.destroy(),this.exitButton?.destroy(),this.hudWave=this.add.text(16,16,"",this.hudStyle()),this.hudHp=this.add.text(16,44,"",this.hudStyle()),this.hudCoins=this.add.text(16,72,"",this.hudStyle()),this.hudLeaks=this.add.text(16,100,"",this.hudStyle()),this.exitButton=this.add.text(this.scale.width-20,16,"Exit",{...this.hudStyle(),color:"#f87171"}).setOrigin(1,0).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this.endRun()),this.add.text(this.scale.width/2,this.scale.height-24,"Click any build tile to place a tower. Towers fire automatically.",{...this.hudStyle(),fontSize:"14px",color:"#9ca3af"}).setOrigin(.5,1),this.refreshHud()}configureInput(){this.input.keyboard?.on("keydown-ESC",()=>this.endRun()),this.input.on("pointerdown",e=>{if(this.runEnded)return;const t=this.buildSpots.find(s=>s.occupied?!1:s.marker.getBounds().contains(e.worldX,e.worldY));if(t){if(this.coins<v){this.showFloatingText(e.worldX,e.worldY,"Not enough coins");return}this.placeTower(t)}})}startNextWave(){if(this.runEnded)return;this.wave+=1,this.refreshHud();const e=F+Math.max(0,this.wave-1)*G,t=Math.max(K,900-this.wave*40),s=this.time.addEvent({delay:t,repeat:e-1,callback:()=>{this.spawnEnemy()}});this.timers.push(s),this.spawnEnemy();const i=t*Math.max(e-1,0),r=this.time.delayedCall(i+Y,()=>{this.timers=this.timers.filter(n=>n!==r),!this.runEnded&&this.startNextWave()});this.timers.push(r)}spawnEnemy(){const e=W+(this.wave-1)*C,t=D+(this.wave-1)*B,s=L+(this.wave-1)*I,i=new p.Math.Vector2;this.path.getPoint(0,i);const r=this.gridTileSize*.7,n=this.add.sprite(i.x,i.y,m.key,g.mobWalk1).setOrigin(.5).setDisplaySize(r,r).setTint(14441586).setDepth(6);this.anims.exists("enemy-walk")&&(n.play("enemy-walk"),n.anims.setProgress(Math.random())),this.enemies.push({sprite:n,distance:0,speed:t,hp:e,maxHp:e,reward:s,leakDamage:1})}placeTower(e){const t=e.marker;this.towers.push({spotId:e.id,sprite:t,range:_,fireRate:j,cooldown:0,damage:A}),e.occupied=!0,this.applyBuildSpotTint(e),this.coins-=v,this.refreshHud();const s=Math.max(24,this.gridTileSize*.5);this.showFloatingText(t.x,t.y-s,"Tower ready")}updateEnemies(e){const t=new p.Math.Vector2,s=[];for(const i of this.enemies){i.distance+=i.speed*e;const r=i.distance/this.pathLength;if(r>=1){this.handleLeak(i),i.sprite.destroy();continue}this.path.getPoint(r,t),i.sprite.setPosition(t.x,t.y),s.push(i)}this.enemies=s}updateTowers(e){const t=e;this.towerOverlay?.clear();for(const s of this.towers){s.cooldown=Math.max(0,s.cooldown-t);const i=this.findTargetForTower(s);!i||s.cooldown>0||(s.cooldown=s.fireRate,i.hp-=s.damage,this.towerOverlay?.lineStyle(3,16436245,.6).beginPath().moveTo(s.sprite.x,s.sprite.y).lineTo(i.sprite.x,i.sprite.y).strokePath(),i.hp<=0&&this.handleKill(i))}}renderOverlays(){if(!this.enemyOverlay)return;this.enemyOverlay.clear(),this.enemyOverlay.fillStyle(2042167,.8);const e=Math.max(24,this.gridTileSize*.7),t=Math.max(4,this.gridTileSize*.12);for(const s of this.enemies){const i=p.Math.Clamp(s.hp/s.maxHp,0,1),r=s.sprite.displayHeight/2+Math.max(6,this.gridTileSize*.15);this.enemyOverlay.fillRect(s.sprite.x-e/2,s.sprite.y-r,e,t),this.enemyOverlay.fillStyle(16347926,.9),this.enemyOverlay.fillRect(s.sprite.x-e/2+1,s.sprite.y-r+1,(e-2)*i,t-2),this.enemyOverlay.fillStyle(2042167,.8)}}findTargetForTower(e){let t,s=-1/0;for(const i of this.enemies){if(p.Math.Distance.Squared(e.sprite.x,e.sprite.y,i.sprite.x,i.sprite.y)>e.range*e.range)continue;const n=i.distance;n>s&&(t=i,s=n)}return t}handleLeak(e){this.baseHp=Math.max(0,this.baseHp-e.leakDamage),this.leaks+=1,this.refreshHud(),this.showFloatingText(this.baseMarker.x,this.baseMarker.y,"Leak!","#f87171"),this.baseHp<=0&&this.endRun()}handleKill(e){const{x:t,y:s}=e.sprite;e.sprite.destroy(),this.enemies=this.enemies.filter(r=>r!==e),this.coins+=e.reward,this.coinsEarned+=e.reward,this.refreshHud();const i=Math.max(18,this.gridTileSize*.45);this.showFloatingText(t,s-i,`+${e.reward}`,"#34d399")}refreshHud(){this.hudWave.setText(`Wave ${this.wave}`),this.hudHp.setText(`Base HP: ${this.baseHp}`),this.hudCoins.setText(`Coins: ${this.coins}`),this.hudLeaks.setText(`Leaks: ${this.leaks}`),this.baseMarker&&this.baseMarker.setFillStyle(this.baseHp>5?1319471:4136235,1)}handleResize(e){const{width:t,height:s}=e;if(!t||!s)return;const i=this.pathLength;this.createPath(),this.createBaseMarker(),this.buildSpots.forEach(l=>{const h=this.gridToWorldCenter(l.col,l.row),u=this.towers.find(o=>o.spotId===l.id);u&&u.sprite.setPosition(h.x,h.y).setDisplaySize(this.gridTileSize*.6,this.gridTileSize*.6),this.applyBuildSpotTint(l)});const r=this.gridTileSize*.7,n=new p.Math.Vector2;for(const l of this.enemies){const h=i>0?l.distance/i:0;l.distance=h*this.pathLength,this.path.getPoint(h,n),l.sprite.setPosition(n.x,n.y).setDisplaySize(r,r)}this.exitButton.setPosition(t-20,16)}endRun(){if(this.runEnded)return;this.runEnded=!0,this.timers.forEach(t=>t.remove()),this.timers=[],this.time.removeAllEvents();const e={waves:this.wave,leaks:this.leaks,coinsEarned:this.coinsEarned};b.exitHandler?.(e),this.scene.stop()}showFloatingText(e,t,s,i="#fbbf24"){const r=Math.max(28,this.gridTileSize*.5),n=this.add.text(e,t,s,{...this.hudStyle(),fontSize:"14px",color:i}).setOrigin(.5,1).setDepth(10);this.tweens.add({targets:n,y:t-r,alpha:0,duration:900,ease:"Sine.easeOut",onComplete:()=>n.destroy()})}hudStyle(){return{fontFamily:"monospace",fontSize:"18px",color:"#f8fafc"}}recalculateGridMetrics(e,t){const s=e/w,i=t/S;this.gridTileSize=Math.min(s,i);const r=this.gridTileSize*w,n=this.gridTileSize*S;this.gridOriginX=(e-r)/2,this.gridOriginY=(t-n)/2}refreshGridTiles(){const{width:e,height:t}=this.scale;if(this.recalculateGridMetrics(e,t),!this.textures.exists(m.key))return;const s=this.gridTileSize*.98;for(let i=0;i<S;i+=1)for(let r=0;r<w;r+=1){const n=N[i][r],l=this.cellKey(r,i),h=this.gridToWorldCenter(r,i),u=this.appearanceForTile(r,i,n),o=n==="obstacle"?2:0;let c=this.tileSpriteLookup.get(l);if(!c)c=this.add.sprite(h.x,h.y,m.key,u.frame).setOrigin(.5).setDisplaySize(s,s).setDepth(o),c.setAngle(u.angle),c.setTint(this.tintForTile(n)),this.tileSpriteLookup.set(l,c),this.tileSprites.push(c);else{c.setPosition(h.x,h.y).setDisplaySize(s,s).setFrame(u.frame).setDepth(o).setAngle(u.angle);const x=this.findBuildSpot(r,i);x?x.occupied&&this.applyBuildSpotTint(x):c.setTint(this.tintForTile(n))}}}appearanceForTile(e,t,s){return s==="road"?this.roadAppearance(e,t):{frame:O[{build:1,obstacle:2}[s]],angle:0}}roadAppearance(e,t){const s=this.cellKey(e,t),i=this.pathIndexByCell.get(s);if(i===void 0)return{frame:g.roadStraight,angle:0};const r=i>0?d[i-1]:void 0,n=i<d.length-1?d[i+1]:void 0,l=new Set;r&&l.add(this.oppositeDirection(this.directionBetween(r,d[i]))),n&&l.add(this.directionBetween(d[i],n));const h=l.has("up"),u=l.has("down"),o=l.has("left"),c=l.has("right");return(h||u)&&(o||c)?{frame:g.roadTurn,angle:this.cornerAngle(h,u,o,c)}:o||c?{frame:g.roadStraight,angle:90}:{frame:g.roadStraight,angle:0}}cornerAngle(e,t,s,i){return t&&i?0:e&&i?-90:e&&s?180:t&&s?90:0}directionBetween(e,t){return t.col>e.col?"right":t.col<e.col?"left":t.row>e.row?"down":"up"}oppositeDirection(e){switch(e){case"up":return"down";case"down":return"up";case"left":return"right";case"right":default:return"left"}}tintForTile(e){return e==="road"?16777215:e==="build"?12376063:7041664}applyBuildSpotTint(e){if(e.occupied){const t=this.gridTileSize*.6;e.marker.setFrame(g.tower1).setDisplaySize(t,t).setDepth(7).setTint(15857145).setAngle(0)}else{const t=this.gridTileSize*.98;e.marker.setFrame(O[1]).setDisplaySize(t,t).setDepth(0).setTint(6333946).setAngle(0)}}cellKey(e,t){return`${e},${t}`}findBuildSpot(e,t){return this.buildSpots.find(s=>s.col===e&&s.row===t)}gridToWorldCenter(e,t){const s=this.gridOriginX+e*this.gridTileSize+this.gridTileSize/2,i=this.gridOriginY+t*this.gridTileSize+this.gridTileSize/2;return new p.Math.Vector2(s,i)}ensureEnemyWalkAnimation(){if(!this.textures.exists(m.key)||this.anims.exists("enemy-walk"))return;const e=[g.mobWalk1,g.mobWalk2].map(t=>({key:m.key,frame:t}));this.anims.create({key:"enemy-walk",frames:e,frameRate:6,repeat:-1})}}const V={type:p.AUTO,width:960,height:640,backgroundColor:"#0b0f19",scene:b,fps:{target:60},scale:{mode:p.Scale.RESIZE,autoCenter:p.Scale.CENTER_BOTH}},H="towerDefenseHighScores",M=5,$=()=>{if(typeof window>"u")return[];try{const f=window.localStorage.getItem(H);if(!f)return[];const e=JSON.parse(f);return Array.isArray(e)?e.filter(t=>typeof t?.waves=="number"&&typeof t?.leaks=="number"&&typeof t?.coinsEarned=="number"&&typeof t?.timestamp=="number").sort((t,s)=>s.waves!==t.waves?s.waves-t.waves:t.leaks!==s.leaks?t.leaks-s.leaks:s.coinsEarned-t.coinsEarned).slice(0,M):[]}catch(f){return console.warn("Failed to read tower defence high scores",f),[]}},X=f=>{if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(H,JSON.stringify(f))}catch(e){console.warn("Failed to store tower defence high scores",e)}},q=(f,e)=>{const t=[...f,{...e,timestamp:Date.now()}];return t.sort((s,i)=>i.waves!==s.waves?i.waves-s.waves:s.leaks!==i.leaks?s.leaks-i.leaks:i.coinsEarned-s.coinsEarned),t.slice(0,M)},Q=()=>{const f=y.useRef(null),e=y.useRef(null),[t,s]=y.useState(!1),[i,r]=y.useState(null),[n,l]=y.useState([]);y.useEffect(()=>{l($())},[]);const h=y.useCallback(o=>{r(o),s(!1),l(c=>{const x=q(c,o);return X(x),x})},[]);y.useEffect(()=>{if(!t){b.registerExitHandler(void 0),e.current&&(e.current.destroy(!0),e.current=null);return}const o=f.current;if(!o)return;b.registerExitHandler(h);const c=new p.Game({parent:o,...V});e.current=c;const x=()=>{const T=o.clientWidth,k=o.clientHeight;T&&k&&c.scale.resize(T,k)};x();let E;return typeof ResizeObserver<"u"&&(E=new ResizeObserver(x),E.observe(o)),()=>{b.registerExitHandler(void 0),E?.disconnect(),c.destroy(!0),e.current=null}},[h,t]);const u=y.useCallback(()=>{r(null),s(!0)},[]);return t?a.jsx("div",{className:"h-screen w-screen overflow-hidden bg-[#0b0f19] text-slate-100",children:a.jsx("div",{ref:f,className:"h-full w-full"})}):a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex min-h-screen flex-col items-center justify-start bg-slate-950 px-6 py-6 pb-28 text-slate-100",children:[a.jsx("h1",{className:"mb-4 text-3xl font-semibold",children:"Tower Defence"}),a.jsxs("div",{className:"flex w-full max-w-[1100px] flex-col gap-6 lg:flex-row",children:[a.jsxs("div",{className:"flex-1 rounded-lg border border-white/10 bg-slate-900/60 p-5",children:[a.jsx("h2",{className:"mb-3 text-xl font-semibold",children:"High Scores"}),n.length===0?a.jsx("p",{className:"text-sm opacity-70",children:"No waves cleared yet. Place some towers!"}):a.jsxs("table",{className:"w-full border-collapse text-sm",children:[a.jsx("thead",{children:a.jsxs("tr",{className:"border-b border-white/5 text-left",children:[a.jsx("th",{className:"px-1 py-1",children:"#"}),a.jsx("th",{className:"px-1 py-1",children:"Waves"}),a.jsx("th",{className:"px-1 py-1",children:"Leaks"}),a.jsx("th",{className:"px-1 py-1",children:"Coins"}),a.jsx("th",{className:"px-1 py-1",children:"Date"})]})}),a.jsxs("tbody",{children:[i&&a.jsxs("tr",{children:[a.jsx("td",{className:"px-1 py-1",children:"Last"}),a.jsx("td",{className:"px-1 py-1",children:i.waves}),a.jsx("td",{className:"px-1 py-1",children:i.leaks}),a.jsx("td",{className:"px-1 py-1",children:i.coinsEarned}),a.jsx("td",{className:"px-1 py-1",children:"—"})]}),n.map((o,c)=>a.jsxs("tr",{className:"border-b border-white/5",children:[a.jsx("td",{className:"px-1 py-2",children:c+1}),a.jsx("td",{className:"px-1 py-2",children:o.waves}),a.jsx("td",{className:"px-1 py-2",children:o.leaks}),a.jsx("td",{className:"px-1 py-2",children:o.coinsEarned}),a.jsx("td",{className:"px-1 py-2",children:new Date(o.timestamp).toLocaleDateString()})]},`${o.timestamp}-${c}`))]})]})]}),a.jsxs("div",{className:`flex w-full max-w-sm flex-col gap-3 rounded-lg border border-white/10
        bg-slate-900/60 p-5 text-sm`,children:[a.jsx("h2",{className:"text-xl font-semibold",children:"How to Play"}),a.jsxs("ul",{className:"list-disc space-y-1 pl-5 opacity-80",children:[a.jsx("li",{children:"Click a glowing pad to spend 25 coins on a tower."}),a.jsx("li",{children:"Towers auto-target creeps closest to your base."}),a.jsx("li",{children:"Kills drop coins; leaks damage the base."}),a.jsx("li",{children:"Survive as long as you can — waves keep scaling."})]})]})]}),a.jsx(P,{to:"/",className:`mt-6 inline-flex items-center justify-center rounded-md border border-slate-600
          bg-slate-800 px-4 py-2 text-sm font-medium text-slate-100 transition hover:bg-slate-700`,children:"Back to main page"})]}),a.jsx("button",{onClick:u,className:`fixed bottom-6 left-1/2 z-50 w-[calc(100%-3rem)] max-w-md -translate-x-1/2 transform rounded-md
        bg-blue-600 px-4 py-3 text-base font-semibold text-white shadow-lg transition hover:bg-blue-500`,children:"Play"})]})};export{Q as default};
