import{r as p,j as r}from"./index-zXPeRMwR.js";import{P as h,O as w,a as E}from"./sprite-CL44P8JK.js";const z=15,R=75,v=25,M=170,P=650,_=10,W=30,j=6,C=90,A=6,D=6,G=2,I=6,B=2,L=3e3,Y=400,x=12,y=8,N=[["wall","wall","wall","wall","wall","wall","wall","wall","wall","wall","wall","wall"],["wall","build","build","build","wall","build","build","build","wall","build","build","wall"],["spawn","path","path","path","path","path","wall","path","path","path","path","base"],["wall","build","build","wall","build","path","path","path","wall","build","build","wall"],["wall","build","build","wall","build","wall","wall","build","wall","build","build","wall"],["wall","build","build","wall","build","build","build","build","wall","build","build","wall"],["wall","wall","wall","wall","wall","build","build","build","wall","build","build","wall"],["wall","wall","wall","wall","wall","wall","wall","wall","wall","wall","wall","wall"]],m=[{col:0,row:2},{col:1,row:2},{col:2,row:2},{col:3,row:2},{col:4,row:2},{col:5,row:2},{col:5,row:3},{col:6,row:3},{col:7,row:3},{col:7,row:2},{col:8,row:2},{col:9,row:2},{col:10,row:2},{col:11,row:2}];class f extends h.Scene{static exitHandler;buildSpots=[];towers=[];enemies=[];path;pathLength=0;gridGraphics;enemyOverlay;towerOverlay;timers=[];wave=0;leaks=0;baseHp=z;coins=R;coinsEarned=0;hudWave;hudHp;hudCoins;hudLeaks;exitButton;baseMarker;runEnded=!1;gridTileSize=0;gridOriginX=0;gridOriginY=0;static registerExitHandler(s){f.exitHandler=s}preload(){this.load.setPath(""),this.textures.exists(w.key)||this.load.spritesheet(w.key,w.url,{frameWidth:w.frameWidth,frameHeight:w.frameHeight,spacing:w.spacing})}create(){this.cameras.main.setBackgroundColor("#0b0f19"),this.ensureEnemyWalkAnimation(),this.enemyOverlay=this.add.graphics().setDepth(5),this.towerOverlay=this.add.graphics().setDepth(4),this.createPath(),this.createBaseMarker(),this.createBuildSpots(),this.createHud(),this.configureInput(),this.scale.on("resize",this.handleResize,this),this.time.delayedCall(600,()=>this.startNextWave())}update(s,e){if(this.runEnded)return;const t=e/1e3;this.updateEnemies(t),this.updateTowers(e),this.renderOverlays()}createPath(){this.gridGraphics?.destroy();const{width:s,height:e}=this.scale;this.recalculateGridMetrics(s,e),this.gridGraphics=this.add.graphics().setDepth(0),this.drawGrid();const t=this.gridToWorldCenter(m[0].col,m[0].row);this.path=new h.Curves.Path(t.x,t.y);for(let i=1;i<m.length;i+=1){const a=this.gridToWorldCenter(m[i].col,m[i].row);this.path.lineTo(a.x,a.y)}this.pathLength=this.path.getLength()}createBaseMarker(){this.baseMarker?.destroy();const s=m[m.length-1],e=this.gridToWorldCenter(s.col,s.row),t=this.gridTileSize*.9;this.baseMarker=this.add.rectangle(e.x,e.y,t,t,1319471).setStrokeStyle(2,3854591,.6).setDepth(2)}createBuildSpots(){this.buildSpots.forEach(e=>e.marker.destroy()),this.buildSpots=[];let s=0;for(let e=0;e<y;e+=1)for(let t=0;t<x;t+=1){if(N[e][t]!=="build")continue;const i=this.gridToWorldCenter(t,e),a=this.gridTileSize*.7,l=this.add.rectangle(i.x,i.y,a,a,1977408,.45).setStrokeStyle(2,5231871,.55).setDepth(3);this.buildSpots.push({id:s,col:t,row:e,occupied:!1,marker:l}),s+=1}}createHud(){this.hudWave?.destroy(),this.hudHp?.destroy(),this.hudCoins?.destroy(),this.hudLeaks?.destroy(),this.exitButton?.destroy(),this.hudWave=this.add.text(16,16,"",this.hudStyle()),this.hudHp=this.add.text(16,44,"",this.hudStyle()),this.hudCoins=this.add.text(16,72,"",this.hudStyle()),this.hudLeaks=this.add.text(16,100,"",this.hudStyle()),this.exitButton=this.add.text(this.scale.width-20,16,"Exit",{...this.hudStyle(),color:"#f87171"}).setOrigin(1,0).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this.endRun()),this.add.text(this.scale.width/2,this.scale.height-24,"Click glowing squares to build towers. Towers fire automatically.",{...this.hudStyle(),fontSize:"14px",color:"#9ca3af"}).setOrigin(.5,1),this.refreshHud()}configureInput(){this.input.keyboard?.on("keydown-ESC",()=>this.endRun()),this.input.on("pointerdown",s=>{if(this.runEnded)return;const e=this.buildSpots.find(t=>t.occupied?!1:t.marker.getBounds().contains(s.worldX,s.worldY));if(e){if(this.coins<v){this.showFloatingText(s.worldX,s.worldY,"Not enough coins");return}this.placeTower(e)}})}startNextWave(){if(this.runEnded)return;this.wave+=1,this.refreshHud();const s=I+Math.max(0,this.wave-1)*B,e=Math.max(Y,900-this.wave*40),t=this.time.addEvent({delay:e,repeat:s-1,callback:()=>{this.spawnEnemy()}});this.timers.push(t),this.spawnEnemy();const i=e*Math.max(s-1,0),a=this.time.delayedCall(i+L,()=>{this.timers=this.timers.filter(l=>l!==a),!this.runEnded&&this.startNextWave()});this.timers.push(a)}spawnEnemy(){const s=W+(this.wave-1)*j,e=C+(this.wave-1)*A,t=D+(this.wave-1)*G,i=new h.Math.Vector2;this.path.getPoint(0,i);const a=this.gridTileSize*.7,l=this.add.sprite(i.x,i.y,w.key,E.mobWalk1).setOrigin(.5).setDisplaySize(a,a).setTint(14441586).setDepth(6);this.anims.exists("enemy-walk")&&(l.play("enemy-walk"),l.anims.setProgress(Math.random())),this.enemies.push({sprite:l,distance:0,speed:e,hp:s,maxHp:s,reward:t,leakDamage:1})}placeTower(s){const e=this.gridTileSize*.6,t=this.add.rectangle(s.marker.x,s.marker.y,e,e,5231871,.9).setStrokeStyle(2,16777215,.7).setDepth(7);this.towers.push({spotId:s.id,sprite:t,range:M,fireRate:P,cooldown:0,damage:_}),s.occupied=!0,s.marker.setStrokeStyle(2,3900150,.45).setFillStyle(1920728,.35),this.coins-=v,this.refreshHud();const i=Math.max(24,this.gridTileSize*.5);this.showFloatingText(t.x,t.y-i,"Tower ready")}updateEnemies(s){const e=new h.Math.Vector2,t=[];for(const i of this.enemies){i.distance+=i.speed*s;const a=i.distance/this.pathLength;if(a>=1){this.handleLeak(i),i.sprite.destroy();continue}this.path.getPoint(a,e),i.sprite.setPosition(e.x,e.y),t.push(i)}this.enemies=t}updateTowers(s){const e=s;this.towerOverlay?.clear();for(const t of this.towers){t.cooldown=Math.max(0,t.cooldown-e);const i=this.findTargetForTower(t);!i||t.cooldown>0||(t.cooldown=t.fireRate,i.hp-=t.damage,this.towerOverlay?.lineStyle(3,16436245,.6).beginPath().moveTo(t.sprite.x,t.sprite.y).lineTo(i.sprite.x,i.sprite.y).strokePath(),i.hp<=0&&this.handleKill(i))}}renderOverlays(){if(!this.enemyOverlay)return;this.enemyOverlay.clear(),this.enemyOverlay.fillStyle(2042167,.8);const s=Math.max(24,this.gridTileSize*.7),e=Math.max(4,this.gridTileSize*.12);for(const t of this.enemies){const i=h.Math.Clamp(t.hp/t.maxHp,0,1),a=t.sprite.displayHeight/2+Math.max(6,this.gridTileSize*.15);this.enemyOverlay.fillRect(t.sprite.x-s/2,t.sprite.y-a,s,e),this.enemyOverlay.fillStyle(16347926,.9),this.enemyOverlay.fillRect(t.sprite.x-s/2+1,t.sprite.y-a+1,(s-2)*i,e-2),this.enemyOverlay.fillStyle(2042167,.8)}}findTargetForTower(s){let e,t=-1/0;for(const i of this.enemies){if(h.Math.Distance.Squared(s.sprite.x,s.sprite.y,i.sprite.x,i.sprite.y)>s.range*s.range)continue;const l=i.distance;l>t&&(e=i,t=l)}return e}handleLeak(s){this.baseHp=Math.max(0,this.baseHp-s.leakDamage),this.leaks+=1,this.refreshHud(),this.showFloatingText(this.baseMarker.x,this.baseMarker.y,"Leak!","#f87171"),this.baseHp<=0&&this.endRun()}handleKill(s){const{x:e,y:t}=s.sprite;s.sprite.destroy(),this.enemies=this.enemies.filter(a=>a!==s),this.coins+=s.reward,this.coinsEarned+=s.reward,this.refreshHud();const i=Math.max(18,this.gridTileSize*.45);this.showFloatingText(e,t-i,`+${s.reward}`,"#34d399")}refreshHud(){this.hudWave.setText(`Wave ${this.wave}`),this.hudHp.setText(`Base HP: ${this.baseHp}`),this.hudCoins.setText(`Coins: ${this.coins}`),this.hudLeaks.setText(`Leaks: ${this.leaks}`),this.baseMarker&&this.baseMarker.setFillStyle(this.baseHp>5?1319471:4136235,1)}handleResize(s){const{width:e,height:t}=s;if(!e||!t)return;const i=this.pathLength;this.createPath(),this.createBaseMarker();const a=this.gridTileSize*.7;this.buildSpots.forEach(o=>{const u=this.gridToWorldCenter(o.col,o.row);o.marker.setPosition(u.x,u.y).setDisplaySize(a,a);const n=this.towers.find(c=>c.spotId===o.id);n&&n.sprite.setPosition(u.x,u.y).setDisplaySize(this.gridTileSize*.6,this.gridTileSize*.6)});const l=this.gridTileSize*.7,g=new h.Math.Vector2;for(const o of this.enemies){const u=i>0?o.distance/i:0;o.distance=u*this.pathLength,this.path.getPoint(u,g),o.sprite.setPosition(g.x,g.y).setDisplaySize(l,l)}this.exitButton.setPosition(e-20,16)}endRun(){if(this.runEnded)return;this.runEnded=!0,this.timers.forEach(e=>e.remove()),this.timers=[],this.time.removeAllEvents();const s={waves:this.wave,leaks:this.leaks,coinsEarned:this.coinsEarned};f.exitHandler?.(s),this.scene.stop()}showFloatingText(s,e,t,i="#fbbf24"){const a=Math.max(28,this.gridTileSize*.5),l=this.add.text(s,e,t,{...this.hudStyle(),fontSize:"14px",color:i}).setOrigin(.5,1).setDepth(10);this.tweens.add({targets:l,y:e-a,alpha:0,duration:900,ease:"Sine.easeOut",onComplete:()=>l.destroy()})}hudStyle(){return{fontFamily:"monospace",fontSize:"18px",color:"#f8fafc"}}recalculateGridMetrics(s,e){const t=s/x,i=e/y;this.gridTileSize=Math.min(t,i);const a=this.gridTileSize*x,l=this.gridTileSize*y;this.gridOriginX=(s-a)/2,this.gridOriginY=(e-l)/2}drawGrid(){if(!this.gridGraphics)return;this.gridGraphics.clear();const s={wall:725536,build:1779771,path:2768735,spawn:3362157,base:2241613};for(let e=0;e<y;e+=1)for(let t=0;t<x;t+=1){const i=N[e][t],a=this.gridOriginX+t*this.gridTileSize,l=this.gridOriginY+e*this.gridTileSize,g=s[i],o=i==="wall"?.88:.95;this.gridGraphics.fillStyle(g,o),this.gridGraphics.fillRect(a,l,this.gridTileSize,this.gridTileSize)}this.gridGraphics.lineStyle(1,988970,.55);for(let e=0;e<=x;e+=1){const t=this.gridOriginX+e*this.gridTileSize;this.gridGraphics.lineBetween(t,this.gridOriginY,t,this.gridOriginY+y*this.gridTileSize)}for(let e=0;e<=y;e+=1){const t=this.gridOriginY+e*this.gridTileSize;this.gridGraphics.lineBetween(this.gridOriginX,t,this.gridOriginX+x*this.gridTileSize,t)}}gridToWorldCenter(s,e){const t=this.gridOriginX+s*this.gridTileSize+this.gridTileSize/2,i=this.gridOriginY+e*this.gridTileSize+this.gridTileSize/2;return new h.Math.Vector2(t,i)}ensureEnemyWalkAnimation(){if(!this.textures.exists(w.key)||this.anims.exists("enemy-walk"))return;const s=[E.mobWalk1,E.mobWalk2].map(e=>({key:w.key,frame:e}));this.anims.create({key:"enemy-walk",frames:s,frameRate:6,repeat:-1})}}const F={type:h.AUTO,width:960,height:640,backgroundColor:"#0b0f19",scene:f,fps:{target:60},scale:{mode:h.Scale.RESIZE,autoCenter:h.Scale.CENTER_BOTH}},O="towerDefenseHighScores",H=5,V=()=>{if(typeof window>"u")return[];try{const d=window.localStorage.getItem(O);if(!d)return[];const s=JSON.parse(d);return Array.isArray(s)?s.filter(e=>typeof e?.waves=="number"&&typeof e?.leaks=="number"&&typeof e?.coinsEarned=="number"&&typeof e?.timestamp=="number").sort((e,t)=>t.waves!==e.waves?t.waves-e.waves:e.leaks!==t.leaks?e.leaks-t.leaks:t.coinsEarned-e.coinsEarned).slice(0,H):[]}catch(d){return console.warn("Failed to read tower defence high scores",d),[]}},X=d=>{if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(O,JSON.stringify(d))}catch(s){console.warn("Failed to store tower defence high scores",s)}},K=(d,s)=>{const e=[...d,{...s,timestamp:Date.now()}];return e.sort((t,i)=>i.waves!==t.waves?i.waves-t.waves:t.leaks!==i.leaks?t.leaks-i.leaks:i.coinsEarned-t.coinsEarned),e.slice(0,H)},J=()=>{const d=p.useRef(null),s=p.useRef(null),[e,t]=p.useState(!1),[i,a]=p.useState(null),[l,g]=p.useState([]);p.useEffect(()=>{g(V())},[]);const o=p.useCallback(n=>{a(n),t(!1),g(c=>{const S=K(c,n);return X(S),S})},[]);p.useEffect(()=>{if(!e){f.registerExitHandler(void 0),s.current&&(s.current.destroy(!0),s.current=null);return}const n=d.current;if(!n)return;f.registerExitHandler(o);const c=new h.Game({parent:n,...F});s.current=c;const S=()=>{const T=n.clientWidth,k=n.clientHeight;T&&k&&c.scale.resize(T,k)};S();let b;return typeof ResizeObserver<"u"&&(b=new ResizeObserver(S),b.observe(n)),()=>{f.registerExitHandler(void 0),b?.disconnect(),c.destroy(!0),s.current=null}},[o,e]);const u=p.useCallback(()=>{a(null),t(!0)},[]);return e?r.jsx("div",{className:"h-screen w-screen overflow-hidden bg-[#0b0f19] text-slate-100",children:r.jsx("div",{ref:d,className:"h-full w-full"})}):r.jsxs("div",{className:"flex min-h-screen flex-col items-center justify-start bg-slate-950 px-6 py-6 text-slate-100",children:[r.jsx("h1",{className:"mb-4 text-3xl font-semibold",children:"Tower Defence"}),r.jsxs("div",{className:"flex w-full max-w-[1100px] flex-col gap-6 lg:flex-row",children:[r.jsxs("div",{className:"flex-1 rounded-lg border border-white/10 bg-slate-900/60 p-5",children:[r.jsx("h2",{className:"mb-3 text-xl font-semibold",children:"High Scores"}),l.length===0?r.jsx("p",{className:"text-sm opacity-70",children:"No waves cleared yet. Place some towers!"}):r.jsxs("table",{className:"w-full border-collapse text-sm",children:[r.jsx("thead",{children:r.jsxs("tr",{className:"border-b border-white/5 text-left",children:[r.jsx("th",{className:"px-1 py-1",children:"#"}),r.jsx("th",{className:"px-1 py-1",children:"Waves"}),r.jsx("th",{className:"px-1 py-1",children:"Leaks"}),r.jsx("th",{className:"px-1 py-1",children:"Coins"}),r.jsx("th",{className:"px-1 py-1",children:"Date"})]})}),r.jsxs("tbody",{children:[i&&r.jsxs("tr",{children:[r.jsx("td",{className:"px-1 py-1",children:"Last"}),r.jsx("td",{className:"px-1 py-1",children:i.waves}),r.jsx("td",{className:"px-1 py-1",children:i.leaks}),r.jsx("td",{className:"px-1 py-1",children:i.coinsEarned}),r.jsx("td",{className:"px-1 py-1",children:"—"})]}),l.map((n,c)=>r.jsxs("tr",{className:"border-b border-white/5",children:[r.jsx("td",{className:"px-1 py-2",children:c+1}),r.jsx("td",{className:"px-1 py-2",children:n.waves}),r.jsx("td",{className:"px-1 py-2",children:n.leaks}),r.jsx("td",{className:"px-1 py-2",children:n.coinsEarned}),r.jsx("td",{className:"px-1 py-2",children:new Date(n.timestamp).toLocaleDateString()})]},`${n.timestamp}-${c}`))]})]}),r.jsx("button",{onClick:u,className:`mt-4 w-full rounded-md bg-blue-600 px-4 py-2 text-base font-semibold
            text-white transition hover:bg-blue-500`,children:"Play"})]}),r.jsxs("div",{className:`flex w-full max-w-sm flex-col gap-3 rounded-lg border border-white/10
        bg-slate-900/60 p-5 text-sm`,children:[r.jsx("h2",{className:"text-xl font-semibold",children:"How to Play"}),r.jsxs("ul",{className:"list-disc space-y-1 pl-5 opacity-80",children:[r.jsx("li",{children:"Click a glowing pad to spend 25 coins on a tower."}),r.jsx("li",{children:"Towers auto-target creeps closest to your base."}),r.jsx("li",{children:"Kills drop coins; leaks damage the base."}),r.jsx("li",{children:"Survive as long as you can — waves keep scaling."})]})]})]})]})};export{J as default};
