import{r as E,j as c,L as j}from"./index-C9f9U4S0.js";import{P as u}from"./phaser-B61OQUcB.js";import{O as T,a as p}from"./sprite-C-W06VFL.js";const W={obstacle:"X",road:"#",build:"_"};class I{map;constructor(e={height:8,width:12}){const s=this.normalizeConfig(e);this.map=this.generateMap(s.height,s.width,s.roadLength)}getMap(){return{cols:this.map.cols,rows:this.map.rows,tiles:this.map.tiles.map(e=>[...e]),path:this.map.path.map(e=>({...e}))}}normalizeConfig(e){const s=Math.max(3,Math.floor(e.height)),i=Math.max(3,Math.floor(e.width)),t=s*i,r=(s+i)*2,n=Math.floor(e.roadLength??r),a=Math.min(Math.max(2,n),t);return{height:s,width:i,roadLength:a}}generateMap(e,s,i){const t=Array.from({length:e},()=>Array.from({length:s},()=>"build"));this.applyObstacles(t);const r=this.generatePath(e,s,i);return r.forEach(({col:n,row:a})=>{t[a][n]="road"}),{cols:s,rows:e,tiles:t,path:r}}applyObstacles(e){const s=e.length,i=e[0]?.length??0;for(let t=0;t<s;t+=1)for(let r=0;r<i;r+=1){if(t===0||t===s-1||r===0||r===i-1){e[t][r]="obstacle";continue}Math.random()<.12&&(e[t][r]="obstacle")}}generatePath(e,s,i){const t=this.shuffle(this.collectEdgeCells(e,s));for(const r of t){const n=this.buildPath(r,e,s,i);if(n)return n}throw new Error("Failed to generate a valid path with the provided configuration.")}buildPath(e,s,i,t){const r=[e],n=new Set([this.cellKey(e.col,e.row)]);return t===1?this.isEdge(e,s,i)?r:void 0:this.extendPath(r,n,s,i,t)?r:void 0}extendPath(e,s,i,t,r){if(e.length===r){const o=e[e.length-1];return this.isEdge(o,i,t)}const n=e[e.length-1],a=this.shuffle(this.neighbors(n,i,t).filter(o=>!s.has(this.cellKey(o.col,o.row)))),l=r-e.length;for(const o of a){if(this.distanceToEdge(o,i,t)>l-1)continue;const d=l-1,f=this.isEdge(o,i,t);if(d>0&&f||d===0&&!f)continue;const m=this.cellKey(o.col,o.row);if(e.push(o),s.add(m),this.violatesSpacing(o,s,i,t)){s.delete(m),e.pop();continue}if(this.extendPath(e,s,i,t,r))return!0;s.delete(m),e.pop()}return!1}neighbors(e,s,i){const t=[{col:1,row:0},{col:-1,row:0},{col:0,row:1},{col:0,row:-1}],r=[];for(const n of t){const a=e.col+n.col,l=e.row+n.row;a>=0&&a<i&&l>=0&&l<s&&r.push({col:a,row:l})}return r}collectEdgeCells(e,s){const i=[];for(let t=0;t<s;t+=1)i.push({col:t,row:0});for(let t=1;t<e;t+=1)i.push({col:s-1,row:t});for(let t=s-2;t>=0;t-=1)e>1&&i.push({col:t,row:e-1});for(let t=e-2;t>0;t-=1)s>1&&i.push({col:0,row:t});return i}distanceToEdge(e,s,i){const t=Math.min(e.row,s-1-e.row),r=Math.min(e.col,i-1-e.col);return Math.min(t,r)}isEdge(e,s,i){return e.row===0||e.row===s-1||e.col===0||e.col===i-1}violatesSpacing(e,s,i,t){if(this.countRoadNeighbors(e,s,i,t)>4)return!0;const n=[{col:-1,row:-1},{col:0,row:-1},{col:1,row:-1},{col:-1,row:0},{col:1,row:0},{col:-1,row:1},{col:0,row:1},{col:1,row:1}];for(const a of n){const l=e.col+a.col,o=e.row+a.row;if(l<0||l>=t||o<0||o>=i)continue;const h=this.cellKey(l,o);if(s.has(h)&&this.countRoadNeighbors({col:l,row:o},s,i,t)>4)return!0}return!1}countRoadNeighbors(e,s,i,t){let r=0;for(let n=-1;n<=1;n+=1)for(let a=-1;a<=1;a+=1){if(n===0&&a===0)continue;const l=e.col+a,o=e.row+n;if(l<0||l>=t||o<0||o>=i)continue;const h=this.cellKey(l,o);s.has(h)&&(r+=1)}return r}cellKey(e,s){return`${e},${s}`}shuffle(e){for(let s=e.length-1;s>0;s-=1){const i=Math.floor(Math.random()*(s+1)),t=e[s];e[s]=e[i],e[i]=t}return e}}function L(g){const e=g.tiles.map(s=>s.map(i=>W[i]).join(""));console.log("Generated Tower Defense map:"),e.forEach(s=>console.log(s))}const Y=[p.portalOpens,p.empty,p.tree1],N=[p.tree1,p.tree2,p.tree3,p.tree4,p.tree5,p.tree6];class K{scene;map;tileSpriteLookup=new Map;pathIndexByCell=new Map;gridTileSize=0;gridOriginX=0;gridOriginY=0;constructor(e,s){this.scene=e,this.map=s,this.map.path.forEach((i,t)=>{this.pathIndexByCell.set(this.cellKey(i.col,i.row),t)})}render(){const{width:e,height:s}=this.scene.scale;if(this.updateMetrics(e,s),!this.scene.textures.exists(T.key))return;const i=this.gridTileSize*.98;for(let t=0;t<this.map.rows;t+=1)for(let r=0;r<this.map.cols;r+=1){const n=this.map.tiles[t][r],a=this.cellKey(r,t),l=this.gridToWorldCenter(r,t),o=this.appearanceForTile(r,t,n);let h=this.tileSpriteLookup.get(a);h?(h.setPosition(l.x,l.y).setDisplaySize(i,i).setFrame(o.frame).setAngle(o.angle),h.setTint(this.tintForTile(n))):(h=this.scene.add.sprite(l.x,l.y,T.key,o.frame).setOrigin(.5).setDisplaySize(i,i),h.setAngle(o.angle),h.setTint(this.tintForTile(n)),this.tileSpriteLookup.set(a,h))}}getTileSprite(e,s){return this.tileSpriteLookup.get(this.cellKey(e,s))}getTileSize(){return this.gridTileSize}gridToWorldCenter(e,s){const i=this.gridOriginX+e*this.gridTileSize+this.gridTileSize/2,t=this.gridOriginY+s*this.gridTileSize+this.gridTileSize/2;return new u.Math.Vector2(i,t)}applyBuildSpotAppearance(e,s,i,t){if(s){const n=this.gridTileSize*.6;e.setFrame(i??p.tower1).setDisplaySize(n,n).setDepth(7).setTint(t??15857145).setAngle(0);return}const r=this.gridTileSize*.98;e.setFrame(Y[1]).setDisplaySize(r,r).setDepth(0).setTint(6333946).setAngle(0)}updateMetrics(e,s){const i=e/this.map.cols,t=s/this.map.rows;this.gridTileSize=Math.min(i,t);const r=this.gridTileSize*this.map.cols,n=this.gridTileSize*this.map.rows;this.gridOriginX=(e-r)/2,this.gridOriginY=(s-n)/2}appearanceForTile(e,s,i){return i==="road"?this.roadAppearance(e,s):i==="obstacle"?{frame:N[u.Math.Between(0,N.length)],angle:0}:{frame:p.empty,angle:0}}roadAppearance(e,s){const i=this.cellKey(e,s),t=this.pathIndexByCell.get(i);if(t===void 0)return{frame:p.roadStraight,angle:0};const r=this.map.path,n=r[t],a=t>0?r[t-1]:void 0,l=t<r.length-1?r[t+1]:void 0,o=new Set;a&&o.add(this.oppositeDirection(this.directionBetween(a,n))),l&&o.add(this.directionBetween(n,l));const h=o.has("up"),d=o.has("down"),f=o.has("left"),m=o.has("right");return(h||d)&&(f||m)?{frame:p.roadTurn,angle:this.cornerAngle(h,d,f,m)}:f||m?{frame:p.roadStraight,angle:90}:{frame:p.roadStraight,angle:0}}cornerAngle(e,s,i,t){return s&&t?0:e&&t?-90:e&&i?180:s&&i?90:0}directionBetween(e,s){return s.col>e.col?"right":s.col<e.col?"left":s.row>e.row?"down":"up"}oppositeDirection(e){switch(e){case"up":return"down";case"down":return"up";case"left":return"right";case"right":default:return"left"}}tintForTile(e){return e==="road"?13421738:e==="build"?12636415:6320256}cellKey(e,s){return`${e},${s}`}}const X=15,G=75,w=25,y=170,x=650,S=10,U=30,$=6,V=90,q=6,J=6,Z=2,Q=6,ee=2,te=3e3,se=400,_=15,D=20,ie=(_+D)*2,re=[15857145,16436245,16347926],B=[{key:"regular",label:"Regular",shortcut:"1",spriteFrame:p.tower1,description:"Balanced single-target tower.",levels:[{cost:w,range:y,fireRate:x,damage:S},{cost:w+10,range:y+25,fireRate:Math.max(450,x-80),damage:Math.round(S*1.6)},{cost:w+25,range:y+50,fireRate:Math.max(360,x-160),damage:Math.round(S*2.4)}]},{key:"scatter",label:"Scatter",shortcut:"2",spriteFrame:p.sword1,description:"Short-range burst in 8 directions.",levels:[{cost:w+5,range:Math.round(y*.65),fireRate:x+150,damage:Math.round(S*.6),projectileCount:8},{cost:w+20,range:Math.round(y*.7),fireRate:x+60,damage:Math.round(S*.75),projectileCount:8},{cost:w+35,range:Math.round(y*.78),fireRate:Math.max(500,x-40),damage:Math.round(S*.95),projectileCount:8}]},{key:"bomber",label:"Bomber",shortcut:"3",spriteFrame:p.bomb,description:"Heavy projectile with splash damage.",levels:[{cost:w+10,range:y+30,fireRate:x+300,damage:Math.round(S*1.8),aoeRadius:70},{cost:w+25,range:y+60,fireRate:x+200,damage:Math.round(S*2.4),aoeRadius:90},{cost:w+45,range:y+80,fireRate:x+100,damage:Math.round(S*3),aoeRadius:110}]},{key:"freezer",label:"Freezer",shortcut:"4",spriteFrame:p.aura,levelTints:[3718648,959977,165063],description:"Slows enemies in range.",levels:[{cost:w+5,range:y-10,fireRate:x+120,damage:Math.round(S*.4),slowFactor:.65,slowDurationMs:2e3},{cost:w+18,range:y+10,fireRate:x+40,damage:Math.round(S*.55),slowFactor:.5,slowDurationMs:2600},{cost:w+32,range:y+25,fireRate:Math.max(480,x-40),damage:Math.round(S*.7),slowFactor:.4,slowDurationMs:3200}]}];class v{static BOMB_SPEED_PX_PER_MS=.45;static BOMB_EXPLOSION_DURATION_MS=350;deps;activeBombs=[];constructor(e){this.deps=e}update(e,s){const i=this.deps.getOverlay?.();i?.clear(),this.updateBombProjectiles(s,i);for(const t of e)t.cooldown=Math.max(0,t.cooldown-s),!(t.cooldown>0)&&this.performTowerAttack(t,i)&&(t.cooldown=t.stats.fireRate)}performTowerAttack(e,s){switch(e.definition.key){case"scatter":return this.fireScatterTower(e,s);case"bomber":return this.fireBomberTower(e,s);case"freezer":return this.fireFreezerTower(e,s);case"regular":default:return this.fireRegularTower(e,s)}}fireRegularTower(e,s){const i=this.findTargetForTower(e);return i?(s?.lineStyle(3,16436245,.6).beginPath().moveTo(e.sprite.x,e.sprite.y).lineTo(i.sprite.x,i.sprite.y).strokePath(),this.applyDamage(i,e.stats.damage),!0):!1}fireScatterTower(e,s){const i=e.sprite.x,t=e.sprite.y,r=Math.max(e.sprite.displayWidth,e.sprite.displayHeight,32),n=r*3;if(n<=0)return!1;const a=this.enemiesWithinCircle(i,t,n);if(a.length===0)return!1;const l=[0,Math.PI/4,Math.PI/2,3*Math.PI/4,Math.PI,-3*Math.PI/4,-Math.PI/2,-Math.PI/4],o=new Set;for(const h of l){const d=Math.cos(h),f=Math.sin(h);s?.lineStyle(2,16569165,.55).beginPath().moveTo(i,t).lineTo(i+d*n,t+f*n).strokePath();let m,b=1/0;for(const M of a){const P=M.sprite.x-i,O=M.sprite.y-t,k=P*d+O*f;if(k<=0||k>n)continue;const z=Math.abs(d*O-f*P),H=Math.max(M.sprite.displayWidth||0,M.sprite.displayHeight||0,r*.5,12),F=Math.max(6,H*.3);z>F||k<b&&(b=k,m=M)}m&&!o.has(m)&&o.add(m)}for(const h of o)this.applyDamage(h,e.stats.damage);return!0}fireBomberTower(e,s){const i=e.stats.aoeRadius;if(!i)return!1;const t=this.findTargetForTower(e);return t?(s?.lineStyle(2,16498468,.4).lineBetween(e.sprite.x,e.sprite.y,t.sprite.x,t.sprite.y),this.spawnBombProjectile(e,t,i),!0):!1}fireFreezerTower(e,s){const i=e.stats.slowFactor??1,t=e.stats.slowDurationMs??0,r=this.enemiesWithinCircle(e.sprite.x,e.sprite.y,e.stats.range);if(r.length===0)return!1;if(s?.lineStyle(2,3718648,.65).strokeCircle(e.sprite.x,e.sprite.y,e.stats.range),i<1&&t>0&&this.applySlow(r,i,t),e.stats.damage>0)for(const n of r)this.applyDamage(n,e.stats.damage);return!0}enemiesWithinCircle(e,s,i){const t=i*i;return this.deps.getEnemies().filter(r=>u.Math.Distance.Squared(e,s,r.sprite.x,r.sprite.y)<=t)}findTargetForTower(e){let s,i=-1/0;for(const t of this.deps.getEnemies())u.Math.Distance.Squared(e.sprite.x,e.sprite.y,t.sprite.x,t.sprite.y)>e.stats.range*e.stats.range||t.distance>i&&(s=t,i=t.distance);return s}applyDamage(e,s){s<=0||!this.deps.getEnemies().includes(e)||(e.hp-=s,e.hp<=0&&this.deps.onKill(e))}applySlow(e,s,i){const t=u.Math.Clamp(s,.1,1),r=this.deps.getCurrentTime();for(const n of e)this.deps.getEnemies().includes(n)&&(n.slowFactor=Math.min(n.slowFactor,t),n.slowUntil=Math.max(n.slowUntil,r+i),n.sprite.setTint(6333946))}spawnBombProjectile(e,s,i){const t=e.sprite.x,r=e.sprite.y,n=s.sprite.x,a=s.sprite.y,l=u.Math.Distance.Between(t,r,n,a),o=Math.max(180,l/v.BOMB_SPEED_PX_PER_MS);this.activeBombs.push({startX:t,startY:r,targetX:n,targetY:a,aoeRadius:i,damage:e.stats.damage,travelTime:o,elapsed:0,explosionDuration:v.BOMB_EXPLOSION_DURATION_MS,explosionElapsed:0,state:"flying"})}updateBombProjectiles(e,s){if(this.activeBombs.length===0)return;const i=[];for(const t of this.activeBombs){if(t.state==="flying"){t.elapsed+=e;const r=u.Math.Clamp(t.elapsed/t.travelTime,0,1),n=u.Math.Linear(t.startX,t.targetX,r),a=u.Math.Linear(t.startY,t.targetY,r);s?.fillStyle(16347926,.7).fillCircle(n,a,6),s?.lineStyle(2,7877903,.4).strokeCircle(n,a,8),r>=1&&(t.state="exploding",t.explosionElapsed=0,this.resolveBombExplosion(t))}if(t.state==="exploding"){t.explosionElapsed+=e;const r=u.Math.Clamp(1-t.explosionElapsed/t.explosionDuration,0,1);s?.fillStyle(16347926,.12*r).fillCircle(t.targetX,t.targetY,t.aoeRadius),s?.lineStyle(4,16347926,.7*r).strokeCircle(t.targetX,t.targetY,t.aoeRadius)}(t.state==="flying"||t.explosionElapsed<t.explosionDuration)&&i.push(t)}this.activeBombs=i}resolveBombExplosion(e){const s=this.enemiesWithinCircle(e.targetX,e.targetY,e.aoeRadius);for(const i of s)this.applyDamage(i,e.damage)}}class R extends u.Scene{static exitHandler;mapGenerator=new I({height:_,width:D,roadLength:ie});gameMap=this.mapGenerator.getMap();mapRenderer;buildSpots=[];towers=[];towerController;enemies=[];selectedTowerDefinition=B[0];path;pathLength=0;enemyOverlay;towerOverlay;timers=[];wave=0;leaks=0;baseHp=X;coins=G;coinsEarned=0;hudWave;hudHp;hudCoins;hudLeaks;hudTower;hudHint;exitButton;baseMarker;runEnded=!1;mapRotatedForVerticalMode=!1;static registerExitHandler(e){R.exitHandler=e}preload(){this.load.setPath(""),this.textures.exists(T.key)||this.load.spritesheet(T.key,T.url,{frameWidth:T.frameWidth,frameHeight:T.frameHeight,spacing:T.spacing})}create(){this.rotateMapForVerticalStartIfNeeded(),L(this.gameMap),this.cameras.main.setBackgroundColor("#0b0f19"),this.ensureEnemyWalkAnimation(),this.enemyOverlay=this.add.graphics().setDepth(5),this.towerOverlay=this.add.graphics().setDepth(4),this.towerController=new v({getEnemies:()=>this.enemies,getOverlay:()=>this.towerOverlay,getCurrentTime:()=>this.time.now,onKill:e=>this.handleKill(e)}),this.mapRenderer=new K(this,this.gameMap),this.mapRenderer.render(),this.createPath(),this.createBaseMarker(),this.createBuildSpots(),this.createHud(),this.configureInput(),this.scale.on("resize",this.handleResize,this),this.time.delayedCall(600,()=>this.startNextWave())}update(e,s){if(this.runEnded)return;const i=s/1e3;this.updateEnemies(i),this.updateTowers(s),this.renderOverlays()}createPath(){const e=this.gameMap.path;if(e.length===0||!this.mapRenderer)return;const s=this.mapRenderer.gridToWorldCenter(e[0].col,e[0].row);this.path=new u.Curves.Path(s.x,s.y);for(let i=1;i<e.length;i+=1){const t=this.mapRenderer.gridToWorldCenter(e[i].col,e[i].row);this.path.lineTo(t.x,t.y)}this.pathLength=this.path.getLength()}createBaseMarker(){this.baseMarker?.destroy();const e=this.gameMap.path;if(e.length===0||!this.mapRenderer)return;const s=e[e.length-1],i=this.mapRenderer.gridToWorldCenter(s.col,s.row),r=this.mapRenderer.getTileSize()*.9;this.baseMarker=this.add.rectangle(i.x,i.y,r,r,1319471).setStrokeStyle(2,3854591,.6).setDepth(2)}createBuildSpots(){if(!this.mapRenderer)return;this.buildSpots=[];let e=0;for(let s=0;s<this.gameMap.rows;s+=1)for(let i=0;i<this.gameMap.cols;i+=1){if(this.gameMap.tiles[s][i]!=="build")continue;const t=this.mapRenderer.getTileSprite(i,s);if(!t)continue;const r={id:e,col:i,row:s,occupied:!1,marker:t};this.buildSpots.push(r),this.applyBuildSpotAppearance(r),e+=1}}createHud(){this.hudWave?.destroy(),this.hudHp?.destroy(),this.hudCoins?.destroy(),this.hudLeaks?.destroy(),this.hudTower?.destroy(),this.hudHint?.destroy(),this.exitButton?.destroy(),this.hudWave=this.add.text(16,16,"",this.hudStyle()),this.hudHp=this.add.text(16,44,"",this.hudStyle()),this.hudCoins=this.add.text(16,72,"",this.hudStyle()),this.hudLeaks=this.add.text(16,100,"",this.hudStyle()),this.hudTower=this.add.text(16,128,"",{...this.hudStyle(),fontSize:"16px",color:"#7dd3fc"}),this.hudHint=this.add.text(16,154,this.selectedTowerDefinition.description,{...this.hudStyle(),fontSize:"14px",color:"#94a3b8"}),this.exitButton=this.add.text(this.scale.width-20,16,"Exit",{...this.hudStyle(),color:"#f87171"}).setOrigin(1,0).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this.endRun()),this.add.text(this.scale.width/2,this.scale.height-24,"Press 1-4 to swap. Click tower to upgrade.",{...this.hudStyle(),fontSize:"14px",color:"#9ca3af"}).setOrigin(.5,1),this.refreshHud()}configureInput(){const e=this.input.keyboard;e?.on("keydown-ESC",()=>this.endRun()),e?.on("keydown-ONE",()=>this.selectTowerByShortcut("1")),e?.on("keydown-TWO",()=>this.selectTowerByShortcut("2")),e?.on("keydown-THREE",()=>this.selectTowerByShortcut("3")),e?.on("keydown-FOUR",()=>this.selectTowerByShortcut("4")),e?.on("keydown-NUMPAD_ONE",()=>this.selectTowerByShortcut("1")),e?.on("keydown-NUMPAD_TWO",()=>this.selectTowerByShortcut("2")),e?.on("keydown-NUMPAD_THREE",()=>this.selectTowerByShortcut("3")),e?.on("keydown-NUMPAD_FOUR",()=>this.selectTowerByShortcut("4")),this.input.on("pointerdown",s=>{if(this.runEnded)return;const i=this.buildSpots.find(r=>r.marker.getBounds().contains(s.worldX,s.worldY));if(!i)return;if(i.occupied){this.tryUpgradeTower(i,s.worldX,s.worldY);return}const t=this.selectedTowerDefinition.levels[0].cost;if(this.coins<t){this.showFloatingText(s.worldX,s.worldY,"Not enough coins");return}this.placeTower(i)})}selectTowerByShortcut(e){const s=B.find(i=>i.shortcut===e);!s||s===this.selectedTowerDefinition||(this.selectedTowerDefinition=s,this.refreshHud())}tryUpgradeTower(e,s,i){const t=this.towers.find(o=>o.spotId===e.id);if(!t)return;const r=t.level+1;if(r>=t.definition.levels.length){this.showFloatingText(s,i,"Max level");return}const n=t.definition.levels[r].cost;if(this.coins<n){this.showFloatingText(s,i,`Need ${n} coins`);return}this.coins-=n,t.level=r,t.stats={...t.definition.levels[r]},t.cooldown=0,this.applyBuildSpotAppearance(e),this.refreshHud();const a=this.mapRenderer?this.mapRenderer.getTileSize():0,l=Math.max(24,a*.5);this.showFloatingText(t.sprite.x,t.sprite.y-l,`Lvl ${t.level+1}`,"#facc15")}startNextWave(){if(this.runEnded)return;this.wave+=1,this.refreshHud();const e=Q+Math.max(0,this.wave-1)*ee,s=Math.max(se,900-this.wave*40),i=this.time.addEvent({delay:s,repeat:e-1,callback:()=>{this.spawnEnemy()}});this.timers.push(i),this.spawnEnemy();const t=s*Math.max(e-1,0),r=this.time.delayedCall(t+te,()=>{this.timers=this.timers.filter(n=>n!==r),!this.runEnded&&this.startNextWave()});this.timers.push(r)}spawnEnemy(){const e=U+(this.wave-1)*$,s=V+(this.wave-1)*q,i=J+(this.wave-1)*Z,t=new u.Math.Vector2;this.path.getPoint(0,t);const n=(this.mapRenderer?this.mapRenderer.getTileSize():64)*.7,a=14441586,l=this.add.sprite(t.x,t.y,T.key,p.mobWalk1).setOrigin(.5).setDisplaySize(n,n).setTint(a).setDepth(6);this.anims.exists("enemy-walk")&&(l.play("enemy-walk"),l.anims.setProgress(Math.random())),this.enemies.push({sprite:l,distance:0,baseSpeed:s,slowFactor:1,slowUntil:0,hp:e,maxHp:e,reward:i,leakDamage:1,baseTint:a})}placeTower(e){if(!this.mapRenderer)return;const s=e.marker,i=this.selectedTowerDefinition,t={...i.levels[0]},r={spotId:e.id,sprite:s,definition:i,level:0,cooldown:0,stats:t};this.towers.push(r),this.coins-=t.cost,this.applyBuildSpotAppearance(e),this.refreshHud();const n=this.mapRenderer.getTileSize(),a=Math.max(24,n*.5);this.showFloatingText(s.x,s.y-a,`${i.label} ready`)}updateEnemies(e){const s=new u.Math.Vector2,i=[],t=this.time.now;for(const r of this.enemies){r.slowUntil<=t&&r.slowFactor<1&&(r.slowFactor=1,r.sprite.setTint(r.baseTint));const n=r.baseSpeed*r.slowFactor;r.distance+=n*e;const a=r.distance/this.pathLength;if(a>=1){this.handleLeak(r),r.sprite.destroy();continue}this.path.getPoint(a,s),r.sprite.setPosition(s.x,s.y),i.push(r)}this.enemies=i}updateTowers(e){this.towerController?.update(this.towers,e)}renderOverlays(){if(!this.enemyOverlay||!this.mapRenderer)return;this.enemyOverlay.clear(),this.enemyOverlay.fillStyle(2042167,.8);const e=this.mapRenderer.getTileSize(),s=Math.max(24,e*.7),i=Math.max(4,e*.12);for(const t of this.enemies){const r=u.Math.Clamp(t.hp/t.maxHp,0,1),n=t.sprite.displayHeight/2+Math.max(6,e*.15);this.enemyOverlay.fillRect(t.sprite.x-s/2,t.sprite.y-n,s,i),this.enemyOverlay.fillStyle(16347926,.9),this.enemyOverlay.fillRect(t.sprite.x-s/2+1,t.sprite.y-n+1,(s-2)*r,i-2),this.enemyOverlay.fillStyle(2042167,.8)}}handleLeak(e){this.baseHp=Math.max(0,this.baseHp-e.leakDamage),this.leaks+=1,this.refreshHud(),this.showFloatingText(this.baseMarker.x,this.baseMarker.y,"Leak!","#f87171"),this.baseHp<=0&&this.endRun()}handleKill(e){const{x:s,y:i}=e.sprite;e.sprite.destroy(),this.enemies=this.enemies.filter(n=>n!==e),this.coins+=e.reward,this.coinsEarned+=e.reward,this.refreshHud();const t=this.mapRenderer.getTileSize(),r=Math.max(18,t*.45);this.showFloatingText(s,i-r,`+${e.reward}`,"#34d399")}refreshHud(){if(this.hudWave.setText(`Wave ${this.wave}`),this.hudHp.setText(`Base HP: ${this.baseHp}`),this.hudCoins.setText(`Coins: ${this.coins}`),this.hudLeaks.setText(`Leaks: ${this.leaks}`),this.hudTower){const e=this.selectedTowerDefinition.levels[0];this.hudTower.setText(`Building: ${this.selectedTowerDefinition.label} [${this.selectedTowerDefinition.shortcut}] - ${e.cost}c`)}this.hudHint?.setText(this.selectedTowerDefinition.description),this.baseMarker&&this.baseMarker.setFillStyle(this.baseHp>5?1319471:4136235,1)}handleResize(e){const{width:s,height:i}=e;if(!s||!i||!this.mapRenderer)return;const t=this.pathLength;this.mapRenderer.render();const r=this.mapRenderer.getTileSize();this.createPath(),this.createBaseMarker(),this.buildSpots.forEach(l=>{const o=this.mapRenderer.gridToWorldCenter(l.col,l.row),h=this.towers.find(d=>d.spotId===l.id);if(h){const d=r*.6;h.sprite.setPosition(o.x,o.y).setDisplaySize(d,d)}this.applyBuildSpotAppearance(l)});const n=r*.7,a=new u.Math.Vector2;for(const l of this.enemies){const o=t>0?l.distance/t:0;l.distance=o*this.pathLength,this.path.getPoint(o,a),l.sprite.setPosition(a.x,a.y).setDisplaySize(n,n)}this.exitButton?.setPosition(s-20,16)}endRun(){if(this.runEnded)return;this.runEnded=!0,this.timers.forEach(s=>s.remove()),this.timers=[],this.time.removeAllEvents();const e={waves:this.wave,leaks:this.leaks,coinsEarned:this.coinsEarned};R.exitHandler?.(e),this.scene.stop()}showFloatingText(e,s,i,t="#fbbf24"){const r=this.mapRenderer?this.mapRenderer.getTileSize():0,n=Math.max(28,r*.5),a=this.add.text(e,s,i,{...this.hudStyle(),fontSize:"14px",color:t}).setOrigin(.5,1).setDepth(10);this.tweens.add({targets:a,y:s-n,alpha:0,duration:900,ease:"Sine.easeOut",onComplete:()=>a.destroy()})}hudStyle(){return{fontFamily:"monospace",fontSize:"18px",color:"#f8fafc"}}applyBuildSpotAppearance(e){if(!this.mapRenderer)return;const s=this.towers.find(n=>n.spotId===e.id),i=!!s;if(e.occupied=i,!i||!s){this.mapRenderer.applyBuildSpotAppearance(e.marker,!1);return}const t=s.definition.levelTints??re,r=t[Math.min(s.level,t.length-1)];this.mapRenderer.applyBuildSpotAppearance(e.marker,!0,s.definition.spriteFrame,r)}rotateMapForVerticalStartIfNeeded(){this.mapRotatedForVerticalMode||!(this.scale.orientation===u.Scale.Orientation.PORTRAIT||this.scale.height>this.scale.width)||(this.rotateGameMapClockwise(),this.mapRotatedForVerticalMode=!0)}rotateGameMapClockwise(){const e=this.gameMap.rows,s=this.gameMap.cols,i=Array.from({length:s},()=>new Array(e));for(let t=0;t<e;t+=1)for(let r=0;r<s;r+=1){const n=r,a=e-1-t;i[n][a]=this.gameMap.tiles[t][r]}this.gameMap.tiles=i,this.gameMap.rows=s,this.gameMap.cols=e,this.gameMap.path=this.gameMap.path.map(({col:t,row:r})=>({col:e-1-r,row:t}))}ensureEnemyWalkAnimation(){if(!this.textures.exists(T.key)||this.anims.exists("enemy-walk"))return;const e=[p.mobWalk1,p.mobWalk2].map(s=>({key:T.key,frame:s}));this.anims.create({key:"enemy-walk",frames:e,frameRate:6,repeat:-1})}}const ne={type:u.AUTO,width:960,height:640,backgroundColor:"#0b0f19",scene:R,fps:{target:60},scale:{mode:u.Scale.RESIZE,autoCenter:u.Scale.CENTER_BOTH}},C="towerDefenseHighScores",A=5,ae=()=>{if(typeof window>"u")return[];try{const g=window.localStorage.getItem(C);if(!g)return[];const e=JSON.parse(g);return Array.isArray(e)?e.sort((s,i)=>i.waves!==s.waves?i.waves-s.waves:s.leaks!==i.leaks?s.leaks-i.leaks:i.coinsEarned-s.coinsEarned).slice(0,A):[]}catch(g){return console.warn("Failed to read tower defence high scores",g),[]}},oe=g=>{try{window.localStorage.setItem(C,JSON.stringify(g))}catch(e){console.warn("Failed to store tower defence high scores",e)}},le=(g,e)=>{const s=[...g,{...e,timestamp:Date.now()}];return s.sort((i,t)=>t.waves!==i.waves?t.waves-i.waves:i.leaks!==t.leaks?i.leaks-t.leaks:t.coinsEarned-i.coinsEarned),s.slice(0,A)},pe=()=>{const g=E.useRef(null),e=E.useRef(null),[s,i]=E.useState(!1),[t,r]=E.useState(null),[n,a]=E.useState([]);E.useEffect(()=>{a(ae())},[]);const l=E.useCallback(h=>{r(h),i(!1),a(d=>{const f=le(d,h);return oe(f),f})},[]);E.useEffect(()=>{if(!s){R.registerExitHandler(void 0),e.current&&(e.current.destroy(!0),e.current=null);return}const h=g.current;if(!h)return;R.registerExitHandler(l);const d=new u.Game({parent:h,...ne});e.current=d;const f=()=>{const b=h.clientWidth,M=h.clientHeight;b&&M&&d.scale.resize(b,M)};f();let m;return typeof ResizeObserver<"u"&&(m=new ResizeObserver(f),m.observe(h)),()=>{R.registerExitHandler(void 0),m?.disconnect(),d.destroy(!0),e.current=null}},[l,s]);const o=E.useCallback(()=>{r(null),i(!0)},[]);return s?c.jsx("div",{className:"h-screen w-screen overflow-hidden bg-[#0b0f19] text-slate-100",children:c.jsx("div",{ref:g,className:"h-full w-full"})}):c.jsxs(c.Fragment,{children:[c.jsxs("div",{className:"flex min-h-screen flex-col items-center justify-start bg-slate-950 px-6 py-6 pb-28 text-slate-100",children:[c.jsx("h1",{className:"mb-4 text-3xl font-semibold",children:"Tower Defence"}),c.jsxs("div",{className:"flex w-full max-w-[1100px] flex-col gap-6 lg:flex-row",children:[c.jsxs("div",{className:"flex-1 rounded-lg border border-white/10 bg-slate-900/60 p-5",children:[c.jsx("h2",{className:"mb-3 text-xl font-semibold",children:"High Scores"}),n.length===0?c.jsx("p",{className:"text-sm opacity-70",children:"No waves cleared yet. Place some towers!"}):c.jsxs("table",{className:"w-full border-collapse text-sm",children:[c.jsx("thead",{children:c.jsxs("tr",{className:"border-b border-white/5 text-left",children:[c.jsx("th",{className:"px-1 py-1",children:"#"}),c.jsx("th",{className:"px-1 py-1",children:"Waves"}),c.jsx("th",{className:"px-1 py-1",children:"Leaks"}),c.jsx("th",{className:"px-1 py-1",children:"Coins"}),c.jsx("th",{className:"px-1 py-1",children:"Date"})]})}),c.jsxs("tbody",{children:[t&&c.jsxs("tr",{children:[c.jsx("td",{className:"px-1 py-1",children:"Last"}),c.jsx("td",{className:"px-1 py-1",children:t.waves}),c.jsx("td",{className:"px-1 py-1",children:t.leaks}),c.jsx("td",{className:"px-1 py-1",children:t.coinsEarned}),c.jsx("td",{className:"px-1 py-1",children:"—"})]}),n.map((h,d)=>c.jsxs("tr",{className:"border-b border-white/5",children:[c.jsx("td",{className:"px-1 py-2",children:d+1}),c.jsx("td",{className:"px-1 py-2",children:h.waves}),c.jsx("td",{className:"px-1 py-2",children:h.leaks}),c.jsx("td",{className:"px-1 py-2",children:h.coinsEarned}),c.jsx("td",{className:"px-1 py-2",children:new Date(h.timestamp).toLocaleDateString()})]},`${h.timestamp}-${d}`))]})]})]}),c.jsxs("div",{className:`flex w-full max-w-sm flex-col gap-3 rounded-lg border border-white/10
        bg-slate-900/60 p-5 text-sm`,children:[c.jsx("h2",{className:"text-xl font-semibold",children:"How to Play"}),c.jsxs("ul",{className:"list-disc space-y-1 pl-5 opacity-80",children:[c.jsx("li",{children:"Click a glowing pad to spend 25 coins on a tower."}),c.jsx("li",{children:"Towers auto-target creeps closest to your base."}),c.jsx("li",{children:"Kills drop coins; leaks damage the base."}),c.jsx("li",{children:"Survive as long as you can — waves keep scaling."})]})]})]}),c.jsx(j,{to:"/",className:`mt-6 inline-flex items-center justify-center rounded-md border border-slate-600
          bg-slate-800 px-4 py-2 text-sm font-medium text-slate-100 transition hover:bg-slate-700`,children:"Back to main page"})]}),c.jsx("button",{onClick:o,className:`fixed bottom-6 left-1/2 z-50 w-[calc(100%-3rem)] max-w-md -translate-x-1/2 transform rounded-md
        bg-blue-600 px-4 py-3 text-base font-semibold text-white shadow-lg transition hover:bg-blue-500`,children:"Play"})]})};export{pe as default};
