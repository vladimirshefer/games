import{r as d,j as r}from"./index-C5j_s9O7.js";import{P as o}from"./phaser-B61OQUcB.js";const k=15,N=75,E=25,P=170,H=650,T=10,j=30,R=6,O=90,_=6,M=6,W=2,A=6,C=2,D=400,f=[{x:.08,y:.78},{x:.32,y:.78},{x:.32,y:.28},{x:.64,y:.28},{x:.64,y:.62},{x:.9,y:.62}],I=[{x:.18,y:.48},{x:.24,y:.18},{x:.44,y:.52},{x:.52,y:.16},{x:.74,y:.44},{x:.78,y:.86}];class p extends o.Scene{static exitHandler;buildSpots=[];towers=[];enemies=[];path;pathLength=0;pathGraphics;enemyOverlay;towerOverlay;timers=[];wave=0;leaks=0;baseHp=k;coins=N;coinsEarned=0;hudWave;hudHp;hudCoins;hudLeaks;exitButton;baseMarker;runEnded=!1;static registerExitHandler(e){p.exitHandler=e}preload(){this.load.setPath("")}create(){this.cameras.main.setBackgroundColor("#0b0f19"),this.enemyOverlay=this.add.graphics().setDepth(5),this.towerOverlay=this.add.graphics().setDepth(4),this.createPath(),this.createBaseMarker(),this.createBuildSpots(),this.createHud(),this.configureInput(),this.scale.on("resize",this.handleResize,this),this.time.delayedCall(600,()=>this.startNextWave())}update(e,t){if(this.runEnded)return;const s=t/1e3;this.updateEnemies(s),this.updateTowers(t),this.renderOverlays()}createPath(){this.pathGraphics?.destroy();const{width:e,height:t}=this.scale,s=this.toWorldPoint(f[0],e,t);this.path=new o.Curves.Path(s.x,s.y);for(let i=1;i<f.length;i+=1){const a=this.toWorldPoint(f[i],e,t);this.path.lineTo(a.x,a.y)}this.pathLength=this.path.getLength(),this.pathGraphics=this.add.graphics({lineStyle:{color:2371654,width:12}}),this.path.draw(this.pathGraphics,64),this.pathGraphics.setDepth(1)}createBaseMarker(){this.baseMarker?.destroy();const e=new o.Math.Vector2;this.path.getPoint(1,e),this.baseMarker=this.add.rectangle(e.x,e.y,48,48,1319471).setStrokeStyle(2,3854591,.6).setDepth(2)}createBuildSpots(){this.buildSpots.forEach(e=>e.marker.destroy()),this.buildSpots=[],I.forEach((e,t)=>{const{width:s,height:i}=this.scale,a=this.toWorldPoint(e,s,i),l=this.add.arc(a.x,a.y,22,0,360,!1,1977408,.45).setStrokeStyle(2,5231871,.55).setDepth(3);this.buildSpots.push({id:t,rx:e.x,ry:e.y,occupied:!1,marker:l})})}createHud(){this.hudWave?.destroy(),this.hudHp?.destroy(),this.hudCoins?.destroy(),this.hudLeaks?.destroy(),this.exitButton?.destroy(),this.hudWave=this.add.text(16,16,"",this.hudStyle()),this.hudHp=this.add.text(16,44,"",this.hudStyle()),this.hudCoins=this.add.text(16,72,"",this.hudStyle()),this.hudLeaks=this.add.text(16,100,"",this.hudStyle()),this.exitButton=this.add.text(this.scale.width-20,16,"Exit",{...this.hudStyle(),color:"#f87171"}).setOrigin(1,0).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this.endRun()),this.add.text(this.scale.width/2,this.scale.height-24,"Click glowing pads to build towers. Towers fire automatically.",{...this.hudStyle(),fontSize:"14px",color:"#9ca3af"}).setOrigin(.5,1),this.refreshHud()}configureInput(){this.input.keyboard?.on("keydown-ESC",()=>this.endRun()),this.input.on("pointerdown",e=>{if(this.runEnded)return;const t=this.buildSpots.find(s=>!s.occupied&&o.Math.Distance.Squared(e.worldX,e.worldY,s.marker.x,s.marker.y)<1156);if(t){if(this.coins<E){this.showFloatingText(e.worldX,e.worldY,"Not enough coins");return}this.placeTower(t)}})}startNextWave(){if(this.runEnded)return;this.wave+=1,this.refreshHud();const e=A+Math.max(0,this.wave-1)*C,t=Math.max(D,900-this.wave*40),s=this.time.addEvent({delay:t,repeat:e-1,callback:()=>{this.spawnEnemy()}});this.timers.push(s),this.spawnEnemy()}spawnEnemy(){const e=j+(this.wave-1)*R,t=O+(this.wave-1)*_,s=M+(this.wave-1)*W,i=new o.Math.Vector2;this.path.getPoint(0,i);const a=this.add.arc(i.x,i.y,14,0,360,!1,14441586,.95).setDepth(6);this.enemies.push({sprite:a,distance:0,speed:t,hp:e,maxHp:e,reward:s,leakDamage:1})}placeTower(e){const t=this.add.rectangle(e.marker.x,e.marker.y,24,24,5231871,.9).setStrokeStyle(2,16777215,.7).setDepth(7);this.towers.push({spotId:e.id,sprite:t,range:P,fireRate:H,cooldown:0,damage:T}),e.occupied=!0,e.marker.setStrokeStyle(2,3900150,.45).setFillStyle(1920728,.35),this.coins-=E,this.refreshHud(),this.showFloatingText(t.x,t.y-26,"Tower ready")}updateEnemies(e){const t=new o.Math.Vector2,s=[];for(const i of this.enemies){i.distance+=i.speed*e;const a=i.distance/this.pathLength;if(a>=1){this.handleLeak(i),i.sprite.destroy();continue}this.path.getPoint(a,t),i.sprite.setPosition(t.x,t.y),s.push(i)}this.enemies=s}updateTowers(e){const t=e;this.towerOverlay?.clear();for(const s of this.towers){s.cooldown=Math.max(0,s.cooldown-t);const i=this.findTargetForTower(s);!i||s.cooldown>0||(s.cooldown=s.fireRate,i.hp-=s.damage,this.towerOverlay?.lineStyle(3,16436245,.6).beginPath().moveTo(s.sprite.x,s.sprite.y).lineTo(i.sprite.x,i.sprite.y).strokePath(),i.hp<=0&&this.handleKill(i))}}renderOverlays(){if(!this.enemyOverlay)return;this.enemyOverlay.clear(),this.enemyOverlay.fillStyle(2042167,.8);const e=28,t=4;for(const s of this.enemies){const i=o.Math.Clamp(s.hp/s.maxHp,0,1);this.enemyOverlay.fillRect(s.sprite.x-e/2,s.sprite.y-22,e,t),this.enemyOverlay.fillStyle(16347926,.9),this.enemyOverlay.fillRect(s.sprite.x-e/2+1,s.sprite.y-22+1,(e-2)*i,t-2),this.enemyOverlay.fillStyle(2042167,.8)}}findTargetForTower(e){let t,s=-1/0;for(const i of this.enemies){if(o.Math.Distance.Squared(e.sprite.x,e.sprite.y,i.sprite.x,i.sprite.y)>e.range*e.range)continue;const l=i.distance;l>s&&(t=i,s=l)}return t}handleLeak(e){this.baseHp=Math.max(0,this.baseHp-e.leakDamage),this.leaks+=1,this.refreshHud(),this.showFloatingText(this.baseMarker.x,this.baseMarker.y,"Leak!","#f87171"),this.baseHp<=0&&this.endRun()}handleKill(e){const{x:t,y:s}=e.sprite;e.sprite.destroy(),this.enemies=this.enemies.filter(i=>i!==e),this.coins+=e.reward,this.coinsEarned+=e.reward,this.refreshHud(),this.showFloatingText(t,s-18,`+${e.reward}`,"#34d399")}refreshHud(){this.hudWave.setText(`Wave ${this.wave}`),this.hudHp.setText(`Base HP: ${this.baseHp}`),this.hudCoins.setText(`Coins: ${this.coins}`),this.hudLeaks.setText(`Leaks: ${this.leaks}`),this.baseMarker&&this.baseMarker.setFillStyle(this.baseHp>5?1319471:4136235,1)}handleResize(e){const{width:t,height:s}=e;!t||!s||(this.pathGraphics?.destroy(),this.createPath(),this.createBaseMarker(),this.buildSpots.forEach(i=>{const a=this.toWorldPoint({x:i.rx,y:i.ry},t,s);i.marker.setPosition(a.x,a.y);const l=this.towers.find(x=>x.spotId===i.id);l&&l.sprite.setPosition(a.x,a.y)}),this.exitButton.setPosition(t-20,16))}endRun(){if(this.runEnded)return;this.runEnded=!0,this.timers.forEach(t=>t.remove()),this.timers=[],this.time.removeAllEvents();const e={waves:this.wave,leaks:this.leaks,coinsEarned:this.coinsEarned};p.exitHandler?.(e),this.scene.stop()}showFloatingText(e,t,s,i="#fbbf24"){const a=this.add.text(e,t,s,{...this.hudStyle(),fontSize:"14px",color:i}).setOrigin(.5,1).setDepth(10);this.tweens.add({targets:a,y:t-28,alpha:0,duration:900,ease:"Sine.easeOut",onComplete:()=>a.destroy()})}hudStyle(){return{fontFamily:"monospace",fontSize:"18px",color:"#f8fafc"}}toWorldPoint(e,t,s){return new o.Math.Vector2(e.x*t,e.y*s)}}const L={type:o.AUTO,width:960,height:640,backgroundColor:"#0b0f19",scene:p,fps:{target:60},scale:{mode:o.Scale.RESIZE,autoCenter:o.Scale.CENTER_BOTH}},S="towerDefenseHighScores",v=5,B=()=>{if(typeof window>"u")return[];try{const h=window.localStorage.getItem(S);if(!h)return[];const e=JSON.parse(h);return Array.isArray(e)?e.filter(t=>typeof t?.waves=="number"&&typeof t?.leaks=="number"&&typeof t?.coinsEarned=="number"&&typeof t?.timestamp=="number").sort((t,s)=>s.waves!==t.waves?s.waves-t.waves:t.leaks!==s.leaks?t.leaks-s.leaks:s.coinsEarned-t.coinsEarned).slice(0,v):[]}catch(h){return console.warn("Failed to read tower defence high scores",h),[]}},G=h=>{if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(S,JSON.stringify(h))}catch(e){console.warn("Failed to store tower defence high scores",e)}},F=(h,e)=>{const t=[...h,{...e,timestamp:Date.now()}];return t.sort((s,i)=>i.waves!==s.waves?i.waves-s.waves:s.leaks!==i.leaks?s.leaks-i.leaks:i.coinsEarned-s.coinsEarned),t.slice(0,v)},V=()=>{const h=d.useRef(null),e=d.useRef(null),[t,s]=d.useState(!1),[i,a]=d.useState(null),[l,x]=d.useState([]);d.useEffect(()=>{x(B())},[]);const m=d.useCallback(n=>{a(n),s(!1),x(c=>{const u=F(c,n);return G(u),u})},[]);d.useEffect(()=>{if(!t){p.registerExitHandler(void 0),e.current&&(e.current.destroy(!0),e.current=null);return}const n=h.current;if(!n)return;p.registerExitHandler(m);const c=new o.Game({parent:n,...L});e.current=c;const u=()=>{const w=n.clientWidth,g=n.clientHeight;w&&g&&c.scale.resize(w,g)};u();let y;return typeof ResizeObserver<"u"&&(y=new ResizeObserver(u),y.observe(n)),()=>{p.registerExitHandler(void 0),y?.disconnect(),c.destroy(!0),e.current=null}},[m,t]);const b=d.useCallback(()=>{a(null),s(!0)},[]);return t?r.jsx("div",{className:"h-screen w-screen overflow-hidden bg-[#0b0f19] text-slate-100",children:r.jsx("div",{ref:h,className:"h-full w-full"})}):r.jsxs("div",{className:"flex min-h-screen flex-col items-center justify-start bg-slate-950 px-6 py-6 text-slate-100",children:[r.jsx("h1",{className:"mb-4 text-3xl font-semibold",children:"Tower Defence"}),r.jsxs("div",{className:"flex w-full max-w-[1100px] flex-col gap-6 lg:flex-row",children:[r.jsxs("div",{className:"flex-1 rounded-lg border border-white/10 bg-slate-900/60 p-5",children:[r.jsx("h2",{className:"mb-3 text-xl font-semibold",children:"High Scores"}),l.length===0?r.jsx("p",{className:"text-sm opacity-70",children:"No waves cleared yet. Place some towers!"}):r.jsxs("table",{className:"w-full border-collapse text-sm",children:[r.jsx("thead",{children:r.jsxs("tr",{className:"border-b border-white/5 text-left",children:[r.jsx("th",{className:"px-1 py-1",children:"#"}),r.jsx("th",{className:"px-1 py-1",children:"Waves"}),r.jsx("th",{className:"px-1 py-1",children:"Leaks"}),r.jsx("th",{className:"px-1 py-1",children:"Coins"}),r.jsx("th",{className:"px-1 py-1",children:"Date"})]})}),r.jsxs("tbody",{children:[i&&r.jsxs("tr",{children:[r.jsx("td",{className:"px-1 py-1",children:"Last"}),r.jsx("td",{className:"px-1 py-1",children:i.waves}),r.jsx("td",{className:"px-1 py-1",children:i.leaks}),r.jsx("td",{className:"px-1 py-1",children:i.coinsEarned}),r.jsx("td",{className:"px-1 py-1",children:"—"})]}),l.map((n,c)=>r.jsxs("tr",{className:"border-b border-white/5",children:[r.jsx("td",{className:"px-1 py-2",children:c+1}),r.jsx("td",{className:"px-1 py-2",children:n.waves}),r.jsx("td",{className:"px-1 py-2",children:n.leaks}),r.jsx("td",{className:"px-1 py-2",children:n.coinsEarned}),r.jsx("td",{className:"px-1 py-2",children:new Date(n.timestamp).toLocaleDateString()})]},`${n.timestamp}-${c}`))]})]}),r.jsx("button",{onClick:b,className:`mt-4 w-full rounded-md bg-blue-600 px-4 py-2 text-base font-semibold
            text-white transition hover:bg-blue-500`,children:"Play"})]}),r.jsxs("div",{className:`flex w-full max-w-sm flex-col gap-3 rounded-lg border border-white/10
        bg-slate-900/60 p-5 text-sm`,children:[r.jsx("h2",{className:"text-xl font-semibold",children:"How to Play"}),r.jsxs("ul",{className:"list-disc space-y-1 pl-5 opacity-80",children:[r.jsx("li",{children:"Click a glowing pad to spend 25 coins on a tower."}),r.jsx("li",{children:"Towers auto-target creeps closest to your base."}),r.jsx("li",{children:"Kills drop coins; leaks damage the base."}),r.jsx("li",{children:"Survive as long as you can — waves keep scaling."})]})]})]})]})};export{V as default};
